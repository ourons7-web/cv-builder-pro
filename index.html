<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<meta name="theme-color" content="#0F766E"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="CV Builder Pro"/>
<meta name="description" content="Build professional CVs ‚Äî works offline, no internet needed"/>
<title>CV Builder ‚Äî Free</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&family=Montserrat:wght@400;600;700&family=Raleway:wght@400;600;700&family=EB+Garamond:wght@400;500;600&family=Josefin+Sans:wght@300;400;600;700&family=Nunito+Sans:wght@400;600;700&family=Cormorant+Garamond:wght@400;600;700&display=swap" rel="stylesheet"/>
<!-- jsPDF + html2canvas for watermark PDF download -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- QR Code generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --primary:#0F766E;--primary-dark:#0D6B63;--primary-light:#CCFBF1;
  --bg:#F1F5F9;--card:#FFFFFF;--border:#E2E8F0;
  --text:#1E293B;--muted:#64748B;--danger:#EF4444;--success:#22C55E;
  --shadow:0 2px 12px rgba(0,0,0,.08);--radius:12px;
  --font:'Segoe UI',system-ui,sans-serif;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
#topbar{position:fixed;top:0;left:0;right:0;z-index:100;height:54px;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 14px;gap:10px;box-shadow:var(--shadow);}
.logo-icon{width:36px;height:36px;background:#fff;border:2px solid #1E293B;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:2px 2px 0 #1E293B;position:relative;}
.logo-icon svg{display:block;}
.logo-text{font-weight:900;font-size:15px;color:#1E293B;letter-spacing:-.3px;}
.logo-sub{font-size:10px;color:var(--muted);line-height:1;}
#slot-select{flex:1;max-width:150px;padding:5px 8px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-weight:600;color:var(--text);background:var(--bg);outline:none;}
.topbar-btns{display:flex;gap:6px;margin-left:auto;}
.tbtn{padding:7px 12px;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:5px;white-space:nowrap;transition:opacity .15s;}
.tbtn:hover{opacity:.85;}
.tbtn-primary{background:var(--primary);color:#fff;}
.tbtn-dark{background:#1E293B;color:#fff;}
.tbtn-light{background:var(--bg);color:var(--text);border:1.5px solid var(--border);}
.tbtn-wm{background:linear-gradient(135deg,#7C3AED,#5B21B6);color:#fff;border:none;}
.tbtn-wm:hover{opacity:.88;}
.tbtn-danger{background:#FEF2F2;color:var(--danger);border:1.5px solid #FECACA;}
.tbtn-danger:hover{background:var(--danger);color:#fff;opacity:1;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#app{padding-top:54px;display:flex;min-height:100vh;}
#sidebar{width:220px;flex-shrink:0;background:var(--card);border-right:1px solid var(--border);position:fixed;top:54px;left:0;bottom:0;overflow-y:auto;display:flex;flex-direction:column;z-index:90;}
#main-content{margin-left:220px;flex:1;padding:20px;min-height:calc(100vh - 54px);max-width:680px;}
#right-panel{width:360px;flex-shrink:0;position:sticky;top:54px;height:calc(100vh - 54px);overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:12px;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar-section{padding:12px 8px 6px;font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;border-radius:10px;margin:1px 6px;font-size:13px;font-weight:600;color:var(--muted);transition:all .15s;}
.nav-item:hover{background:var(--bg);color:var(--text);}
.nav-item.active{background:var(--primary-light);color:var(--primary);font-weight:700;}
.nav-item .icon{font-size:16px;width:20px;text-align:center;}
.nav-footer{margin-top:auto;padding:12px;font-size:11px;color:var(--muted);border-top:1px solid var(--border);}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.page{display:none;}.page.active{display:block;}
.card{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);margin-bottom:14px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.04);}
.card-header{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;background:#FAFCFF;border-bottom:1px solid var(--border);cursor:pointer;user-select:none;}
.card-header-left{display:flex;align-items:center;gap:9px;}
.card-title{font-weight:700;font-size:14px;}
.card-icon{font-size:17px;}
.chevron{color:var(--primary);font-size:16px;transition:transform .2s;}
.chevron.up{transform:rotate(180deg);}
.card-body{padding:16px;}
.card-body.collapsed{display:none;}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.field{margin-bottom:13px;}
.field label{display:block;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;}
.field label span.req{color:var(--danger);}
.field input,.field textarea,.field select{width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:9px;font-size:13.5px;color:var(--text);background:#FAFCFF;outline:none;font-family:var(--font);transition:border-color .15s,box-shadow .15s;}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(15,118,110,.1);}
.field textarea{resize:vertical;min-height:80px;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}

/* ‚îÄ‚îÄ ENTRY BLOCKS ‚îÄ‚îÄ */
.entry-block{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px;}
.entry-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.entry-num{font-weight:700;font-size:12px;color:var(--primary);}
.entry-actions{display:flex;gap:6px;}
.icon-btn{padding:5px 9px;border:1px solid var(--border);border-radius:7px;background:var(--card);cursor:pointer;font-size:13px;color:var(--muted);transition:all .15s;}
.icon-btn:hover{border-color:var(--primary);color:var(--primary);}
.icon-btn.danger:hover{border-color:var(--danger);color:var(--danger);background:#FEF2F2;}

/* ‚îÄ‚îÄ BULLETS ‚îÄ‚îÄ */
.bullet-wrap{margin-bottom:10px;}
.bullet-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;}
.bullet-row{display:flex;gap:6px;margin-bottom:5px;align-items:center;}
.bullet-row input{flex:1;padding:8px 11px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;outline:none;font-family:var(--font);background:#fff;}
.bullet-row input:focus{border-color:var(--primary);}
.bullet-del{background:none;border:none;color:#CBD5E1;cursor:pointer;font-size:16px;padding:4px;border-radius:5px;}
.bullet-del:hover{color:var(--danger);background:#FEF2F2;}
.add-bullet-btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;background:none;border:1.5px dashed var(--border);border-radius:7px;color:var(--muted);font-size:12px;font-weight:600;cursor:pointer;margin-top:3px;transition:all .15s;}
.add-bullet-btn:hover{border-color:var(--primary);color:var(--primary);}
.suggest-btn{padding:5px 10px;background:var(--primary-light);border:none;border-radius:6px;color:var(--primary);font-size:11px;font-weight:700;cursor:pointer;}

/* ‚îÄ‚îÄ ADD BUTTONS ‚îÄ‚îÄ */
.add-entry-btn{display:flex;align-items:center;justify-content:center;gap:7px;width:100%;padding:11px;background:none;border:1.5px dashed var(--primary);border-radius:10px;color:var(--primary);font-weight:700;font-size:13px;cursor:pointer;transition:all .15s;margin-bottom:6px;}
.add-entry-btn:hover{background:var(--primary-light);}

/* ‚îÄ‚îÄ TOGGLE ‚îÄ‚îÄ */
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);gap:12px;}
.toggle-row:last-child{border-bottom:none;}
.toggle-info{display:flex;flex-direction:column;flex:1;min-width:0;}
.toggle-info label{font-weight:600;font-size:13px;cursor:pointer;}
.toggle-info span{font-size:11px;color:var(--muted);margin-top:1px;}
.switch{position:relative;width:48px;height:26px;flex-shrink:0;display:inline-block;}
.switch input{opacity:0;width:0;height:0;position:absolute;}
.slider{position:absolute;inset:0;background:#CBD5E1;border-radius:26px;cursor:pointer;transition:background .2s;}
.slider::after{content:'';position:absolute;width:20px;height:20px;top:3px;left:3px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
input:checked+.slider{background:var(--primary);}
input:checked+.slider::after{transform:translateX(22px);}

/* ‚îÄ‚îÄ PHOTO ‚îÄ‚îÄ */
#photo-zone{width:100%;height:130px;border:2px dashed var(--border);border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;background:var(--bg);overflow:hidden;position:relative;}
#photo-zone:hover{border-color:var(--primary);background:var(--primary-light);}
#photo-zone img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
#photo-zone .overlay{position:absolute;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:13px;}
#photo-zone:hover .overlay{display:flex;}
.photo-placeholder{display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);}
.photo-placeholder span{font-size:30px;}
.photo-placeholder p{font-size:12px;font-weight:600;}

/* ‚îÄ‚îÄ CV STRENGTH ‚îÄ‚îÄ */
#strength-card{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);padding:16px;box-shadow:var(--shadow);}
#strength-card h3{font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:7px;}
.score-ring{display:flex;flex-direction:column;align-items:center;margin-bottom:12px;}
.score-num{font-size:32px;font-weight:900;color:var(--primary);}
.score-label{font-size:11px;color:var(--muted);font-weight:600;}
.score-bar{width:100%;height:8px;background:var(--bg);border-radius:8px;overflow:hidden;margin-bottom:12px;}
.score-fill{height:100%;border-radius:8px;background:var(--primary);transition:width .4s;}
.score-item{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:12px;border-bottom:1px solid var(--bg);}
.score-item:last-child{border:none;}
.score-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

/* ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ */
#preview-card{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);padding:12px;box-shadow:var(--shadow);}
#preview-card h3{font-size:13px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:7px;}
#preview-wrap{width:100%;overflow:hidden;border:1px solid var(--border);border-radius:6px;background:#fff;position:relative;max-height:500px;overflow-y:auto;}
#preview-iframe{width:595px;height:842px;border:none;transform-origin:top left;display:block;min-height:842px;}

/* ‚îÄ‚îÄ TEMPLATE PICKER ‚îÄ‚îÄ */
.tpl-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.tpl-card{border:2px solid var(--border);border-radius:10px;padding:11px;cursor:pointer;transition:all .15s;position:relative;}
.tpl-card:hover{border-color:var(--primary);background:#FAFFFF;}
.tpl-card.active{border-color:var(--primary);background:var(--primary-light);}
.tpl-bar{height:5px;border-radius:3px;margin-bottom:7px;width:50%;}
.tpl-name{font-weight:700;font-size:11.5px;margin-bottom:2px;}
.tpl-desc{font-size:9.5px;color:var(--muted);}
.tpl-demo-tag{position:absolute;top:7px;right:7px;padding:2px 7px;font-size:9px;font-weight:700;background:rgba(15,118,110,.1);color:var(--primary);border-radius:5px;border:1px solid rgba(15,118,110,.2);}
.tpl-card.active .tpl-demo-tag{background:var(--primary);color:#fff;}

/* ‚îÄ‚îÄ COLOR PICKER ‚îÄ‚îÄ */
.color-grid{display:flex;flex-wrap:wrap;gap:8px;}
.color-dot{width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:transform .15s;}
.color-dot.active,.color-dot:hover{transform:scale(1.15);border-color:var(--text);}
#custom-color{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid var(--border);padding:0;background:none;}

/* ‚îÄ‚îÄ DEMO MODAL ‚îÄ‚îÄ */
#demo-modal{display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:16px;}
#demo-modal.show{display:flex;}
#demo-box{background:var(--bg);border-radius:16px;width:100%;max-width:700px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 24px 64px rgba(0,0,0,.4);}
#demo-topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--card);border-bottom:1px solid var(--border);}
#demo-title{font-weight:800;font-size:15px;}
#demo-subtitle{font-size:11px;color:var(--muted);margin-top:2px;}
.demo-close-btn{width:32px;height:32px;border-radius:50%;border:none;background:var(--bg);cursor:pointer;font-size:17px;font-weight:700;color:var(--muted);}
.demo-close-btn:hover{background:#FEF2F2;color:var(--danger);}
#demo-scroll{overflow-y:auto;padding:16px;display:flex;justify-content:center;background:#dde0e5;flex:1;}
#demo-iframe{width:595px;height:842px;border:none;background:#fff;box-shadow:0 4px 24px rgba(0,0,0,.2);transform:scale(0.84);transform-origin:top center;margin-bottom:-136px;}
#demo-footer{padding:12px 18px;background:var(--card);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.demo-nav-row{display:flex;gap:8px;align-items:center;}
.demo-dot{width:11px;height:11px;border-radius:50%;background:var(--border);cursor:pointer;transition:all .2s;}
.demo-dot.active{background:var(--primary);transform:scale(1.3);}
.demo-arrow{padding:7px 13px;background:var(--bg);border:1px solid var(--border);border-radius:7px;font-weight:700;cursor:pointer;font-size:12px;}
.demo-arrow:hover{border-color:var(--primary);color:var(--primary);}
.btn-use-tpl{padding:10px 22px;background:var(--primary);color:#fff;border:none;border-radius:9px;font-weight:700;font-size:13px;cursor:pointer;}

/* ‚îÄ‚îÄ BULLET LIBRARY ‚îÄ‚îÄ */
#lib-modal{display:none;position:fixed;inset:0;z-index:998;background:rgba(0,0,0,.5);align-items:flex-end;justify-content:center;}
#lib-modal.show{display:flex;}
#lib-box{background:var(--card);border-radius:16px 16px 0 0;width:100%;max-width:600px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 -8px 40px rgba(0,0,0,.2);}
.lib-handle{width:40px;height:4px;background:var(--border);border-radius:4px;margin:10px auto 0;}
.lib-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.lib-header h3{font-size:15px;font-weight:700;}
.lib-cats{display:flex;gap:7px;overflow-x:auto;padding:10px 14px;border-bottom:1px solid var(--border);-webkit-overflow-scrolling:touch;}
.lib-cat{padding:6px 14px;border-radius:20px;border:1.5px solid var(--border);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;background:var(--bg);color:var(--muted);}
.lib-cat.active{background:var(--primary);color:#fff;border-color:var(--primary);}
#lib-bullets{overflow-y:auto;padding:12px 14px;flex:1;}
.lib-bullet{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;cursor:pointer;transition:background .1s;border:1px solid transparent;}
.lib-bullet:hover{background:var(--primary-light);border-color:var(--primary);}
.lib-bullet-text{font-size:13px;flex:1;line-height:1.4;}
.lib-add-icon{color:var(--primary);font-size:18px;font-weight:700;flex-shrink:0;}

/* ‚îÄ‚îÄ IMPORT ‚îÄ‚îÄ */
.import-zone{border:2px dashed var(--border);border-radius:12px;padding:24px;text-align:center;cursor:pointer;transition:all .15s;background:var(--bg);}
.import-zone:hover,.import-zone.dragover{border-color:var(--primary);background:var(--primary-light);}
.import-zone p{font-size:13px;color:var(--muted);margin-top:6px;}
.import-icon{font-size:36px;margin-bottom:6px;}
.import-result{border-radius:10px;padding:12px;margin-top:10px;font-size:12.5px;font-weight:600;}
.import-ok{background:var(--primary-light);border:1px solid var(--primary);color:var(--primary);}
.import-err{background:#FEF2F2;border:1px solid var(--danger);color:var(--danger);}
.import-fields{margin-top:10px;font-size:11.5px;color:var(--muted);background:var(--bg);border-radius:8px;padding:10px;line-height:1.8;}
.import-progress{margin-top:8px;height:6px;background:var(--bg);border-radius:6px;overflow:hidden;}
.import-progress-bar{height:100%;background:var(--primary);border-radius:6px;transition:width .3s;width:0%;}

/* ‚îÄ‚îÄ PDF DOWNLOAD OVERLAY ‚îÄ‚îÄ */
#pdf-overlay{display:none;position:fixed;inset:0;z-index:9999;background:rgba(15,23,42,.8);backdrop-filter:blur(6px);align-items:center;justify-content:center;flex-direction:column;gap:16px;}
#pdf-overlay.show{display:flex;}
.pdf-spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.pdf-overlay-text{color:#fff;font-weight:700;font-size:15px;}
.pdf-overlay-sub{color:rgba(255,255,255,.6);font-size:12px;}

/* ‚îÄ‚îÄ MOBILE PREVIEW PAGE ‚îÄ‚îÄ */
#preview-page{display:none;position:fixed;inset:0;top:54px;bottom:58px;z-index:80;background:#c8cdd4;overflow:hidden;flex-direction:column;}
#preview-page.show{display:flex;}
#preview-mobile-toolbar{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#1E293B;flex-shrink:0;}
#preview-mobile-toolbar span{color:#fff;font-size:12px;font-weight:600;}
#preview-mobile-toolbar button{padding:6px 14px;border:none;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;}
#preview-mobile-toolbar .export-btn{background:var(--primary);color:#fff;}
#preview-mobile-toolbar .close-btn{background:rgba(255,255,255,.15);color:#fff;}
#preview-scroll-area{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;display:flex;justify-content:center;padding:12px 0;}
#preview-scaled-wrap{transform-origin:top center;will-change:transform;}
#preview-full-iframe{width:595px;min-height:842px;border:none;background:#fff;box-shadow:0 4px 32px rgba(0,0,0,.3);border-radius:2px;display:block;}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
#bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;height:58px;background:var(--card);border-top:1px solid var(--border);z-index:100;grid-template-columns:repeat(8,1fr);box-shadow:0 -2px 12px rgba(0,0,0,.08);}
.bnav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;cursor:pointer;font-size:8.5px;font-weight:600;color:var(--muted);transition:color .15s;border:none;background:none;padding:4px 1px;}
.bnav-item.active{color:var(--primary);}
.bnav-icon{font-size:18px;line-height:1;}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.section-title{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.info-box{background:#EFF6FF;border:1px solid #BFDBFE;border-radius:9px;padding:10px 13px;font-size:12px;color:#1D4ED8;margin-bottom:12px;display:flex;gap:8px;align-items:flex-start;line-height:1.5;}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1E293B;color:#fff;padding:10px 20px;border-radius:30px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;}
.toast.show{opacity:1;}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:900px){
  #sidebar{display:none;}
  #main-content{margin-left:0;padding:14px 12px 20px;}
  #right-panel{display:none;}
  #app{padding-bottom:70px;}
  #bottom-nav{display:grid;}
  .topbar-btns .tbtn-dark{display:none;}
}
@media(max-width:600px){
  .g2,.g3{grid-template-columns:1fr;}
  #topbar{padding:0 8px;gap:6px;overflow:hidden;}
  .logo-sub{display:none;}
  .logo-text{display:none;}
  #slot-select{max-width:90px;font-size:11px;}
  .topbar-btns{gap:4px;flex-shrink:0;}
  .tbtn{padding:6px 8px;font-size:11px;gap:3px;}
  .tbtn span{display:none;}
  .card-body{padding:12px;}
  .entry-block{padding:12px;}
  .field input,.field textarea,.field select{font-size:16px;}
  .bullet-row input{font-size:16px;}
  .add-entry-btn{padding:13px;font-size:14px;}
  #strength-card{display:none;}
}
@media(max-width:400px){
  #topbar{gap:4px;padding:0 6px;}
  #slot-select{max-width:75px;font-size:10px;}
  .tbtn{padding:5px 7px;font-size:10px;}
}

/* ‚îÄ‚îÄ PRINT (fallback) ‚îÄ‚îÄ */
#print-overlay{display:none;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DOWNLOAD CODE MODAL ‚Äî Free version, no payment
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#pay-modal{display:none;position:fixed;inset:0;z-index:10000;background:rgba(15,23,42,.75);backdrop-filter:blur(6px);align-items:flex-end;justify-content:center;}
#pay-modal.show{display:flex;}
@media(min-width:540px){#pay-modal{align-items:center;padding:20px;}}
#pay-box{background:#fff;border-radius:24px 24px 0 0;width:100%;max-width:460px;overflow:hidden;box-shadow:0 -6px 40px rgba(0,0,0,.22);animation:paySlide .3s cubic-bezier(.25,1,.5,1);}
@media(min-width:540px){#pay-box{border-radius:22px;animation:payPop .25s cubic-bezier(.25,1,.5,1);}}
@keyframes paySlide{from{transform:translateY(60px);opacity:.4}to{transform:none;opacity:1}}
@keyframes payPop{from{transform:scale(.94);opacity:0}to{transform:none;opacity:1}}
/* Header */
#pay-header{background:linear-gradient(135deg,#0F766E 0%,#0D6B63 100%);padding:20px 20px 22px;position:relative;}
.pay-pill{width:36px;height:4px;background:rgba(255,255,255,.22);border-radius:99px;margin:0 auto 16px;}
.pay-close-x{position:absolute;top:14px;right:16px;width:30px;height:30px;border-radius:50%;border:none;background:rgba(255,255,255,.12);color:rgba(255,255,255,.7);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.pay-close-x:hover{background:rgba(255,255,255,.22);color:#fff;}
.pay-dl-icon{width:44px;height:44px;background:rgba(255,255,255,.14);border-radius:13px;display:flex;align-items:center;justify-content:center;margin-bottom:11px;}
#pay-header h2{color:#fff;font-size:18px;font-weight:900;margin-bottom:5px;letter-spacing:-.3px;}
#pay-header .pay-sub{color:rgba(255,255,255,.65);font-size:12px;line-height:1.6;}
.free-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.22);border-radius:99px;padding:4px 13px 5px;margin-top:12px;color:#fff;font-size:11px;font-weight:800;letter-spacing:.4px;}
/* Body */
#pay-body{padding:20px 20px 26px;}
@media(min-width:540px){#pay-body{padding:22px 24px 30px;}}
/* Choice cards */
.pay-cards{display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-bottom:4px;}
.pay-card{border:2px solid #E2E8F0;border-radius:18px;padding:18px 12px 16px;text-align:center;cursor:pointer;background:#FAFCFF;transition:all .18s;-webkit-tap-highlight-color:transparent;user-select:none;}
.pay-card:active{transform:scale(.96);}
.pay-card:hover{border-color:#0F766E;background:#F0FDFA;box-shadow:0 4px 20px rgba(15,118,110,.1);}
.pay-card-ico{width:46px;height:46px;border-radius:13px;margin:0 auto 11px;display:flex;align-items:center;justify-content:center;}
.pay-card-ico.c-green{background:#F0FDF4;}
.pay-card-ico.c-teal{background:#F0FDFA;}
.pay-card h3{font-size:13.5px;font-weight:800;color:#1E293B;margin-bottom:4px;}
.pay-card p{font-size:11px;color:#64748B;line-height:1.45;}
/* WhatsApp section */
#pay-upi-sec{display:none;}
.wa-info-box{background:#F0FDF4;border:1.5px solid #86EFAC;border-radius:14px;padding:14px 16px;margin-bottom:14px;}
.wa-info-title{font-size:13px;font-weight:800;color:#166534;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.wa-info-step{font-size:12px;color:#15803D;line-height:1.8;display:flex;gap:8px;align-items:flex-start;}
.wa-step-num{min-width:20px;height:20px;border-radius:50%;background:#22C55E;color:#fff;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;}
.wa-btn{width:100%;padding:16px;background:#25D366;color:#fff;border:none;border-radius:14px;font-weight:800;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;-webkit-tap-highlight-color:transparent;box-shadow:0 4px 16px rgba(37,211,102,.3);}
.wa-btn:active{background:#1ebe5a;}
.back-lnk{text-align:center;margin-top:14px;font-size:12.5px;color:#94A3B8;cursor:pointer;padding:6px;font-weight:600;}
.back-lnk:hover{color:#475569;}
/* Code entry section */
#pay-code-sec{display:none;}
.code-how-box{background:#F8FAFC;border:1.5px solid #E2E8F0;border-radius:13px;padding:13px 15px;margin-bottom:14px;}
.code-how-title{font-size:12px;font-weight:800;color:#1E293B;margin-bottom:8px;}
.code-how-step{font-size:11.5px;color:#475569;line-height:1.75;display:flex;gap:8px;}
.code-how-num{min-width:18px;height:18px;border-radius:50%;background:#0F766E;color:#fff;font-size:9px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;}
.code-lbl{font-size:12px;font-weight:700;color:#1E293B;margin-bottom:8px;display:block;}
.code-dots{display:flex;align-items:center;justify-content:center;gap:7px;margin-bottom:13px;}
.cdot{width:12px;height:12px;border-radius:50%;background:#E2E8F0;transition:background .2s;}
.cdot.used{background:#EF4444;}
.cdot-lbl{font-size:11px;color:#94A3B8;margin-left:3px;font-weight:600;}
.code-field{width:100%;padding:18px 10px;border:2.5px solid #E2E8F0;border-radius:14px;font-size:30px;font-weight:900;text-align:center;letter-spacing:12px;text-transform:uppercase;outline:none;font-family:'Courier New',monospace;color:#1E293B;background:#FAFCFF;transition:border-color .15s,box-shadow .15s;-webkit-tap-highlight-color:transparent;margin-bottom:8px;}
.code-field:focus{border-color:#0F766E;box-shadow:0 0 0 4px rgba(15,118,110,.1);}
.code-field.err{border-color:#EF4444;box-shadow:0 0 0 4px rgba(239,68,68,.08);animation:cshake .35s;}
.code-field.ok{border-color:#22C55E;box-shadow:0 0 0 4px rgba(34,197,94,.1);}
@keyframes cshake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}50%{transform:translateX(4px)}}
.code-pool-hint{font-size:11px;color:#94A3B8;text-align:center;margin-bottom:14px;}
.err-box{background:#FEF2F2;border:1.5px solid #FECACA;border-radius:10px;padding:10px 14px;font-size:12px;color:#991B1B;font-weight:600;margin-bottom:12px;display:none;text-align:center;line-height:1.5;}
.lock-box{background:#FFF7ED;border:1.5px solid #FED7AA;border-radius:12px;padding:14px;display:none;text-align:center;margin-bottom:12px;}
.lock-title{font-size:13px;color:#9A3412;font-weight:800;margin-bottom:6px;}
.lock-time{font-size:28px;font-weight:900;color:#C2410C;letter-spacing:3px;line-height:1;}
.lock-sub{font-size:11px;color:#9A3412;margin-top:5px;}
.unlock-btn{width:100%;padding:16px;background:#0F766E;color:#fff;border:none;border-radius:14px;font-weight:900;font-size:15px;cursor:pointer;-webkit-tap-highlight-color:transparent;display:flex;align-items:center;justify-content:center;gap:9px;box-shadow:0 4px 16px rgba(15,118,110,.25);}
.unlock-btn:active{background:#0D6B63;}
.unlock-btn:disabled{background:#CBD5E1;cursor:not-allowed;box-shadow:none;}

/* Admin panel */
#admin-panel{display:none;position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,.88);backdrop-filter:blur(10px);align-items:center;justify-content:center;padding:20px;}
#admin-panel.show{display:flex;}
#admin-box{background:#0F172A;border:1px solid #1E293B;border-radius:20px;width:100%;max-width:300px;overflow:hidden;}
#admin-header{padding:14px 18px;border-bottom:1px solid #1E293B;display:flex;align-items:center;justify-content:space-between;}
#admin-header h3{color:#E2E8F0;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:1px;}
.admin-x{background:none;border:none;color:#475569;font-size:16px;cursor:pointer;line-height:1;}
.admin-x:hover{color:#E2E8F0;}
#admin-body{padding:16px 18px;}
.a-pwd{width:100%;padding:12px 14px;background:#1E293B;border:1.5px solid #334155;border-radius:10px;color:#F1F5F9;font-size:20px;outline:none;margin-bottom:10px;letter-spacing:6px;font-family:'Courier New',monospace;text-align:center;}
.a-pwd:focus{border-color:#60A5FA;}
.a-login{width:100%;padding:12px;background:#3B82F6;color:#fff;border:none;border-radius:10px;font-weight:800;font-size:13px;cursor:pointer;}
.a-err{color:#F87171;font-size:11px;text-align:center;margin-top:6px;display:none;}
#admin-content{display:none;}
.a-lbl{font-size:9px;font-weight:800;color:#60A5FA;text-transform:uppercase;letter-spacing:2px;margin-bottom:6px;}
.a-code{font-size:30px;font-weight:900;color:#34D399;letter-spacing:8px;font-family:'Courier New',monospace;text-align:center;background:#1E293B;border-radius:10px;padding:14px;margin-bottom:4px;}
.a-date{font-size:10px;color:#475569;text-align:center;margin-bottom:14px;}
.a-rule{background:#1E293B;border-radius:10px;padding:12px;font-size:11px;color:#64748B;line-height:1.7;}
.a-rule b{color:#94A3B8;}




/* ‚îÄ‚îÄ ENHANCED ADMIN PANEL ‚îÄ‚îÄ */
.admin-tabs{display:flex;border-bottom:1px solid #1E293B;margin-bottom:12px;}
.admin-tab{flex:1;padding:8px;background:none;border:none;color:#475569;font-size:11px;font-weight:700;cursor:pointer;text-align:center;border-bottom:2px solid transparent;transition:all .15s;}
.admin-tab.active{color:#60A5FA;border-bottom-color:#60A5FA;}
.admin-tab-pane{display:none;}
.admin-tab-pane.active{display:block;}
.a-gen-btn{width:100%;padding:11px;background:#10B981;color:#fff;border:none;border-radius:8px;font-weight:800;font-size:13px;cursor:pointer;margin-top:8px;}
.a-gen-btn:hover{background:#059669;}
.a-code-out{background:#1E293B;border-radius:8px;padding:12px;text-align:center;margin-top:8px;}
.a-code-big{font-size:28px;font-weight:900;color:#34D399;letter-spacing:8px;font-family:'Courier New',monospace;}
.a-code-copy{margin-top:6px;padding:6px 16px;background:#3B82F6;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;}

@media print{
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important;}
  html,body{margin:0!important;padding:0!important;background:white!important;}
  #topbar,#sidebar,#app,#bottom-nav,#demo-modal,#lib-modal,#print-overlay ~ *,.toast,#pdf-overlay{display:none!important;}
  #print-overlay{display:block!important;width:100%;margin:0;padding:0;}
  @page{size:A4;margin:0;}
}
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- PDF DOWNLOAD OVERLAY -->
<div id="pdf-overlay">
  <div class="pdf-spinner"></div>
  <div class="pdf-overlay-text" id="pdf-overlay-text">üìÑ Opening Print Dialog...</div>
  <div class="pdf-overlay-sub" id="pdf-overlay-sub">Choose <strong style="color:#fff;">"Save as PDF"</strong> ‚Üí destination in the dialog</div>
</div>

<!-- TOP BAR -->
<div id="topbar">
  <div class="logo-icon" onclick="logoClick()" style="cursor:pointer;" title="CV Builder Pro">
    <svg width="20" height="22" viewBox="0 0 20 22" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M3 2C3 1.44772 3.44772 1 4 1H13L18 6V20C18 20.5523 17.5523 21 17 21H4C3.44772 21 3 20.5523 3 20V2Z" fill="white" stroke="#1E293B" stroke-width="1.5"/>
      <path d="M13 1L13 6H18" stroke="#1E293B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="6.5" y1="9" x2="14.5" y2="9" stroke="#1E293B" stroke-width="1.2" stroke-linecap="round"/>
      <line x1="6.5" y1="12" x2="14.5" y2="12" stroke="#1E293B" stroke-width="1.2" stroke-linecap="round"/>
      <line x1="6.5" y1="15" x2="11" y2="15" stroke="#1E293B" stroke-width="1.2" stroke-linecap="round"/>
    </svg>
  </div>
  <div>
    <div class="logo-text"><span style="background:#1E293B;color:#fff;padding:1px 5px;border-radius:4px;font-size:13px;margin-right:3px;">CV</span>Builder Pro</div>
    <div class="logo-sub">Free ¬∑ Offline ¬∑ Auto-saves</div>
  </div>
  <select id="slot-select" onchange="loadSlot(+this.value)">
    <option value="0">üìÑ CV 1</option>
    <option value="1">üìÑ CV 2</option>
    <option value="2">üìÑ CV 3</option>
  </select>
  <div class="topbar-btns">
    <button class="tbtn tbtn-danger" onclick="confirmHardReset()" title="Hard reset all data">üóë <span>Reset</span></button>
    <button class="tbtn tbtn-light" onclick="backupData()">üíæ <span>Backup</span></button>
    <button class="tbtn tbtn-wm" onclick="downloadWatermarkPDF()" title="Download preview with One Net Solution watermark">üîí <span>Preview PDF</span></button>
    <button class="tbtn tbtn-dark" onclick="downloadPDF()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>&nbsp;Download PDF</button>
  </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="sidebar-section">Build CV</div>
  <div class="nav-item active" onclick="showPage('personal')" data-page="personal"><span class="icon">üë§</span>Personal Info</div>
  <div class="nav-item" onclick="showPage('experience')" data-page="experience"><span class="icon">üíº</span>Experience</div>
  <div class="nav-item" onclick="showPage('education')" data-page="education"><span class="icon">üéì</span>Education</div>
  <div class="nav-item" onclick="showPage('skills')" data-page="skills"><span class="icon">üõ†</span>Skills</div>
  <div class="nav-item" onclick="showPage('extras')" data-page="extras"><span class="icon">‚úö</span>Extras & Toggles</div>
  <div class="sidebar-section">Design</div>
  <div class="nav-item" onclick="showPage('design')" data-page="design"><span class="icon">üé®</span>Templates & Style</div>
  <div class="sidebar-section">Tools</div>
  <div class="nav-item" onclick="backupData()"><span class="icon">üíæ</span>Download Backup</div>
  <div class="nav-item" onclick="document.getElementById('restore-input').click()"><span class="icon">‚¨Ü</span>Restore Backup</div>
  <input type="file" id="restore-input" accept=".json" style="display:none" onchange="restoreData(this)"/>
  <div class="nav-footer">Free ¬∑ Auto-saved ¬∑ Works Offline<br/>No internet needed</div>
</div>

<!-- MAIN APP -->
<div id="app">
<div id="main-content">

  <!-- PERSONAL -->
  <div id="page-personal" class="page active">
    <div class="section-title">üë§ Personal Information</div>
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üñº</span><span class="card-title">Profile Photo & Name</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div class="g2">
          <div>
            <div id="photo-zone" onclick="document.getElementById('photo-input').click()">
              <div class="photo-placeholder"><span>üì∑</span><p>Tap to upload</p></div>
              <div class="overlay">Change Photo</div>
            </div>
            <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="handlePhoto(this)"/>
            <button onclick="removePhoto()" style="width:100%;margin-top:6px;padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:7px;font-size:12px;color:var(--muted);cursor:pointer;">‚úï Remove Photo</button>
          </div>
          <div>
            <div class="field"><label>Full Name <span class="req">*</span></label><input id="p_name" placeholder="Enter your full name" oninput="autoSave()"/></div>
            <div class="field"><label>Father's Name</label><input id="p_father" placeholder="Enter your father's name" oninput="autoSave()"/></div>
            <div class="field"><label>Job Title <span class="req">*</span></label><input id="p_title" placeholder="Enter your job title" oninput="autoSave()"/></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üìû</span><span class="card-title">Contact Details</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div class="g2">
          <div class="field"><label>Phone <span class="req">*</span></label><input id="p_phone" type="tel" placeholder="Enter your phone number" oninput="autoSave()"/></div>
          <div class="field"><label>Email</label><input id="p_email" type="email" placeholder="Enter your email address" oninput="autoSave()"/></div>
        </div>
        <div class="field"><label>City, Country <span class="req">*</span></label><input id="p_location" placeholder="e.g. Mumbai, India" oninput="autoSave()"/></div>
        <div class="field"><label>LinkedIn (Optional)</label><input id="p_linkedin" placeholder="linkedin.com/in/yourprofile" oninput="autoSave()"/></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üìã</span><span class="card-title">Personal Details</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div class="g2">
          <div class="field"><label>Date of Birth</label><input id="p_dob" placeholder="e.g. 12 Jan 1993" oninput="autoSave()"/></div>
          <div class="field"><label>Nationality</label><input id="p_nation" placeholder="e.g. Indian" oninput="autoSave()"/></div>
          <div class="field"><label>Marital Status</label><input id="p_marital" placeholder="e.g. Married" oninput="autoSave()"/></div>
          <div class="field"><label>Religion</label><input id="p_religion" placeholder="e.g. Hindu" oninput="autoSave()"/></div>
        </div>
        <div class="field"><label>Languages Known</label><input id="p_lang" placeholder="e.g. Hindi, English, Odia" oninput="autoSave()"/></div>
        <div class="g2">
          <div class="field"><label>Passport No.</label><input id="p_passport" placeholder="e.g. A1234567" oninput="autoSave()"/></div>
          <div class="field"><label>Passport Expiry</label><input id="p_passport_exp" placeholder="e.g. 27/12/2033" oninput="autoSave()"/></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">‚úçÔ∏è</span><span class="card-title">Professional Summary</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div class="field">
          <textarea id="p_summary" rows="4" placeholder="Write 2‚Äì4 lines about your experience, key skills, and what makes you a strong candidate..." oninput="autoSave();updateSummaryCount()"></textarea>
          <div style="text-align:right;font-size:10px;color:var(--muted);margin-top:3px;"><span id="summary-count">0</span> characters</div>
        </div>
        <button onclick="autoGenSummary()" style="padding:8px 16px;background:var(--primary-light);border:1.5px solid var(--primary);border-radius:8px;color:var(--primary);font-weight:700;font-size:12px;cursor:pointer;">‚ú® Auto-Write Summary</button>
      </div>
    </div>
  </div>

  <!-- EXPERIENCE -->
  <div id="page-experience" class="page">
    <div class="section-title">üíº Work Experience</div>
    <div class="info-box">‚ÑπÔ∏è Add most recent job first.</div>
    <div id="jobs-container"></div>
    <button class="add-entry-btn" onclick="addJob()">+ Add Job</button>
  </div>

  <!-- EDUCATION -->
  <div id="page-education" class="page">
    <div class="section-title">üéì Education</div>
    <div id="edu-container"></div>
    <button class="add-entry-btn" onclick="addEdu()">+ Add Education</button>
  </div>

  <!-- SKILLS -->
  <div id="page-skills" class="page">
    <div class="section-title">üõ† Skills & Certifications</div>
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üí™</span><span class="card-title">Skills</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div id="skills-container"></div>
        <button class="add-entry-btn" onclick="addSkill()">+ Add Skill</button>
      </div>
    </div>
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üìú</span><span class="card-title">Certifications</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div id="certs-container"></div>
        <button class="add-entry-btn" onclick="addCert()">+ Add Certificate</button>
      </div>
    </div>
  <!-- CUSTOM SECTIONS -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">‚ú®</span><span class="card-title">Custom Sections</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div style="font-size:11px;color:var(--muted);margin-bottom:12px;background:var(--primary-light);border:1px solid rgba(15,118,110,.2);border-radius:8px;padding:10px;">
          üí° Add any section ‚Äî <strong>Interests, Hobbies, Languages, Achievements, Volunteer Work, Projects, Awards</strong> etc. Each section gets its own heading, entries with sub-titles, dates, and bullet points ‚Äî just like Experience.
        </div>
        <div id="custom-sections-container"></div>
        <button class="add-entry-btn" onclick="addCustomSection()">+ Add Custom Section</button>
      </div>
    </div>
  </div>

  <!-- EXTRAS -->
  <div id="page-extras" class="page">
    <div class="section-title">‚úö Extras & Page Layout</div>

    <!-- TOGGLES -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üîò</span><span class="card-title">Section Toggles</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div class="toggle-row">
          <div class="toggle-info"><label for="tog_decl">Include Declaration</label><span>Standard declaration at end of CV</span></div>
          <label class="switch"><input type="checkbox" id="tog_decl" onchange="autoSave();renderPageLayout()"/><span class="slider"></span></label>
        </div>
        <div class="toggle-row">
          <div class="toggle-info"><label for="tog_personal">Personal Details Section</label><span>DOB, Nationality, Passport etc.</span></div>
          <label class="switch"><input type="checkbox" id="tog_personal" onchange="autoSave();renderPageLayout()"/><span class="slider"></span></label>
        </div>
        <div class="toggle-row">
          <div class="toggle-info"><label for="tog_photo">Show Photo on CV</label><span>Display uploaded photo on CV</span></div>
          <label class="switch"><input type="checkbox" id="tog_photo" onchange="autoSave()" checked/><span class="slider"></span></label>
        </div>
        <div class="toggle-row">
          <div class="toggle-info"><label for="tog_father">Show Father's Name on CV</label><span>Display S/O father name on CV</span></div>
          <label class="switch"><input type="checkbox" id="tog_father" onchange="autoSave()" checked/><span class="slider"></span></label>
        </div>
      </div>
    </div>

    <!-- FONT FAMILY SELECTOR -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üî§</span><span class="card-title">Font Style</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <style>
          .font-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:4px;}
          .font-card{border:2px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer;transition:all .15s;background:var(--card);position:relative;overflow:hidden;}
          .font-card:hover{border-color:var(--primary);background:#FAFFFF;}
          .font-card.active{border-color:var(--primary);background:var(--primary-light);}
          .font-card.active::after{content:"‚úì";position:absolute;top:7px;right:9px;font-size:11px;font-weight:900;color:var(--primary);}
          .font-card-name{font-weight:800;font-size:11px;color:var(--text);margin-bottom:3px;letter-spacing:.3px;}
          .font-card-preview{font-size:15px;color:#444;line-height:1.3;margin-bottom:3px;}
          .font-card-tag{font-size:9px;color:var(--muted);background:var(--bg);border-radius:4px;padding:2px 6px;display:inline-block;}
        </style>
        <p style="font-size:11px;color:var(--muted);margin-bottom:10px;line-height:1.5;">Choose a font style for your CV. Each family gives a different professional feel.</p>
        <div class="font-grid">
          <div class="font-card active" id="ff-default" onclick="applyFontFamily('default')">
            <div class="font-card-name">Default</div>
            <div class="font-card-preview" style="font-family:Georgia,serif;">Resume</div>
            <span class="font-card-tag">Classic</span>
          </div>
          <div class="font-card" id="ff-playfair" onclick="applyFontFamily('playfair')">
            <div class="font-card-name">Playfair Display</div>
            <div class="font-card-preview" style="font-family:'Playfair Display',serif;">Resume</div>
            <span class="font-card-tag">Elegant ¬∑ Serif</span>
          </div>
          <div class="font-card" id="ff-montserrat" onclick="applyFontFamily('montserrat')">
            <div class="font-card-name">Montserrat</div>
            <div class="font-card-preview" style="font-family:'Montserrat',sans-serif;">Resume</div>
            <span class="font-card-tag">Modern ¬∑ Bold</span>
          </div>
          <div class="font-card" id="ff-raleway" onclick="applyFontFamily('raleway')">
            <div class="font-card-name">Raleway</div>
            <div class="font-card-preview" style="font-family:'Raleway',sans-serif;">Resume</div>
            <span class="font-card-tag">Premium ¬∑ Clean</span>
          </div>
          <div class="font-card" id="ff-garamond" onclick="applyFontFamily('garamond')">
            <div class="font-card-name">EB Garamond</div>
            <div class="font-card-preview" style="font-family:'EB Garamond',serif;">Resume</div>
            <span class="font-card-tag">Literary ¬∑ Refined</span>
          </div>
          <div class="font-card" id="ff-josefin" onclick="applyFontFamily('josefin')">
            <div class="font-card-name">Josefin Sans</div>
            <div class="font-card-preview" style="font-family:'Josefin Sans',sans-serif;">Resume</div>
            <span class="font-card-tag">Geometric ¬∑ Sharp</span>
          </div>
          <div class="font-card" id="ff-nunito" onclick="applyFontFamily('nunito')">
            <div class="font-card-name">Nunito Sans</div>
            <div class="font-card-preview" style="font-family:'Nunito Sans',sans-serif;">Resume</div>
            <span class="font-card-tag">Friendly ¬∑ Round</span>
          </div>
          <div class="font-card" id="ff-cormorant" onclick="applyFontFamily('cormorant')">
            <div class="font-card-name">Cormorant</div>
            <div class="font-card-preview" style="font-family:'Cormorant Garamond',serif;">Resume</div>
            <span class="font-card-tag">Luxury ¬∑ Editorial</span>
          </div>
          <div class="font-card" id="ff-lato" onclick="applyFontFamily('lato')" style="grid-column:1/-1;">
            <div class="font-card-name">Lato</div>
            <div class="font-card-preview" style="font-family:'Lato',sans-serif;font-size:18px;">Resume ¬∑ Professional</div>
            <span class="font-card-tag">Corporate ¬∑ Trusted</span>
          </div>
        </div>
      </div>
    </div>

    <!-- FONT SIZE CONTROLS -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üî°</span><span class="card-title">Typography Style</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">

        <style>
          .typo-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:4px;}
          .typo-preset{border:2px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer;transition:all .15s;background:var(--card);position:relative;overflow:hidden;}
          .typo-preset:hover{border-color:var(--primary);background:#FAFFFF;}
          .typo-preset.active{border-color:var(--primary);background:var(--primary-light);}
          .typo-preset.active::after{content:"‚úì";position:absolute;top:7px;right:9px;font-size:11px;font-weight:900;color:var(--primary);}
          .typo-name{font-weight:800;font-size:12px;color:var(--text);margin-bottom:3px;}
          .typo-desc{font-size:10px;color:var(--muted);margin-bottom:7px;line-height:1.3;}
          .typo-bars{display:flex;flex-direction:column;gap:2px;}
          .typo-bar-row{display:flex;align-items:center;gap:5px;}
          .typo-bar{background:var(--primary);border-radius:3px;opacity:.35;transition:opacity .15s;}
          .typo-bar-lbl{font-size:8.5px;color:var(--muted);min-width:28px;}
          .typo-preset.active .typo-bar{opacity:.75;}
          .typo-preset:hover .typo-bar{opacity:.55;}
        </style>

        <!-- Hidden inputs keep save/load working -->
        <input type="hidden" id="fs-name" value="24"/>
        <input type="hidden" id="fs-toptitle" value="14"/>
        <input type="hidden" id="fs-section" value="13"/>
        <input type="hidden" id="fs-subheader" value="13"/>
        <input type="hidden" id="fs-body" value="12"/>

        <div class="typo-grid">

          <!-- Preset 1: Professional -->
          <div class="typo-preset active" id="typo-professional" onclick="applyTypoPreset('professional')">
            <div class="typo-name">Professional</div>
            <div class="typo-desc">Clean & balanced. Best for most jobs.</div>
            <div class="typo-bars">
              <div class="typo-bar-row"><span class="typo-bar-lbl">Name</span><div class="typo-bar" style="height:5px;width:70px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Title</span><div class="typo-bar" style="height:4px;width:45px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Header</span><div class="typo-bar" style="height:3px;width:36px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Body</span><div class="typo-bar" style="height:2.5px;width:28px;"></div></div>
            </div>
          </div>

          <!-- Preset 2: Compact -->
          <div class="typo-preset" id="typo-compact" onclick="applyTypoPreset('compact')">
            <div class="typo-name">Compact</div>
            <div class="typo-desc">Fits more content. One page CVs.</div>
            <div class="typo-bars">
              <div class="typo-bar-row"><span class="typo-bar-lbl">Name</span><div class="typo-bar" style="height:5px;width:55px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Title</span><div class="typo-bar" style="height:4px;width:36px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Header</span><div class="typo-bar" style="height:3px;width:28px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Body</span><div class="typo-bar" style="height:2px;width:22px;"></div></div>
            </div>
          </div>

          <!-- Preset 3: Bold -->
          <div class="typo-preset" id="typo-bold" onclick="applyTypoPreset('bold')">
            <div class="typo-name">Bold & Modern</div>
            <div class="typo-desc">Strong hierarchy. Makes a statement.</div>
            <div class="typo-bars">
              <div class="typo-bar-row"><span class="typo-bar-lbl">Name</span><div class="typo-bar" style="height:6px;width:80px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Title</span><div class="typo-bar" style="height:4.5px;width:52px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Header</span><div class="typo-bar" style="height:3.5px;width:40px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Body</span><div class="typo-bar" style="height:3px;width:32px;"></div></div>
            </div>
          </div>

          <!-- Preset 4: Executive -->
          <div class="typo-preset" id="typo-executive" onclick="applyTypoPreset('executive')">
            <div class="typo-name">Executive</div>
            <div class="typo-desc">Premium feel. Senior & leadership roles.</div>
            <div class="typo-bars">
              <div class="typo-bar-row"><span class="typo-bar-lbl">Name</span><div class="typo-bar" style="height:6px;width:72px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Title</span><div class="typo-bar" style="height:4.5px;width:50px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Header</span><div class="typo-bar" style="height:4px;width:44px;"></div></div>
              <div class="typo-bar-row"><span class="typo-bar-lbl">Body</span><div class="typo-bar" style="height:3px;width:34px;"></div></div>
            </div>
          </div>

          <!-- Preset 5: Ultra Compact (full width) -->
          <div class="typo-preset" id="typo-ultra" onclick="applyTypoPreset('ultra')" style="grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div class="typo-name">Ultra Compact</div>
              <div class="typo-desc" style="margin-bottom:0;">Maximum content. Experienced professionals with lots to show.</div>
            </div>
            <div class="typo-bars" style="flex-direction:row;align-items:flex-end;gap:3px;flex-shrink:0;margin-left:10px;">
              <div class="typo-bar" style="height:14px;width:7px;border-radius:2px;"></div>
              <div class="typo-bar" style="height:10px;width:7px;border-radius:2px;"></div>
              <div class="typo-bar" style="height:8px;width:7px;border-radius:2px;"></div>
              <div class="typo-bar" style="height:7px;width:7px;border-radius:2px;"></div>
            </div>
          </div>

        </div>

      </div>
    </div>

        <!-- PAGE LAYOUT MANAGER -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üìÑ</span><span class="card-title">Page Layout Control</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div class="info-box" style="margin-bottom:12px;">üìå Control section order in your CV. P1 sections appear first (start of CV), P2 sections in the middle, P3 sections last. Smart page-breaking ensures clean cuts ‚Äî no text is ever split mid-sentence.</div>
        <div style="display:flex;justify-content:flex-end;margin-bottom:8px;">
          <button onclick="resetPageLayout()" style="padding:5px 12px;background:#FEF2F2;color:#EF4444;border:1.5px solid #FECACA;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;" title="Reset all sections back to defaults">‚Ü∫ Reset Layout</button>
        </div>
        <div id="page-layout-ui"></div>
        <div style="margin-top:14px;padding:10px;background:#F0FDF4;border-radius:8px;border:1px solid #86EFAC;">
          <div style="font-size:11px;font-weight:700;color:#166534;margin-bottom:6px;">üìê Margin Settings</div>
          <div class="g2" style="gap:10px;">
            <div class="field" style="margin:0;">
              <label style="font-size:11px;">Bottom margin ‚Äî Page 1 (px)</label>
              <input type="number" id="margin_p1_b" value="36" min="10" max="80" oninput="autoSave()" style="font-size:13px;"/>
            </div>
            <div class="field" style="margin:0;">
              <label style="font-size:11px;">Top margin ‚Äî Page 2+ (px)</label>
              <input type="number" id="margin_p2_t" value="36" min="10" max="80" oninput="autoSave()" style="font-size:13px;"/>
            </div>
          </div>
          <div class="field" style="margin:8px 0 0;">
            <label style="font-size:11px;">Bottom margin ‚Äî Page 2+ (px)</label>
            <input type="number" id="margin_p2_b" value="36" min="10" max="80" oninput="autoSave()" style="font-size:13px;"/>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DESIGN -->
  <div id="page-design" class="page">
    <div class="section-title">üé® Templates & Style</div>
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üìÑ</span><span class="card-title">Choose Template</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div class="tpl-grid" id="tpl-grid"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üé®</span><span class="card-title">Accent Color</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div class="color-grid" id="color-grid"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">‚ÜîÔ∏è</span><span class="card-title">Spacing & Font Size</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div class="field">
          <label>Font Size</label>
          <div style="display:flex;align-items:center;gap:12px;">
            <span style="font-size:11px;color:var(--muted);">A</span>
            <input type="range" id="font-size-slider" min="9" max="16" value="12" step="0.5" oninput="updateDesign()" style="flex:1;accent-color:var(--primary);"/>
            <span style="font-size:15px;color:var(--muted);">A</span>
          </div>
        </div>
        <div class="field">
          <label>Layout Spacing</label>
          <div style="display:flex;gap:8px;">
            <button id="sp-compact" onclick="setSpacing('compact')" class="icon-btn active" style="flex:1;justify-content:center;">Compact</button>
            <button id="sp-normal" onclick="setSpacing('normal')" class="icon-btn" style="flex:1;justify-content:center;">Normal</button>
            <button id="sp-spacious" onclick="setSpacing('spacious')" class="icon-btn" style="flex:1;justify-content:center;">Spacious</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BACKUP/RESTORE PAGE -->
  <div id="page-import" class="page">
    <div class="section-title">üíæ Backup & Restore</div>
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üîÑ</span><span class="card-title">Backup & Restore Your CV Data</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <div class="info-box">‚ÑπÔ∏è Download a backup of all your CV data. Restore it anytime on any device ‚Äî even offline.</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button onclick="backupData()" class="tbtn tbtn-primary" style="flex:1;justify-content:center;">‚¨á Download Backup</button>
          <button onclick="document.getElementById('restore-input-2').click()" class="tbtn tbtn-light" style="flex:1;justify-content:center;">‚¨Ü Restore Backup</button>
        </div>
        <input type="file" id="restore-input-2" accept=".json" style="display:none" onchange="restoreData(this)"/>
        <p style="font-size:11px;color:var(--muted);margin-top:10px;">Your backup includes all 3 CV slots. Restore will overwrite current data.</p>
      </div>
    </div>
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left"><span class="card-icon">üóë</span><span class="card-title">Reset CV Data</span></div>
        <span class="chevron up">‚ñæ</span>
      </div>
      <div class="card-body">
        <p style="font-size:13px;color:var(--muted);margin-bottom:12px;">Hard reset clears all data for the current CV slot. This cannot be undone.</p>
        <button onclick="confirmHardReset()" class="tbtn tbtn-danger" style="width:100%;justify-content:center;padding:12px;">üóë Hard Reset Current CV</button>
      </div>
    </div>
  </div>

</div><!-- end main-content -->

<!-- RIGHT PANEL -->
<div id="right-panel">
  <div id="strength-card">
    <h3>üìä CV Strength</h3>
    <div class="score-ring">
      <div class="score-num" id="score-num">0</div>
      <div class="score-label">out of 100</div>
    </div>
    <div class="score-bar"><div class="score-fill" id="score-fill" style="width:0%"></div></div>
    <div id="score-items"></div>
  </div>
  <div id="preview-card">
    <h3>üëÅ Live Preview <span style="font-size:10px;color:var(--muted);font-weight:400;">(A4 ¬∑ live)</span></h3>
    <div id="preview-wrap">
      <iframe id="preview-iframe" scrolling="no"></iframe>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button onclick="downloadWatermarkPDF()" class="tbtn tbtn-wm" style="flex:1;justify-content:center;font-size:12px;">üîí Preview PDF</button>
      <button onclick="downloadPDF()" class="tbtn tbtn-dark" style="flex:1;justify-content:center;font-size:12px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>&nbsp;Download PDF</button>
    </div>
  </div>
</div>

</div><!-- end app -->

<!-- MOBILE PREVIEW PAGE -->
<div id="preview-page">
  <div id="preview-mobile-toolbar">
    <span>üìÑ CV Preview</span>
    <div style="display:flex;gap:6px;">
      <button class="export-btn" style="background:#7C3AED;" onclick="downloadWatermarkPDF()">üîí Preview</button>
      <button class="export-btn" onclick="downloadPDF()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>&nbsp;Download PDF</button>
      <button class="close-btn" onclick="toggleMobilePreview()">‚úï Close</button>
    </div>
  </div>
  <div id="preview-scroll-area">
    <div id="preview-scaled-wrap">
      <iframe id="preview-full-iframe" scrolling="no"></iframe>
    </div>
  </div>
</div>

<!-- MOBILE BOTTOM NAV -->
<div id="bottom-nav">
  <button class="bnav-item active" onclick="showPage('personal')" data-page="personal"><span class="bnav-icon">üë§</span>Info</button>
  <button class="bnav-item" onclick="showPage('experience')" data-page="experience"><span class="bnav-icon">üíº</span>Work</button>
  <button class="bnav-item" onclick="showPage('education')" data-page="education"><span class="bnav-icon">üéì</span>Edu</button>
  <button class="bnav-item" onclick="showPage('skills')" data-page="skills"><span class="bnav-icon">üõ†</span>Skills</button>
  <button class="bnav-item" onclick="showPage('extras')" data-page="extras"><span class="bnav-icon">‚úö</span>Extras</button>
  <button class="bnav-item" onclick="showPage('design')" data-page="design"><span class="bnav-icon">üé®</span>Design</button>
  <button class="bnav-item" onclick="toggleMobilePreview()" id="bnav-preview"><span class="bnav-icon">üëÅ</span>Preview</button>
  <button class="bnav-item" onclick="toggleMoreMenu()" id="bnav-more"><span class="bnav-icon">‚ãØ</span>More</button>
</div>

<!-- MOBILE MORE MENU -->
<div id="more-menu" style="display:none;position:fixed;bottom:66px;left:0;right:0;z-index:200;padding:0 12px;">
  <div style="background:#fff;border-radius:16px;border:1px solid var(--border);box-shadow:0 -4px 30px rgba(0,0,0,.15);overflow:hidden;">
    <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:1px;display:flex;justify-content:space-between;align-items:center;">
      <span>More Options</span>
      <button onclick="closeMoreMenu()" style="background:none;border:none;font-size:18px;color:var(--muted);cursor:pointer;line-height:1;">‚úï</button>
    </div>
    <div style="padding:8px;">
      <button onclick="backupData();closeMoreMenu();" style="width:100%;display:flex;align-items:center;gap:14px;padding:14px 12px;border:none;background:none;border-radius:10px;font-size:14px;font-weight:600;color:#1E293B;cursor:pointer;text-align:left;">
        <span style="font-size:22px;">üíæ</span>
        <div>
          <div style="font-weight:700;">Download Backup</div>
          <div style="font-size:11px;color:var(--muted);margin-top:1px;">Save all 3 CV slots as a file</div>
        </div>
      </button>
      <button onclick="document.getElementById('restore-input-mob').click();closeMoreMenu();" style="width:100%;display:flex;align-items:center;gap:14px;padding:14px 12px;border:none;background:none;border-radius:10px;font-size:14px;font-weight:600;color:#1E293B;cursor:pointer;text-align:left;">
        <span style="font-size:22px;">‚¨ÜÔ∏è</span>
        <div>
          <div style="font-weight:700;">Restore Backup</div>
          <div style="font-size:11px;color:var(--muted);margin-top:1px;">Load a previously saved backup file</div>
        </div>
      </button>
      <input type="file" id="restore-input-mob" accept=".json" style="display:none" onchange="restoreData(this)"/>
      <div style="height:1px;background:var(--border);margin:4px 0;"></div>
      <button onclick="confirmHardReset();closeMoreMenu();" style="width:100%;display:flex;align-items:center;gap:14px;padding:14px 12px;border:none;background:none;border-radius:10px;font-size:14px;font-weight:600;color:#EF4444;cursor:pointer;text-align:left;">
        <span style="font-size:22px;">üóë</span>
        <div>
          <div style="font-weight:700;">Reset Current CV</div>
          <div style="font-size:11px;color:#F87171;margin-top:1px;">Clear all data in this slot</div>
        </div>
      </button>
    </div>
  </div>
</div>
<!-- backdrop to close more menu -->
<div id="more-backdrop" onclick="closeMoreMenu()" style="display:none;position:fixed;inset:0;z-index:199;"></div>

<!-- RESET CONFIRMATION MODAL -->
<div id="reset-modal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:16px;">
  <div style="background:#fff;border-radius:16px;padding:28px 24px;max-width:340px;width:100%;box-shadow:0 24px 64px rgba(0,0,0,.3);text-align:center;">
    <div style="font-size:40px;margin-bottom:10px;">üóë</div>
    <h2 style="font-size:18px;font-weight:800;color:#1E293B;margin-bottom:8px;">Hard Reset CV?</h2>
    <p style="font-size:13px;color:#64748B;margin-bottom:20px;line-height:1.5;">This will clear <strong>all data</strong> in the current CV slot. This action cannot be undone.</p>
    <div style="display:flex;gap:10px;">
      <button onclick="closeResetModal()" style="flex:1;padding:12px;border:1.5px solid #E2E8F0;border-radius:9px;background:#F8FAFC;font-weight:700;font-size:13px;cursor:pointer;color:#64748B;">Cancel</button>
      <button onclick="hardReset()" style="flex:1;padding:12px;border:none;border-radius:9px;background:#EF4444;color:#fff;font-weight:700;font-size:13px;cursor:pointer;">Yes, Reset</button>
    </div>
  </div>
</div>

<!-- DEMO MODAL -->
<div id="demo-modal">
  <div id="demo-box">
    <div id="demo-topbar">
      <div>
        <div id="demo-title">Template</div>
        <div id="demo-subtitle"></div>
      </div>
      <button class="demo-close-btn" onclick="closeDemo()">‚úï</button>
    </div>
    <div id="demo-scroll">
      <iframe id="demo-iframe" scrolling="no"></iframe>
    </div>
    <div id="demo-footer">
      <div class="demo-nav-row">
        <button class="demo-arrow" onclick="demoPrev()">‚óÄ</button>
        <div id="demo-dots" style="display:flex;gap:8px;"></div>
        <button class="demo-arrow" onclick="demoNext()">‚ñ∂</button>
      </div>
      <button class="btn-use-tpl" onclick="selectTemplate(demoTpl);closeDemo();showToast('Template applied!')">‚úì Use This Template</button>
    </div>
  </div>
</div>

<!-- BULLET LIBRARY MODAL -->
<div id="lib-modal">
  <div id="lib-box">
    <div class="lib-handle"></div>
    <div class="lib-header">
      <h3>üìã Bullet Point Library</h3>
      <button onclick="closeLib()" style="border:none;background:none;font-size:20px;cursor:pointer;color:var(--muted);">‚úï</button>
    </div>
    <div class="lib-cats" id="lib-cats"></div>
    <div id="lib-bullets"></div>
  </div>
</div>

<!-- DOWNLOAD CODE MODAL ‚Äî Free Version -->
<div id="pay-modal">
  <div id="pay-box">

    <!-- Header -->
    <div id="pay-header">
      <div class="pay-pill"></div>
      <button class="pay-close-x" onclick="closePayModal()" aria-label="Close">&#x2715;</button>
      <div class="pay-dl-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
      </div>
      <h2>Download Your CV</h2>
      <p class="pay-sub">Your CV is ready! Get a free download code from admin to unlock it.</p>
      <div class="free-badge">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        FREE ‚Äî No Payment Required
      </div>
    </div>

    <div id="pay-body">

      <!-- Screen 1: Choose path -->
      <div id="pay-chooser">
        <p style="font-size:12px;color:#64748B;text-align:center;margin-bottom:14px;line-height:1.6;">Choose how you want to get your download code from admin:</p>
        <div class="pay-cards">
          <!-- Option A: WhatsApp admin -->
          <div class="pay-card" onclick="showUPISec()" tabindex="0">
            <div class="pay-card-ico c-green">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="#22C55E">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/>
                <path d="M12 0C5.373 0 0 5.373 0 12c0 2.099.539 4.073 1.482 5.796L0 24l6.371-1.461A11.94 11.94 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-1.885 0-3.655-.508-5.183-1.393l-.371-.22-3.781.866.896-3.683-.242-.381A9.944 9.944 0 012 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"/>
              </svg>
            </div>
            <h3>Ask Admin</h3>
            <p>Message admin on WhatsApp to get your code</p>
          </div>
          <!-- Option B: Already have code -->
          <div class="pay-card" onclick="showCodeSec()" tabindex="0">
            <div class="pay-card-ico c-teal">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0F766E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2"/>
                <path d="M7 11V7a5 5 0 0110 0v4"/>
              </svg>
            </div>
            <h3>I Have a Code</h3>
            <p>Already got your code? Enter it and download</p>
          </div>
        </div>
      </div>

      <!-- Screen 2a: WhatsApp Admin -->
      <div id="pay-upi-sec">
        <div class="wa-info-box">
          <div class="wa-info-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="#22C55E"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.099.539 4.073 1.482 5.796L0 24l6.371-1.461A11.94 11.94 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-1.885 0-3.655-.508-5.183-1.393l-.371-.22-3.781.866.896-3.683-.242-.381A9.944 9.944 0 012 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"/></svg>
            How to get your code
          </div>
          <div style="display:flex;flex-direction:column;gap:7px;">
            <div class="wa-info-step"><div class="wa-step-num">1</div><span>Click the WhatsApp button below to message admin</span></div>
            <div class="wa-info-step"><div class="wa-step-num">2</div><span>Tell admin your name and that your CV is ready</span></div>
            <div class="wa-info-step"><div class="wa-step-num">3</div><span>Admin will send you a 6-character download code</span></div>
            <div class="wa-info-step"><div class="wa-step-num">4</div><span>Come back, click "I Have a Code" and enter it to download</span></div>
          </div>
        </div>
        <button class="wa-btn" onclick="openWhatsApp()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="white">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/>
            <path d="M12 0C5.373 0 0 5.373 0 12c0 2.099.539 4.073 1.482 5.796L0 24l6.371-1.461A11.94 11.94 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-1.885 0-3.655-.508-5.183-1.393l-.371-.22-3.781.866.896-3.683-.242-.381A9.944 9.944 0 012 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"/>
          </svg>
          üí¨ Message Admin on WhatsApp
        </button>
        <div class="back-lnk" onclick="backToChooser()">&#8592; Back &nbsp;&middot;&nbsp; <span onclick="showCodeSec()" style="color:#0F766E;font-weight:700;">I already have a code</span></div>
      </div>

      <!-- Screen 2b: Enter Code -->
      <div id="pay-code-sec">

        <div class="err-box" id="err-box"></div>

        <div class="lock-box" id="lock-box">
          <div class="lock-title">Too many wrong attempts</div>
          <div class="lock-time" id="lock-timer">10:00</div>
          <div class="lock-sub">Please wait, then try again</div>
        </div>

        <div class="code-how-box">
          <div class="code-how-title">üìã How to get your code</div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <div class="code-how-step"><div class="code-how-num">1</div><span>Go back and click <strong>Ask Admin</strong></span></div>
            <div class="code-how-step"><div class="code-how-num">2</div><span>Message admin on WhatsApp to request your code</span></div>
            <div class="code-how-step"><div class="code-how-num">3</div><span>Admin sends you a 6-character code</span></div>
            <div class="code-how-step"><div class="code-how-num">4</div><span>Enter the code below and download your CV</span></div>
          </div>
        </div>

        <div class="code-dots">
          <div class="cdot" id="cd1"></div>
          <div class="cdot" id="cd2"></div>
          <div class="cdot" id="cd3"></div>
          <span class="cdot-lbl">attempts remaining</span>
        </div>

        <label class="code-lbl" for="code-field">Enter your 6-character code</label>
        <input
          class="code-field"
          id="code-field"
          maxlength="6"
          placeholder="&#xB7; &#xB7; &#xB7; &#xB7; &#xB7; &#xB7;"
          oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')"
          onkeydown="if(event.key==='Enter')doSubmitCode()"
          autocomplete="off"
          spellcheck="false"
          inputmode="text"
        />
        <div class="code-pool-hint">Enter the 6-character code sent by admin</div>

        <button class="unlock-btn" id="unlock-btn" onclick="doSubmitCode()">
          <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Download My CV
        </button>

        <div class="back-lnk" onclick="backToChooser()">
          &#8592; Back &nbsp;&middot;&nbsp;
          <span onclick="showUPISec()" style="color:#22C55E;font-weight:700;cursor:pointer;">Ask admin for code</span>
        </div>
      </div>

    </div>
  </div>
</div>



<!-- ADMIN PANEL ‚Äî open by clicking logo 5 times fast -->
<div id="admin-panel">
  <div id="admin-box" style="max-width:380px;">
    <div id="admin-header">
      <h3>üîê Admin Panel</h3>
      <button class="admin-x" onclick="closeAdmin()">&#x2715;</button>
    </div>
    <div id="admin-body">
      <div id="admin-login-sec">
        <div style="color:#475569;font-size:11.5px;text-align:center;margin-bottom:12px;">Enter admin password to continue</div>
        <input class="a-pwd" type="password" id="a-pwd" placeholder="&#9679;&#9679;&#9679;&#9679;" onkeydown="if(event.key==='Enter')doAdminLogin()"/>
        <button class="a-login" onclick="doAdminLogin()">Login</button>
        <div class="a-err" id="a-err">Wrong password. Try again.</div>
      </div>
      <div id="admin-content">
        <div class="admin-tabs">
          <button class="admin-tab active" onclick="switchAdminTab('codes',this)">üîë Codes</button>
          <button class="admin-tab" onclick="switchAdminTab('generate',this)">‚ö° Generate</button>
        </div>

        <!-- CODES TAB -->
        <div class="admin-tab-pane active" id="atab-codes">
          <div class="a-lbl">Today's Date</div>
          <div class="a-code" id="a-day">--</div>
          <div class="a-date" id="a-date-full"></div>
          <div class="a-rule">
            <b>Valid codes end in: <span id="a-eg-date" style="color:#34D399;font-size:16px;">--</span></b><br/>
            Example code: <b id="a-eg-code" style="color:#34D399;font-size:18px;letter-spacing:4px;">------</b>
          </div>
        </div>

        <!-- GENERATE TAB -->
        <div class="admin-tab-pane" id="atab-generate">
          <div class="a-lbl" style="margin-bottom:8px;">Auto-Generate Code</div>
          <div class="a-rule" style="margin-bottom:10px;">
            Give this code to users who request a download. Code is valid for <b style="color:#34D399;">today only</b>.
          </div>
          <button class="a-gen-btn" onclick="adminGenCode()">‚ö° Generate New Code</button>
          <div class="a-code-out" id="a-gen-out" style="display:none;">
            <div style="font-size:10px;color:#64748B;margin-bottom:4px;">Share this code:</div>
            <div class="a-code-big" id="a-gen-code-val">------</div>
            <button class="a-code-copy" onclick="adminCopyCode()">üìã Copy Code</button>
            <div style="font-size:10px;color:#475569;margin-top:6px;" id="a-gen-expiry"></div>
          </div>
          <div style="margin-top:12px;" class="a-rule">
            <b style="color:#94A3B8;">Recent codes given:</b>
            <div id="a-recent-codes" style="margin-top:6px;font-size:11px;color:#64748B;">‚Äì</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PRINT OVERLAY (fallback) -->
<!-- PRINT OVERLAY (fallback) -->
<div id="print-overlay">
  <style id="print-cv-styles"></style>
  <div id="print-cv-content"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COLORS = ['#0F766E','#1D4ED8','#7C3AED','#B91C1C','#C2410C','#047857','#0369A1','#6D28D9','#374151','#92400E'];
const TPL_INFO = [
  {n:'Classic',       d:'Traditional serif, clean & formal',    c:'#374151'},
  {n:'Modern Blue',   d:'Colorful header, sidebar layout',       c:'#1D4ED8'},
  {n:'Executive',     d:'Elegant centered header',               c:'#92400E'},
  {n:'Minimal',       d:'Clean whitespace-rich design',          c:'#374151'},
  {n:'Skilled Worker',d:'Bold header with skill tags',           c:'#047857'},
  {n:'Two-Column',    d:'Sidebar layout, modern look',           c:'#0369A1'},
  {n:'Government',    d:'Formal govt-style single column',       c:'#1a1a2e'},
  {n:'Creative',      d:'Bold accent, creative industries',      c:'#7C3AED'},
  {n:'ATS Clean',     d:'Plain text, ATS scanner-friendly',      c:'#374151'},
  {n:'Corporate',     d:'Corporate navy, professional feel',     c:'#1e3a5f'},
];

const BULLET_LIB = {
  'Loco/MSV Operator':['Operated MSV equipment safely in underground tunnel construction environments','Transported materials and personnel through tunnel sections following all safety protocols','Performed daily pre-operation checks, maintenance logs and safety inspections','Coordinated with tunnel engineers for smooth and timely material movement','Operated locomotive in metro rail tunnel projects using NATM method','Maintained accurate records of shift operations and equipment status','Ensured compliance with all site safety rules and PPE requirements','Managed loading and unloading of heavy construction materials in confined spaces'],
  'Gantry Crane':['Operated TBM Gantry Crane for material handling in metro and tunnel projects','Maintained precise crane movements in limited underground work spaces','Conducted routine crane maintenance and safety inspections before each shift','Coordinated lifts with site engineers to ensure safe and efficient operations','Ensured all crane operations met project safety and quality standards','Handled heavy precast segments and construction materials with precision','Documented all crane operations and reported defects to maintenance team'],
  'Driver':['Operated heavy commercial vehicles safely across long-distance routes','Maintained vehicle logs, mileage records and fuel consumption reports','Performed routine vehicle checks and reported mechanical issues promptly','Delivered goods on time with zero incidents across all assignments','Followed all traffic rules, company policies and route instructions'],
  'Construction':['Assisted in civil construction activities as per project specifications','Operated heavy machinery including excavators and concrete mixers','Followed site safety protocols and wore all mandatory PPE at all times','Worked with team to meet daily construction targets and quality standards','Assisted engineers in surveying, setting out and quality checks'],
  'Security':['Monitored premises and ensured security of property and personnel','Conducted regular patrols and logged all security incidents accurately','Managed access control and visitor entry procedures at main gate','Responded promptly to alarms, emergencies and security breaches'],
  'Sales / Marketing':['Achieved and exceeded monthly sales targets consistently','Built and maintained strong relationships with new and existing clients','Conducted product demonstrations and presentations to potential customers','Identified new business opportunities through market research'],
  'Office / Admin':['Managed daily office operations including scheduling and correspondence','Maintained accurate filing systems for physical and digital documents','Handled incoming calls, emails and visitor queries professionally','Coordinated with departments to ensure smooth workflow and communication'],
  'Accountant':['Maintained accurate books of accounts including ledgers and journals','Prepared monthly financial statements and management reports','Processed invoices, payments and bank reconciliations on time','Assisted in GST filing, TDS returns and income tax compliance'],
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentSlot = 0, currentTemplate = 2, currentColor = '#0F766E';
let currentSpacing = 'compact', currentFontSize = 12, currentNameSize = 24, currentSectionHeaderSize = 13;
let currentTopTitleSize = 14, currentSubHeaderSize = 13;
let currentFontFamily = 'default';
let photoData = null;
let jobs = [], edus = [], skills = [], certs = [], customSections = [];
let libTargetJob = 0, libTargetField = 'responsibilities';
let libActiveCat = Object.keys(BULLET_LIB)[0];
let demoTpl = 1;
let saveTimer = null, previewTimer = null;
let mobilePreviewOpen = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveSlot(slot) {
  const data = {
    personal: getFormData(),
    jobs, edus, skills, certs, customSections,
    photo: photoData,
    extras: {
      decl: document.getElementById('tog_decl')?.checked || false,
      personal: document.getElementById('tog_personal')?.checked || false,
      photo: document.getElementById('tog_photo')?.checked !== false,
      father: document.getElementById('tog_father')?.checked !== false,
    },
    template: currentTemplate,
    color: currentColor,
    spacing: currentSpacing,
    fontSize: currentFontSize,
    nameSize: currentNameSize,
    sectionHeaderSize: currentSectionHeaderSize,
    topTitleSize: currentTopTitleSize,
    subHeaderSize: currentSubHeaderSize,
    typoPreset: currentTypoPreset,
    fontFamily: currentFontFamily,
  };
  try { localStorage.setItem('cv_slot_' + slot, JSON.stringify(data)); } catch(e) {}
}

function loadSlot(slot) {
  currentSlot = +slot;
  document.getElementById('slot-select').value = slot;
  try {
    const raw = localStorage.getItem('cv_slot_' + slot);
    if (raw) {
      const d = JSON.parse(raw);
      fillForm(d.personal || {});
      jobs = d.jobs || [{title:'',company:'',location:'',start:'',end:'',current:false,type:'Full-time',responsibilities:['']}];
      edus = d.edus || [{degree:'',institution:'',location:'',startYear:'',endYear:'',grade:''}];
      skills = d.skills || [{name:'',level:'Advanced'}];
      certs = d.certs || [];
      // Load custom sections + migrate old 'entries' structure to new 'items' structure
      customSections = (d.customSections || []).map(sec => {
        if (sec.items) return sec; // already new format
        // Migrate old format: entries:[{subTitle,org,location,start,end,current,bullets}]
        const items = (sec.entries || []).map(e => ({
          name:    e.subTitle || '',
          detail:  (e.org||'') + (e.org && e.location ? ', ' : '') + (e.location||''),
          dates:   e.start ? (e.start + (e.end||e.current?' ‚Äì ':'') + (e.current?'Present':(e.end||''))) : (e.end||''),
          bullets: e.bullets || ['']
        }));
        return { id:sec.id, title:sec.title||'', items:items.length ? items : [{name:'',detail:'',dates:'',bullets:['']}] };
      });
      photoData = d.photo || null;
      currentTemplate = d.template || 2;
      currentColor = d.color || '#0F766E';
      currentSpacing = d.spacing || 'compact';
      currentFontSize = d.fontSize || 12;
      currentNameSize = d.nameSize || 24;
      currentSectionHeaderSize = d.sectionHeaderSize || 13;
      currentTopTitleSize = d.topTitleSize || 14;
      currentSubHeaderSize = d.subHeaderSize || 13;
      currentTypoPreset = d.typoPreset || 'professional';
      currentFontFamily = d.fontFamily || 'default';
      if (d.extras) {
        const tog_decl = document.getElementById('tog_decl');
        const tog_personal = document.getElementById('tog_personal');
        const tog_photo = document.getElementById('tog_photo');
        const tog_father = document.getElementById('tog_father');
        if (tog_decl) tog_decl.checked = d.extras.decl || false;
        if (tog_personal) tog_personal.checked = d.extras.personal || false;
        if (tog_photo) tog_photo.checked = d.extras.photo !== false;
        if (tog_father) tog_father.checked = d.extras.father !== false;
      }
    } else {
      resetState();
    }
  } catch(e) { resetState(); }
  applyColor(currentColor, false);
  setSpacingBtn(currentSpacing);
  syncTemplateUI();
  const fs = document.getElementById('font-size-slider');
  if (fs) fs.value = currentFontSize;
  const bodyInput = document.getElementById('fs-body');
  if (bodyInput) bodyInput.value = currentFontSize;
  const nmInput = document.getElementById('fs-name');
  if (nmInput) nmInput.value = currentNameSize;
  const shInput = document.getElementById('fs-section');
  if (shInput) shInput.value = currentSectionHeaderSize;
  const ttInput = document.getElementById('fs-toptitle');
  if (ttInput) ttInput.value = currentTopTitleSize;
  const subInput = document.getElementById('fs-subheader');
  if (subInput) subInput.value = currentSubHeaderSize;
  syncTypoPresetUI();
  syncFontFamilyUI();
  syncCustomSectionsToLayout();
  renderAll();
  renderCustomSections();
  updatePhotoUI();
  schedulePreview();
}

function resetState() {
  jobs = [{title:'',company:'',location:'',start:'',end:'',current:false,type:'Full-time',responsibilities:['']}];
  edus = [{degree:'',institution:'',location:'',startYear:'',endYear:'',grade:''}];
  skills = [{name:'',level:'Advanced'}];
  certs = [];
  customSections = [];
  photoData = null;
  currentTemplate = 2; currentColor = '#0F766E'; currentSpacing = 'compact'; currentFontSize = 12;
  currentNameSize = 24; currentSectionHeaderSize = 13; currentTopTitleSize = 14; currentSubHeaderSize = 13;
  currentTypoPreset = 'professional';
  fillForm({});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CUSTOM SECTIONS
// Structure: [{id, title, items:[{name, detail, dates, bullets:[]}]}]
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function csBlankItem() {
  return { name:'', detail:'', dates:'', bullets:[''] };
}

function addCustomSection() {
  const id = 'custom_' + Date.now();
  customSections.push({ id, title:'', items:[csBlankItem()] });
  pageLayout.push({ id, label:'Custom: (New)', icon:'‚ú®', page:1 });
  renderCustomSections();
  renderPageLayout();
  // CRITICAL: save page layout so this section persists on reload
  try { localStorage.setItem('cv_page_layout', JSON.stringify(pageLayout)); } catch(e){}
  autoSave();
  schedulePreview();
}

function removeCustomSection(si) {
  const sec = customSections[si];
  if (sec) {
    const pIdx = pageLayout.findIndex(p => p.id === sec.id);
    if (pIdx >= 0) pageLayout.splice(pIdx, 1);
  }
  customSections.splice(si, 1);
  renderCustomSections();
  renderPageLayout();
  // CRITICAL: update saved page layout after removal
  try { localStorage.setItem('cv_page_layout', JSON.stringify(pageLayout)); } catch(e){}
  autoSave();
  schedulePreview();
}

function addCustomItem(si) {
  customSections[si].items.push(csBlankItem());
  renderCustomSections();
  setTimeout(() => {
    const inputs = document.querySelectorAll('#csi-'+si+' .csi-name');
    if (inputs.length) inputs[inputs.length-1].focus();
  }, 60);
}

function removeCustomItem(si, ii) {
  customSections[si].items.splice(ii, 1);
  if (!customSections[si].items.length) customSections[si].items = [csBlankItem()];
  renderCustomSections();
  autoSave();
}

function addCustomBullet(si, ii) {
  customSections[si].items[ii].bullets.push('');
  renderCustomSections();
  setTimeout(() => {
    const rows = document.querySelectorAll('#csb-'+si+'-'+ii+' .bullet-row input');
    if (rows.length) rows[rows.length-1].focus();
  }, 60);
}

function removeCustomBullet(si, ii, bi) {
  customSections[si].items[ii].bullets.splice(bi, 1);
  if (!customSections[si].items[ii].bullets.length) customSections[si].items[ii].bullets = [''];
  renderCustomSections();
  autoSave();
}

function updateCSTitle(si, val) {
  customSections[si].title = val;
  const p = pageLayout.find(p => p.id === customSections[si].id);
  if (p) p.label = 'Custom: ' + (val || '(New)');
  // Update saved page layout label
  try { localStorage.setItem('cv_page_layout', JSON.stringify(pageLayout)); } catch(e){}
  renderPageLayout();
  autoSave();
}

function updateCSItem(si, ii, field, val) {
  customSections[si].items[ii][field] = val;
  autoSave();
}

function updateCSBullet(si, ii, bi, val) {
  customSections[si].items[ii].bullets[bi] = val;
  autoSave();
}

function moveCustomSection(si, dir) {
  const ni = si + dir;
  if (ni < 0 || ni >= customSections.length) return;
  [customSections[si], customSections[ni]] = [customSections[ni], customSections[si]];
  renderCustomSections();
  autoSave();
}

function moveCustomItem(si, ii, dir) {
  const ni = ii + dir;
  if (ni < 0 || ni >= customSections[si].items.length) return;
  [customSections[si].items[ii], customSections[si].items[ni]] = [customSections[si].items[ni], customSections[si].items[ii]];
  renderCustomSections();
  autoSave();
}

function renderCustomSections() {
  const c = document.getElementById('custom-sections-container');
  if (!c) return;
  if (!customSections.length) { c.innerHTML = ''; return; }
  c.innerHTML = customSections.map((sec, si) => `
    <div class="entry-block" id="csi-${si}" style="border-left:3px solid var(--primary);">
      <div class="entry-header">
        <span class="entry-num">‚ú® Section #${si+1}${sec.title ? ' ‚Äî '+esc(sec.title) : ''}</span>
        <div class="entry-actions">
          ${si>0?`<button class="icon-btn" onclick="moveCustomSection(${si},-1)">‚Üë</button>`:''}
          ${si<customSections.length-1?`<button class="icon-btn" onclick="moveCustomSection(${si},1)">‚Üì</button>`:''}
          <button class="icon-btn danger" onclick="removeCustomSection(${si})">‚úï</button>
        </div>
      </div>

      <div class="field">
        <label>Section Heading <span class="req">*</span></label>
        <input type="text" class="csi-title" placeholder="e.g. Interests ¬∑ Hobbies ¬∑ Languages ¬∑ Projects ¬∑ Awards‚Ä¶"
          value="${esc(sec.title)}"
          oninput="updateCSTitle(${si},this.value)"
          style="font-weight:700;font-size:14px;"/>
      </div>

      ${sec.items.map((item, ii) => `
        <div class="entry-block" style="background:#F8FAFC;margin-bottom:8px;border:1px solid #E2E8F0;">
          <div class="entry-header">
            <span class="entry-num" style="font-size:11px;">Item #${ii+1}${item.name?' ‚Äî '+esc(item.name):''}</span>
            <div class="entry-actions">
              ${ii>0?`<button class="icon-btn" onclick="moveCustomItem(${si},${ii},-1)">‚Üë</button>`:''}
              ${ii<sec.items.length-1?`<button class="icon-btn" onclick="moveCustomItem(${si},${ii},1)">‚Üì</button>`:''}
              ${sec.items.length>1?`<button class="icon-btn danger" onclick="removeCustomItem(${si},${ii})">‚úï</button>`:''}
            </div>
          </div>

          <div class="g2">
            <div class="field">
              <label>Title / Name <span style="color:var(--primary);font-size:10px;">(shows on CV)</span></label>
              <input type="text" class="csi-name" placeholder="e.g. Reading ¬∑ Cricket ¬∑ React.js ¬∑ Best Employee"
                value="${esc(item.name)}"
                oninput="updateCSItem(${si},${ii},'name',this.value)"
                onblur="autoSave()"/>
            </div>
            <div class="field">
              <label>Organisation / Context</label>
              <input type="text" placeholder="e.g. Google ¬∑ IIT Bombay ¬∑ Self-Taught"
                value="${esc(item.detail)}"
                oninput="updateCSItem(${si},${ii},'detail',this.value)"
                onblur="autoSave()"/>
            </div>
          </div>

          <div class="field">
            <label>Dates / Period <span style="color:var(--muted);font-size:10px;">(optional)</span></label>
            <input type="text" placeholder="e.g. Jan 2022 ‚Äì Present ¬∑ 2020 ¬∑ Ongoing"
              value="${esc(item.dates)}"
              oninput="updateCSItem(${si},${ii},'dates',this.value)"
              onblur="autoSave()"/>
          </div>

          <div class="bullet-wrap" id="csb-${si}-${ii}">
            <div class="bullet-label">
              <span>Details / Bullet Points <span style="color:var(--muted);font-size:10px;">(optional)</span></span>
              <button class="suggest-btn" onclick="addCustomBullet(${si},${ii})">+ Add Line</button>
            </div>
            ${item.bullets.map((b,bi) => `
              <div class="bullet-row">
                <input type="text" placeholder="Add a detail about this item‚Ä¶"
                  value="${esc(b)}"
                  oninput="updateCSBullet(${si},${ii},${bi},this.value)"
                  onblur="autoSave()"/>
                ${item.bullets.length>1?`<button class="bullet-del" onclick="removeCustomBullet(${si},${ii},${bi})">‚úï</button>`:''}
              </div>`).join('')}
          </div>
        </div>`).join('')}

      <button class="add-entry-btn" onclick="addCustomItem(${si})">+ Add Item</button>
    </div>`).join('');
}

function syncCustomSectionsToLayout() {
  // Remember previously saved page values for custom sections
  const savedPages = {};
  pageLayout.forEach(p => { if (p.id.startsWith('custom_')) savedPages[p.id] = p.page; });
  // Remove all existing custom_ entries
  for (let i = pageLayout.length-1; i >= 0; i--) {
    if (pageLayout[i].id.startsWith('custom_')) pageLayout.splice(i,1);
  }
  const insertBefore = pageLayout.findIndex(p => p.id === 'personal');
  customSections.forEach(sec => {
    const savedPage = savedPages[sec.id] || 1;
    const entry = { id:sec.id, label:'Custom: '+(sec.title||'(New)'), icon:'‚ú®', page:savedPage };
    if (insertBefore >= 0) pageLayout.splice(insertBefore, 0, entry);
    else pageLayout.push(entry);
  });
}

function autoSave() {
  schedulePreview();
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => saveSlot(currentSlot), 600);
}

function backupData() {
  saveSlot(currentSlot);
  const allData = {};
  for (let i = 0; i < 3; i++) {
    try { allData['slot_'+i] = JSON.parse(localStorage.getItem('cv_slot_'+i)||'{}'); } catch(e){}
  }
  const blob = new Blob([JSON.stringify(allData,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'cv-backup-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  showToast('Backup downloaded!');
}

function restoreData(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const d = JSON.parse(e.target.result);
      for (let i = 0; i < 3; i++) {
        if (d['slot_'+i]) localStorage.setItem('cv_slot_'+i, JSON.stringify(d['slot_'+i]));
      }
      loadSlot(currentSlot);
      showToast('Data restored!');
    } catch(err) { showToast('Invalid backup file'); }
  };
  reader.readAsText(file);
  input.value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORM DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getFormData() {
  return {
    name: v('p_name'), father: v('p_father'), title: v('p_title'),
    phone: v('p_phone'), email: v('p_email'), location: v('p_location'), linkedin: v('p_linkedin'),
    dob: v('p_dob'), nation: v('p_nation'), marital: v('p_marital'),
    religion: v('p_religion'), lang: v('p_lang'),
    passport: v('p_passport'), passport_exp: v('p_passport_exp'),
    summary: v('p_summary'),
  };
}

function fillForm(d) {
  if (!d) d = {};
  setv('p_name', d.name); setv('p_father', d.father); setv('p_title', d.title);
  setv('p_phone', d.phone); setv('p_email', d.email); setv('p_location', d.location); setv('p_linkedin', d.linkedin);
  setv('p_dob', d.dob); setv('p_nation', d.nation); setv('p_marital', d.marital);
  setv('p_religion', d.religion); setv('p_lang', d.lang);
  setv('p_passport', d.passport); setv('p_passport_exp', d.passport_exp);
  setv('p_summary', d.summary);
  updateSummaryCount();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const pg = document.getElementById('page-' + id);
  if (pg) pg.classList.add('active');
  if (id === 'extras') setTimeout(renderPageLayout, 60);
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === id));
  document.querySelectorAll('.bnav-item').forEach(n => {
    n.classList.remove('active');
    if (n.dataset.page === id) n.classList.add('active');
  });
  if (mobilePreviewOpen) { toggleMobilePreview(); }
  if (id === 'design') { renderColorGrid(); renderTemplateGrid(); }
  window.scrollTo(0, 0);
}

function toggleCard(header) {
  const body = header.nextElementSibling;
  const chev = header.querySelector('.chevron');
  if (body) body.classList.toggle('collapsed');
  if (chev) chev.classList.toggle('up');
}

function toggleMobilePreview() {
  mobilePreviewOpen = !mobilePreviewOpen;
  const page = document.getElementById('preview-page');
  const btn = document.getElementById('bnav-preview');
  if (page) page.classList.toggle('show', mobilePreviewOpen);
  if (btn) btn.classList.toggle('active', mobilePreviewOpen);
  if (mobilePreviewOpen) { renderPreviewFull(); scaleMobilePreview(); }
}

function scaleMobilePreview() {
  const wrap = document.getElementById('preview-scaled-wrap');
  const scrollArea = document.getElementById('preview-scroll-area');
  if (!wrap || !scrollArea) return;
  const availW = window.innerWidth;
  const scale = Math.min((availW - 16) / 595, 1);
  wrap.style.transform = `scale(${scale})`;
  const scaledH = Math.ceil(842 * scale);
  wrap.style.marginBottom = `-${842 - scaledH}px`;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER FORMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll() { renderJobs(); renderEdus(); renderSkills(); renderCerts(); renderCustomSections(); }

function renderJobs() {
  const c = document.getElementById('jobs-container');
  if (!c) return;
  c.innerHTML = '';
  jobs.forEach((j, ji) => {
    const d = document.createElement('div');
    d.className = 'entry-block';
    d.innerHTML = `
      <div class="entry-header">
        <span class="entry-num">üíº Job #${ji+1}${j.company ? ' ‚Äî ' + esc(j.company) : ''}</span>
        <div class="entry-actions">
          ${ji > 0 ? `<button class="icon-btn" onclick="moveJob(${ji},-1)" title="Move Up">‚Üë</button>` : ''}
          ${ji < jobs.length-1 ? `<button class="icon-btn" onclick="moveJob(${ji},1)" title="Move Down">‚Üì</button>` : ''}
          ${jobs.length > 1 ? `<button class="icon-btn danger" onclick="removeJob(${ji})">‚úï</button>` : ''}
        </div>
      </div>
      <div class="g2">
        <div class="field"><label>Job Title</label><input value="${esc(j.title)}" placeholder="Loco Motive Operator" oninput="jobs[${ji}].title=this.value;updateEntryHeader(this,${ji});autoSave()"/></div>
        <div class="field"><label>Company Name</label><input value="${esc(j.company)}" placeholder="Company Pvt Ltd" oninput="jobs[${ji}].company=this.value;updateEntryHeader(this,${ji});autoSave()"/></div>
      </div>
      <div class="g2">
        <div class="field"><label>Location</label><input value="${esc(j.location)}" placeholder="Chennai, Tamil Nadu" oninput="jobs[${ji}].location=this.value;autoSave()"/></div>
        <div class="field"><label>Job Type</label>
          <select onchange="jobs[${ji}].type=this.value;autoSave()">
            ${['Full-time','Part-time','Contract','Freelance'].map(t=>`<option ${(j.type||'Full-time')===t?'selected':''}>${t}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="g2">
        <div class="field"><label>Start Date</label><input value="${esc(j.start)}" placeholder="Aug 2022" oninput="jobs[${ji}].start=this.value;autoSave()"/></div>
        <div class="field"><label>End Date</label><input value="${esc(j.end)}" placeholder="Present" ${j.current?'disabled':''} oninput="jobs[${ji}].end=this.value;autoSave()"/></div>
      </div>
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:12px;cursor:pointer;">
        <input type="checkbox" ${j.current?'checked':''} onchange="jobs[${ji}].current=this.checked;this.closest('.entry-block').querySelectorAll('input')[5].disabled=this.checked;if(this.checked){jobs[${ji}].end='';this.closest('.entry-block').querySelectorAll('input')[5].value='';}autoSave()"/>
        <span style="font-weight:500;">Currently working here</span>
      </label>
      <div class="bullet-wrap">
        <div class="bullet-label">
          <span>Responsibilities</span>
          <button class="suggest-btn" onclick="openLib(${ji},'responsibilities')">üìã Suggestions</button>
        </div>
        <div id="resp_${ji}">
          ${j.responsibilities.map((r,ri)=>`
            <div class="bullet-row">
              <input value="${esc(r)}" placeholder="What did you do in this job..." oninput="jobs[${ji}].responsibilities[${ri}]=this.value;autoSave()"/>
              ${j.responsibilities.length>1?`<button class="bullet-del" onclick="removeResp(${ji},${ri})">‚úï</button>`:''}
            </div>`).join('')}
        </div>
        <button class="add-bullet-btn" onclick="addResp(${ji})">+ Add Point</button>
      </div>`;
    c.appendChild(d);
  });
}

function updateEntryHeader(input, ji) {
  const block = input.closest('.entry-block');
  if (!block) return;
  const h = block.querySelector('.entry-num');
  if (h) h.textContent = `üíº Job #${ji+1}${jobs[ji].company ? ' ‚Äî ' + jobs[ji].company : ''}`;
}

function addJob() { jobs.push({title:'',company:'',location:'',start:'',end:'',current:false,type:'Full-time',responsibilities:['']}); renderJobs(); autoSave(); }
function removeJob(i) { jobs.splice(i,1); renderJobs(); autoSave(); }
function moveJob(i,dir) { const t=jobs[i];jobs[i]=jobs[i+dir];jobs[i+dir]=t; renderJobs(); autoSave(); }
function addResp(ji) { jobs[ji].responsibilities.push(''); renderJobs(); autoSave(); }
function removeResp(ji,ri) { jobs[ji].responsibilities.splice(ri,1); renderJobs(); autoSave(); }

function renderEdus() {
  const c = document.getElementById('edu-container');
  if (!c) return;
  c.innerHTML = '';
  edus.forEach((e, ei) => {
    const d = document.createElement('div');
    d.className = 'entry-block';
    d.innerHTML = `
      <div class="entry-header">
        <span class="entry-num">üéì Education #${ei+1}${e.institution ? ' ‚Äî ' + esc(e.institution) : ''}</span>
        <div class="entry-actions">
          ${edus.length>1?`<button class="icon-btn danger" onclick="removeEdu(${ei})">‚úï</button>`:''}
        </div>
      </div>
      <div class="g2">
        <div class="field"><label>Degree / Class</label><input value="${esc(e.degree)}" placeholder="Class 6th / B.Tech" oninput="edus[${ei}].degree=this.value;autoSave()"/></div>
        <div class="field"><label>Institution Name</label><input value="${esc(e.institution)}" placeholder="School / College" oninput="edus[${ei}].institution=this.value;autoSave()"/></div>
      </div>
      <div class="g3">
        <div class="field"><label>Location</label><input value="${esc(e.location)}" placeholder="City" oninput="edus[${ei}].location=this.value;autoSave()"/></div>
        <div class="field"><label>Year From</label><input value="${esc(e.startYear)}" placeholder="2008" oninput="edus[${ei}].startYear=this.value;autoSave()"/></div>
        <div class="field"><label>Year To</label><input value="${esc(e.endYear)}" placeholder="2015" oninput="edus[${ei}].endYear=this.value;autoSave()"/></div>
      </div>
      <div class="field"><label>Grade / Percentage</label><input value="${esc(e.grade)}" placeholder="89% / 8.5 CGPA" oninput="edus[${ei}].grade=this.value;autoSave()"/></div>`;
    c.appendChild(d);
  });
}
function addEdu() { edus.push({degree:'',institution:'',location:'',startYear:'',endYear:'',grade:''}); renderEdus(); autoSave(); }
function removeEdu(i) { edus.splice(i,1); renderEdus(); autoSave(); }

function renderSkills() {
  const c = document.getElementById('skills-container');
  if (!c) return;
  c.innerHTML = '';
  skills.forEach((sk, si) => {
    const d = document.createElement('div');
    d.style.cssText = 'display:flex;gap:8px;margin-bottom:8px;align-items:center;';
    d.innerHTML = `
      <input value="${esc(sk.name)}" placeholder="e.g. MSV Operation" style="flex:2;padding:10px 12px;border:1.5px solid var(--border);border-radius:9px;font-size:13px;outline:none;font-family:var(--font);background:#fff;" oninput="skills[${si}].name=this.value;autoSave()"/>
      <select style="flex:1;padding:10px 8px;border:1.5px solid var(--border);border-radius:9px;font-size:12px;outline:none;background:#fff;" onchange="skills[${si}].level=this.value;autoSave()">
        ${['Beginner','Intermediate','Advanced','Expert'].map(l=>`<option ${sk.level===l?'selected':''}>${l}</option>`).join('')}
      </select>
      ${skills.length>1?`<button class="bullet-del" onclick="removeSkill(${si})">‚úï</button>`:''}`;
    c.appendChild(d);
  });
}
function addSkill() { skills.push({name:'',level:'Advanced'}); renderSkills(); autoSave(); }
function removeSkill(i) { skills.splice(i,1); renderSkills(); autoSave(); }

function renderCerts() {
  const c = document.getElementById('certs-container');
  if (!c) return;
  c.innerHTML = '';
  certs.forEach((cert, ci) => {
    const d = document.createElement('div');
    d.className = 'entry-block';
    d.innerHTML = `
      <div class="entry-header">
        <span class="entry-num">üìú Certificate #${ci+1}</span>
        ${certs.length>1?`<button class="icon-btn danger" onclick="removeCert(${ci})">‚úï</button>`:''}
      </div>
      <div class="g2">
        <div class="field"><label>Certificate Name</label><input value="${esc(cert.name)}" placeholder="Safety Certification" oninput="certs[${ci}].name=this.value;autoSave()"/></div>
        <div class="field"><label>Issued By</label><input value="${esc(cert.issuedBy)}" placeholder="Organization" oninput="certs[${ci}].issuedBy=this.value;autoSave()"/></div>
        <div class="field"><label>Year</label><input value="${esc(cert.year)}" placeholder="2022" oninput="certs[${ci}].year=this.value;autoSave()"/></div>
      </div>`;
    c.appendChild(d);
  });
}
function addCert() { certs.push({name:'',issuedBy:'',year:''}); renderCerts(); autoSave(); }
function removeCert(i) { certs.splice(i,1); renderCerts(); autoSave(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DESIGN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderColorGrid() {
  const c = document.getElementById('color-grid');
  if (!c) return;
  c.innerHTML = COLORS.map(col => `<div class="color-dot ${col===currentColor?'active':''}" style="background:${col}" onclick="applyColor('${col}',true)" title="${col}"></div>`).join('')
    + `<input type="color" id="custom-color" value="${currentColor}" onchange="applyColor(this.value,true)" title="Custom color"/>`;
}

function applyColor(col, save) {
  currentColor = col;
  document.documentElement.style.setProperty('--primary', col);
  document.documentElement.style.setProperty('--primary-dark', col);
  document.documentElement.style.setProperty('--primary-light', hexToLight(col));
  renderColorGrid();
  if (save) autoSave();
}

function hexToLight(hex) {
  try {
    const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
    return `rgba(${r},${g},${b},0.12)`;
  } catch(e) { return 'rgba(15,118,110,0.12)'; }
}

function renderTemplateGrid() {
  const g = document.getElementById('tpl-grid');
  if (!g) return;
  g.innerHTML = TPL_INFO.map((t,i) => `
    <div class="tpl-card ${currentTemplate===i+1?'active':''}" onclick="selectTemplate(${i+1})">
      <div class="tpl-bar" style="background:${t.c}"></div>
      <div class="tpl-name">${t.n}</div>
      <div class="tpl-desc">${t.d}</div>
      <span class="tpl-demo-tag" onclick="event.stopPropagation();openDemo(${i+1})">üëÅ Demo</span>
    </div>`).join('');
}

function selectTemplate(n) {
  currentTemplate = n;
  syncTemplateUI();
  autoSave();
  showToast('Template changed!');
}

function syncTemplateUI() {
  document.querySelectorAll('.tpl-card').forEach((c,i) => c.classList.toggle('active', i+1===currentTemplate));
}

function setSpacing(s) { currentSpacing=s; setSpacingBtn(s); autoSave(); }
function setSpacingBtn(s) {
  ['compact','normal','spacious'].forEach(x => {
    const btn = document.getElementById('sp-'+x);
    if (btn) btn.classList.toggle('active', x===s);
  });
}
function updateDesign() {
  const el = document.getElementById('font-size-slider');
  if (el) currentFontSize = parseFloat(el.value);
  const bodyInput = document.getElementById('fs-body');
  if (bodyInput) { bodyInput.value = currentFontSize; }
  autoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TYPOGRAPHY PRESETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TYPO_PRESETS = {
  // ‚îÄ‚îÄ‚îÄ Body 12pt = MS Word standard. Hierarchy: Name > TopTitle > Section > SubHeader > Body
  professional: { name:24,  topTitle:14,   section:13,   subHeader:13,   body:12   },  // DEFAULT ‚Äî Word 12pt
  compact:      { name:20,  topTitle:12,   section:11,   subHeader:11,   body:10   },  // Tight, 1-page friendly
  bold:         { name:28,  topTitle:15,   section:14,   subHeader:13.5, body:12.5 },  // Strong visual impact
  executive:    { name:27,  topTitle:15,   section:14,   subHeader:14,   body:13   },  // Senior roles, spacious
  ultra:        { name:18,  topTitle:11,   section:10,   subHeader:10.5, body:9    },  // Ultra compact, max content
};

let currentTypoPreset = 'professional';

function applyTypoPreset(presetKey) {
  const p = TYPO_PRESETS[presetKey];
  if (!p) return;
  currentTypoPreset = presetKey;

  // Apply to globals
  currentNameSize          = p.name;
  currentTopTitleSize      = p.topTitle;
  currentSectionHeaderSize = p.section;
  currentSubHeaderSize     = p.subHeader;
  currentFontSize          = p.body;

  // Sync hidden inputs (for save/load)
  const setHidden = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
  setHidden('fs-name',      p.name);
  setHidden('fs-toptitle',  p.topTitle);
  setHidden('fs-section',   p.section);
  setHidden('fs-subheader', p.subHeader);
  setHidden('fs-body',      p.body);

  // Sync Design page slider
  const slider = document.getElementById('font-size-slider');
  if (slider) slider.value = p.body;

  // Update active UI state
  document.querySelectorAll('.typo-preset').forEach(el => el.classList.remove('active'));
  const active = document.getElementById('typo-' + presetKey);
  if (active) active.classList.add('active');

  autoSave();
}

function syncTypoPresetUI() {
  document.querySelectorAll('.typo-preset').forEach(el => el.classList.remove('active'));
  const active = document.getElementById('typo-' + currentTypoPreset);
  if (active) active.classList.add('active');
}

// ‚îÄ‚îÄ FONT FAMILY MAP ‚îÄ‚îÄ
const FONT_FAMILY_MAP = {
  'default':    { css: "Georgia, 'Times New Roman', serif", label: 'Default' },
  'playfair':   { css: "'Playfair Display', Georgia, serif", label: 'Playfair Display' },
  'montserrat': { css: "'Montserrat', 'Helvetica Neue', sans-serif", label: 'Montserrat' },
  'raleway':    { css: "'Raleway', 'Helvetica Neue', sans-serif", label: 'Raleway' },
  'garamond':   { css: "'EB Garamond', Georgia, serif", label: 'EB Garamond' },
  'josefin':    { css: "'Josefin Sans', Arial, sans-serif", label: 'Josefin Sans' },
  'nunito':     { css: "'Nunito Sans', Arial, sans-serif", label: 'Nunito Sans' },
  'cormorant':  { css: "'Cormorant Garamond', Georgia, serif", label: 'Cormorant Garamond' },
  'lato':       { css: "'Lato', 'Helvetica Neue', sans-serif", label: 'Lato' }
};

function applyFontFamily(key) {
  currentFontFamily = key;
  // Update active state in UI
  document.querySelectorAll('.font-card').forEach(el => el.classList.remove('active'));
  const active = document.getElementById('ff-' + key);
  if (active) active.classList.add('active');
  autoSave();
  schedulePreview();
}

function syncFontFamilyUI() {
  document.querySelectorAll('.font-card').forEach(el => el.classList.remove('active'));
  const active = document.getElementById('ff-' + (currentFontFamily || 'default'));
  if (active) active.classList.add('active');
}

function updateFontSizes() {
  // Read from hidden inputs (used when loading saved data)
  const get = (id, fallback) => { const el = document.getElementById(id); return el ? (parseFloat(el.value)||fallback) : fallback; };
  currentNameSize          = get('fs-name',      24);
  currentTopTitleSize      = get('fs-toptitle',  14);
  currentSectionHeaderSize = get('fs-section',   13);
  currentSubHeaderSize     = get('fs-subheader', 13);
  currentFontSize          = get('fs-body',       12);
  const slider = document.getElementById('font-size-slider');
  if (slider) slider.value = currentFontSize;
  autoSave();
}

function stepFontSize(inputId, delta) {
  // Keep for compatibility, no-op now
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTO HANDLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handlePhoto(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      const MAX = 400;
      let w = img.width, h = img.height;
      if (w > MAX || h > MAX) { const ratio = Math.min(MAX/w, MAX/h); w = Math.round(w*ratio); h = Math.round(h*ratio); }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, 0, 0, w, h);
      photoData = canvas.toDataURL('image/jpeg', 0.92);
      updatePhotoUI();
      autoSave();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
  input.value = '';
}

function removePhoto() { photoData = null; updatePhotoUI(); autoSave(); }

function updatePhotoUI() {
  const zone = document.getElementById('photo-zone');
  if (!zone) return;
  const existing = zone.querySelector('img');
  if (existing) existing.remove();
  const ph = zone.querySelector('.photo-placeholder');
  if (photoData) {
    const img = document.createElement('img');
    img.src = photoData;
    zone.insertBefore(img, zone.firstChild);
    if (ph) ph.style.display = 'none';
  } else {
    if (ph) ph.style.display = '';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO SUMMARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function autoGenSummary() {
  const name = v('p_name') || 'the applicant';
  const title = v('p_title') || 'professional';
  const validJobs = jobs.filter(j => j.company);
  const years = validJobs.length > 0 ? `${validJobs.length * 2}+` : 'several';
  const loc = v('p_location') || 'India';
  const skillList = skills.filter(s => s.name).slice(0,3).map(s => s.name).join(', ');
  const summary = `Experienced ${title} with ${years} years of hands-on experience in the field. Proven track record of delivering quality work across multiple organizations${loc ? ' in ' + loc : ''}. ${skillList ? 'Key skills include ' + skillList + '.' : ''} Known for reliability, attention to safety protocols, and strong teamwork. Available for immediate joining and open to relocation.`;
  setv('p_summary', summary);
  autoSave();
  updateSummaryCount();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CV STRENGTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStrengthScore() {
  const d = getFormData();
  const checks = [
    {label:'Name added',done:!!d.name,pts:8},
    {label:'Phone & Email',done:!!(d.phone&&d.email),pts:8},
    {label:'Location added',done:!!d.location,pts:5},
    {label:'Job title added',done:!!d.title,pts:7},
    {label:'Profile photo',done:!!photoData,pts:5},
    {label:'Summary written',done:!!(d.summary&&d.summary.length>30),pts:12},
    {label:'Work experience',done:jobs.some(j=>j.company),pts:15},
    {label:'2+ job entries',done:jobs.filter(j=>j.company).length>=2,pts:8},
    {label:'Job responsibilities',done:jobs.some(j=>j.responsibilities.some(r=>r.trim())),pts:10},
    {label:'Education added',done:edus.some(e=>e.institution),pts:8},
    {label:'5+ skills listed',done:skills.filter(s=>s.name).length>=5,pts:8},
    {label:'LinkedIn added',done:!!d.linkedin,pts:4},
    {label:'Certifications',done:certs.some(c=>c.name),pts:2},
  ];
  const total = checks.reduce((a,c) => a+(c.done?c.pts:0), 0);
  const maxTotal = checks.reduce((a,c) => a+c.pts, 0);
  const score = Math.round((total/maxTotal)*100);
  const el = document.getElementById('score-num');
  const fill = document.getElementById('score-fill');
  const items = document.getElementById('score-items');
  if (!el) return;
  el.textContent = score;
  const col = score>=80?'#22C55E':score>=50?'#F59E0B':'#EF4444';
  el.style.color = col;
  if (fill) { fill.style.width = score+'%'; fill.style.background = col; }
  if (items) {
    items.innerHTML = checks.map(c => `
      <div class="score-item">
        <div class="score-dot" style="background:${c.done?'#22C55E':'#E2E8F0'}"></div>
        <span style="flex:1;color:${c.done?'var(--text)':'var(--muted)'}">${c.label}</span>
        <span style="font-size:11px;font-weight:700;color:${c.done?'var(--primary)':'var(--muted)'}">+${c.pts}</span>
      </div>`).join('');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BULLET LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openLib(ji, field) {
  libTargetJob = ji; libTargetField = field;
  renderLibCats(); renderLibBullets();
  document.getElementById('lib-modal').classList.add('show');
}
function closeLib() { const el = document.getElementById('lib-modal'); if (el) el.classList.remove('show'); }
function renderLibCats() {
  const c = document.getElementById('lib-cats');
  if (!c) return;
  c.innerHTML = Object.keys(BULLET_LIB).map(cat =>
    `<div class="lib-cat ${cat===libActiveCat?'active':''}" onclick="libSetCat('${cat}')">${cat}</div>`).join('');
}
function libSetCat(cat) { libActiveCat = cat; renderLibCats(); renderLibBullets(); }
function renderLibBullets() {
  const c = document.getElementById('lib-bullets');
  if (!c) return;
  c.innerHTML = (BULLET_LIB[libActiveCat]||[]).map(b =>
    `<div class="lib-bullet" onclick="addLibBullet(${JSON.stringify(b)})">
      <span class="lib-bullet-text">${s(b)}</span>
      <span class="lib-add-icon">+</span>
    </div>`).join('');
}
function addLibBullet(text) {
  if (libTargetJob >= 0 && libTargetJob < jobs.length) {
    if (!jobs[libTargetJob][libTargetField]) jobs[libTargetJob][libTargetField] = [];
    const emptyIdx = jobs[libTargetJob][libTargetField].findIndex(r => !r.trim());
    if (emptyIdx >= 0) jobs[libTargetJob][libTargetField][emptyIdx] = text;
    else jobs[libTargetJob][libTargetField].push(text);
    renderJobs(); autoSave();
  }
}

// Import CV feature removed

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PREVIEW (IFRAME BASED)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function schedulePreview() {
  clearTimeout(previewTimer);
  previewTimer = setTimeout(renderPreview, 350);
}

function renderPreview() {
  const data = collectCVData();
  if (!data) return;
  const styles = getCVStyles(currentColor);
  const active = getActiveSections();
  const html = buildCV(data, currentTemplate, currentColor, currentSpacing, currentFontSize, active);
  const pageBreakCSS = `
    .page-break-line{height:12px;background:#e2e8f0;margin:0;position:relative;}
    .page-break-line::after{content:'--- Page 2 ---';position:absolute;left:50%;transform:translateX(-50%);top:-1px;font-size:8px;color:#94a3b8;background:#e2e8f0;padding:0 6px;}
  `;
  const doc = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{box-sizing:border-box;margin:0;padding:0;}body{background:#fff;overflow:visible;}${styles}${pageBreakCSS}</style></head><body>${html}</body></html>`;
  const iframe = document.getElementById('preview-iframe');
  if (!iframe) return;
  iframe.srcdoc = doc;
  // After load, resize iframe to full content height so preview scrolls
  iframe.onload = () => {
    try {
      const h = iframe.contentDocument.body.scrollHeight;
      iframe.style.height = (h || 842) + 'px';
    } catch(e) {}
    scalePreviewIframe();
  };
  updateStrengthScore();
}

function renderPreviewFull() {
  const data = collectCVData();
  if (!data) return;
  const styles = getCVStyles(currentColor);
  const active = getActiveSections();
  const html = buildCV(data, currentTemplate, currentColor, currentSpacing, currentFontSize, active);
  const doc = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{box-sizing:border-box;margin:0;padding:0;}body{background:#fff;overflow:visible;}${styles}</style></head><body>${html}</body></html>`;
  const iframe = document.getElementById('preview-full-iframe');
  if (!iframe) return;
  iframe.srcdoc = doc;
  iframe.onload = () => {
    try {
      const h = iframe.contentDocument.body.scrollHeight;
      if (h > 842) {
        iframe.style.height = h + 'px';
        scaleMobilePreview();
      }
    } catch(e) {}
  };
}

function scalePreviewIframe() {
  const wrap = document.getElementById('preview-wrap');
  const iframe = document.getElementById('preview-iframe');
  if (!wrap || !iframe) return;
  const w = wrap.clientWidth || 300;
  const scale = w / 595;
  iframe.style.transform = `scale(${scale})`;
  iframe.style.transformOrigin = 'top left';
  const iframeH = parseInt(iframe.style.height) || 842;
  wrap.style.height = Math.ceil(iframeH * scale) + 'px';
  wrap.style.overflow = 'hidden';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE LAYOUT MANAGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Default section order & page assignment
// Each entry: { id, label, icon, page (1|2|3), enabled }
let pageLayout = [
  { id:'summary',     label:'Professional Summary', icon:'üìù', page:1 },
  { id:'experience',  label:'Work Experience',       icon:'üíº', page:1 },
  { id:'education',   label:'Education',             icon:'üéì', page:1 },
  { id:'skills',      label:'Skills',                icon:'üõ†', page:1 },
  { id:'certs',       label:'Certifications',        icon:'üèÖ', page:1 },
  { id:'personal',    label:'Personal Details',      icon:'üë§', page:2 },
  { id:'declaration', label:'Declaration',           icon:'‚úç', page:2 },
];

function getActiveSections() {
  const declOn    = document.getElementById('tog_decl')?.checked;
  const personalOn= document.getElementById('tog_personal')?.checked;
  return pageLayout.filter(s => {
    if (s.id === 'declaration' && !declOn)    return false;
    if (s.id === 'personal'    && !personalOn) return false;
    return true;
  });
}

function resetPageLayout() {
  // Reset to sensible defaults: main sections on p1, personal/declaration on p2
  pageLayout.length = 0;
  pageLayout.push(
    { id:'summary',     label:'Professional Summary', icon:'üìù', page:1 },
    { id:'experience',  label:'Work Experience',       icon:'üíº', page:1 },
    { id:'education',   label:'Education',             icon:'üéì', page:1 },
    { id:'skills',      label:'Skills',                icon:'üõ†', page:1 },
    { id:'certs',       label:'Certifications',        icon:'üèÖ', page:1 },
    { id:'personal',    label:'Personal Details',      icon:'üë§', page:2 },
    { id:'declaration', label:'Declaration',           icon:'‚úç', page:2 }
  );
  // Re-add any custom sections
  customSections.forEach(sec => {
    pageLayout.push({ id: sec.id, label: 'Custom: ' + (sec.title || '(New)'), icon: '‚ú®', page: 1 });
  });
  savePageLayout();
  renderPageLayout();
  schedulePreview();
  showToast('‚úÖ Page layout reset to defaults');
}

function savePageLayout() {
  try { localStorage.setItem('cv_page_layout', JSON.stringify(pageLayout)); } catch(e){}
  autoSave();
}

function loadPageLayout() {
  try {
    const saved = JSON.parse(localStorage.getItem('cv_page_layout') || 'null');
    if (saved && Array.isArray(saved)) {
      // Restore BOTH page assignments AND array order from saved data
      // Step 1: update page numbers for known sections
      saved.forEach(s => {
        const found = pageLayout.find(p => p.id === s.id);
        if (found) found.page = s.page;
      });
      // Step 2: restore array order to match saved order
      const newOrder = [];
      saved.forEach(s => {
        const found = pageLayout.find(p => p.id === s.id);
        if (found) newOrder.push(found);
      });
      // Append any new sections not in saved data (future-proof)
      pageLayout.forEach(p => {
        if (!newOrder.find(n => n.id === p.id)) newOrder.push(p);
      });
      pageLayout.length = 0;
      newOrder.forEach(p => pageLayout.push(p));
    }
  } catch(e) {}
}

function moveSection(id, dir) {
  // dir: -1 = up, +1 = down within same page, or change page
  const idx = pageLayout.findIndex(s => s.id === id);
  if (idx < 0) return;
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= pageLayout.length) return;
  [pageLayout[idx], pageLayout[newIdx]] = [pageLayout[newIdx], pageLayout[idx]];
  savePageLayout();
  renderPageLayout();
  schedulePreview();
}

function setSectionPage(id, page) {
  const s = pageLayout.find(s => s.id === id);
  if (!s) return;
  s.page = parseInt(page);
  // Re-sort pageLayout so sections are grouped by page (stable sort preserves within-page order)
  pageLayout.sort((a, b) => a.page - b.page);
  savePageLayout(); renderPageLayout(); schedulePreview();
}

function renderPageLayout() {
  const container = document.getElementById('page-layout-ui');
  if (!container) return;
  const active = getActiveSections();
  const pages = [1, 2, 3];
  const pageLabels = {1:'Page 1 ‚Äî Main Content', 2:'Page 2 ‚Äî Continuation', 3:'Page 3 ‚Äî Extra'};
  const pageDesc   = {
    1:'Bottom margin only ‚Ä¢ Header always here',
    2:'Top + bottom margins ‚Ä¢ Content continues here',
    3:'Top + bottom margins ‚Ä¢ Extra overflow',
  };

  container.innerHTML = pages.map(pg => {
    const sections = active.filter(s => s.page === pg);
    const chips = sections.length ? sections.map(s => `
      <div class="plm-chip" draggable="true" id="chip-${s.id}"
           ondragstart="plmDragStart(event,'${s.id}')"
           ondragover="event.preventDefault()"
           ondrop="plmDrop(event,'${s.id}')">
        <span class="plm-chip-icon">${s.icon}</span>
        <span class="plm-chip-name">${s.label}</span>
        <div class="plm-arrows">
          <button onclick="moveSectionUp('${s.id}')" title="Move up">‚ñ≤</button>
          <button onclick="moveSectionDown('${s.id}')" title="Move down">‚ñº</button>
        </div>
        <select onchange="setSectionPage('${s.id}',this.value)" title="Move to page" style="font-size:10px;border:1px solid var(--border);border-radius:4px;padding:2px 4px;color:var(--muted);background:var(--bg);cursor:pointer;">
          <option value="1" ${s.page===1?'selected':''}>P1</option>
          <option value="2" ${s.page===2?'selected':''}>P2</option>
          <option value="3" ${s.page===3?'selected':''}>P3</option>
        </select>
      </div>`).join('') 
      : `<div style="font-size:11px;color:var(--muted);padding:6px;text-align:center;">‚Äî empty ‚Äî</div>`;

    return `<div class="plm-page">
      <div class="plm-page-label"><span>${pg}</span>${pageLabels[pg]}</div>
      <div style="font-size:10px;color:var(--muted);margin-bottom:5px;">${pageDesc[pg]}</div>
      <div class="plm-slots" id="plm-pg-${pg}"
           ondragover="plmDragOverZone(event)"
           ondragleave="plmDragLeave(event)"
           ondrop="plmDropToPage(event,${pg})">${chips}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Drag and Drop ‚îÄ‚îÄ
let _dragId = null;
function plmDragStart(e, id) { _dragId = id; e.dataTransfer.effectAllowed='move'; }
function plmDragOverZone(e)  { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function plmDragLeave(e)     { e.currentTarget.classList.remove('drag-over'); }
function plmDropToPage(e, pg) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (_dragId) {
    setSectionPage(_dragId, pg); // setSectionPage already re-sorts
    _dragId = null;
  }
}
function plmDrop(e, targetId) {
  e.preventDefault();
  if (!_dragId || _dragId === targetId) return;
  const fromIdx = pageLayout.findIndex(s => s.id === _dragId);
  const toIdx   = pageLayout.findIndex(s => s.id === targetId);
  if (fromIdx >= 0 && toIdx >= 0) {
    pageLayout.splice(toIdx, 0, pageLayout.splice(fromIdx, 1)[0]);
    savePageLayout();
    renderPageLayout();
    schedulePreview();
  }
  _dragId = null;
}
function moveSectionUp(id) {
  const active = getActiveSections();
  const sec = pageLayout.find(s=>s.id===id);
  if (!sec) return;
  const pg = sec.page;
  const inPage = active.filter(s=>s.page===pg);
  const posInPage = inPage.findIndex(s=>s.id===id);

  if (posInPage > 0) {
    // Swap with previous on same page
    const prevId = inPage[posInPage-1].id;
    const iA = pageLayout.findIndex(s=>s.id===id);
    const iB = pageLayout.findIndex(s=>s.id===prevId);
    [pageLayout[iA], pageLayout[iB]] = [pageLayout[iB], pageLayout[iA]];
  } else {
    // At top of page ‚Äî move to bottom of previous page
    const prevPg = pg - 1;
    if (prevPg < 1) return;
    sec.page = prevPg;
    const iA = pageLayout.findIndex(s=>s.id===id);
    pageLayout.splice(iA, 1);
    let insertAt = -1;
    pageLayout.forEach((s,i) => { if (s.page === prevPg) insertAt = i; });
    if (insertAt < 0) {
      const firstHigher = pageLayout.findIndex(s=>s.page > prevPg);
      insertAt = firstHigher >= 0 ? firstHigher - 1 : pageLayout.length - 1;
    }
    pageLayout.splice(insertAt + 1, 0, sec);
  }
  savePageLayout(); renderPageLayout(); schedulePreview();
}

function moveSectionDown(id) {
  const active = getActiveSections();
  const sec = pageLayout.find(s=>s.id===id);
  if (!sec) return;
  const pg = sec.page;
  const inPage = active.filter(s=>s.page===pg);
  const posInPage = inPage.findIndex(s=>s.id===id);

  if (posInPage < inPage.length - 1) {
    // Swap with next on same page
    const nextId = inPage[posInPage+1].id;
    const iA = pageLayout.findIndex(s=>s.id===id);
    const iB = pageLayout.findIndex(s=>s.id===nextId);
    [pageLayout[iA], pageLayout[iB]] = [pageLayout[iB], pageLayout[iA]];
  } else {
    // At bottom of page ‚Äî move to top of next page
    const nextPg = pg + 1;
    if (nextPg > 3) return;
    sec.page = nextPg;
    const iA = pageLayout.findIndex(s=>s.id===id);
    pageLayout.splice(iA, 1);
    let insertAt = pageLayout.findIndex(s=>s.page === nextPg);
    if (insertAt < 0) {
      let lastLower = -1;
      pageLayout.forEach((s,i) => { if (s.page < nextPg) lastLower = i; });
      insertAt = lastLower >= 0 ? lastLower + 1 : pageLayout.length;
      pageLayout.splice(insertAt, 0, sec);
    } else {
      pageLayout.splice(insertAt, 0, sec);
    }
  }
  savePageLayout(); renderPageLayout(); schedulePreview();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VECTOR PDF DOWNLOAD ‚Äî BROWSER PRINT ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Uses browser's native print engine ‚Äî real vector text, real fonts,
// infinitely crisp at any zoom ‚Äî same quality as government certificates.
// html2canvas (screenshot) is completely replaced.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function _isMobile() {
  return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent) || window.innerWidth < 768;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE: Direct clean PDF download (no print dialog)
// Same engine as watermark PDF but WITHOUT watermark
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function _doPDFDownloadMobile() {
  const overlay = document.getElementById('pdf-overlay');
  const txtEl   = document.getElementById('pdf-overlay-text');
  const subEl   = document.getElementById('pdf-overlay-sub');

  if (txtEl) txtEl.innerHTML = 'üìÑ Generating Your PDF...';
  if (subEl) subEl.innerHTML = 'Please wait ‚Äî downloading clean PDF to your phone';
  if (overlay) overlay.classList.add('show');

  try {
    const data       = collectCVData();
    const styles     = getCVStyles(currentColor);
    const active     = getActiveSections();
    const orderedIds = active; // pass full objects with page info
    const html       = buildCV(data, currentTemplate, currentColor, currentSpacing, currentFontSize, orderedIds);

    const MB1   = parseInt(document.getElementById('margin_p1_b')?.value) || 36;
    const MT2   = parseInt(document.getElementById('margin_p2_t')?.value) || 36;
    const MB2   = parseInt(document.getElementById('margin_p2_b')?.value) || 36;
    const SCALE = 2; // 2√ó is enough for mobile ‚Äî 3√ó causes memory issues on phones

    // ‚îÄ‚îÄ KEY FIX: Use a div container, NOT an iframe ‚îÄ‚îÄ
    // On mobile, iframes placed at left:-9999px fall outside the viewport
    // and the browser renders them at the PHONE width (~390px) not 595px.
    // A div inside a clipping container stays in the DOM flow at exactly 595px.
    const wrapper = document.createElement('div');
    wrapper.style.cssText = [
      'position:fixed',
      'top:0',
      'left:0',
      'width:595px',           // exact A4 pixel width
      'height:1px',            // clip to 1px tall so user sees nothing
      'overflow:hidden',       // hide the content
      'opacity:0',             // invisible
      'pointer-events:none',
      'z-index:-9999',
    ].join(';');

    const cvDiv = document.createElement('div');
    cvDiv.style.cssText = 'width:595px;background:#fff;margin:0;padding:0;position:relative;';

    // Inject a style tag + CV html
    const styleTag = document.createElement('style');
    styleTag.textContent = [
      '*{box-sizing:border-box;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}',
      'body,html{margin:0;padding:0;}',
      styles
    ].join('');

    cvDiv.appendChild(styleTag);
    const cvContent = document.createElement('div');
    cvContent.innerHTML = html;
    while (cvContent.firstChild) cvDiv.appendChild(cvContent.firstChild);
    wrapper.appendChild(cvDiv);
    document.body.appendChild(wrapper);

    // Let browser paint it
    await new Promise(r => setTimeout(r, 600));

    const realH = Math.max(cvDiv.scrollHeight, cvDiv.offsetHeight, 842);

    // Expand wrapper tall enough so html2canvas can see it all
    wrapper.style.height = realH + 'px';
    await new Promise(r => setTimeout(r, 200));

    // Capture at exactly 595px wide
    const cvCanvas = await html2canvas(cvDiv, {
      scale: SCALE,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff',
      width: 595,
      height: realH,
      windowWidth: 595,
      windowHeight: realH,
      scrollX: 0,
      scrollY: 0,
      logging: false,
      imageTimeout: 0,
      removeContainer: false,
      x: 0,
      y: 0,
    });

    document.body.removeChild(wrapper);

    // ‚îÄ‚îÄ Slice into A4 pages with NO margins (clean mobile download) ‚îÄ‚îÄ
    const { jsPDF } = window.jspdf;
    const pdf     = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4', compress:true });
    const A4_H    = 842;
    const A4_SCAN = 100;
    const P1_SAFE = A4_H - MB1;
    const P2_SAFE = A4_H - MT2 - MB2;
    const total   = cvCanvas.height;

    if (total / SCALE <= A4_H + 20) {
      // Single page ‚Äî fits on one A4
      const pc = _makePageCanvas(cvCanvas, A4_H * SCALE, 0, 0, total);
      pdf.addImage(pc.toDataURL('image/jpeg', 0.92), 'JPEG', 0, 0, 210, 297);
    } else {
      // Multi-page ‚Äî smart slice to avoid cutting through text
      const slices = _smartSliceWM(cvCanvas, A4_H, P1_SAFE, P2_SAFE, A4_SCAN, SCALE);
      slices.forEach((sl, si) => {
        if (si > 0) pdf.addPage('a4', 'portrait');
        const topOff = si > 0 ? Math.round(MT2 * SCALE) : 0;
        const pc = _makePageCanvas(cvCanvas, A4_H * SCALE, sl.start, topOff, sl.len);
        pdf.addImage(pc.toDataURL('image/jpeg', 0.92), 'JPEG', 0, 0, 210, 297);
      });
    }

    const cvName = (data.personal.name || 'CV').replace(/[^a-zA-Z0-9\s]/g,'').trim().replace(/\s+/g,'_') || 'CV';
    pdf.save(`${cvName}_CV.pdf`);
    showToast('‚úÖ PDF downloaded to your phone!');

  } catch(err) {
    console.error('Mobile PDF error:', err);
    showToast('‚ùå Error generating PDF. Please try again.');
  } finally {
    if (txtEl) txtEl.innerHTML = 'üìÑ Opening Print Dialog...';
    if (subEl) subEl.innerHTML = 'Choose <strong style="color:#fff;">"Save as PDF"</strong> ‚Üí destination in the dialog';
    if (overlay) overlay.classList.remove('show');
  }
}

function _doPDFDownload() {
  // On mobile ‚Äî skip print dialog, directly download PDF
  if (_isMobile()) { _doPDFDownloadMobile(); return; }

  const data   = collectCVData();
  const styles = getCVStyles(currentColor);
  const active = getActiveSections();
  const orderedIds = active; // pass full objects with page info
  const html   = buildCV(data, currentTemplate, currentColor, currentSpacing, currentFontSize, orderedIds);

  // Read margin settings (px ‚Üí mm: 1px = 0.2646mm at 96dpi)
  const MB1 = parseInt(document.getElementById('margin_p1_b')?.value) || 36;
  const MT2 = parseInt(document.getElementById('margin_p2_t')?.value) || 36;
  const MB2 = parseInt(document.getElementById('margin_p2_b')?.value) || 36;
  const px2mm = px => +(px * 0.2646).toFixed(1);

  const cvName = (data.personal.name || 'CV').replace(/[^a-zA-Z0-9\s]/g,'').trim() || 'My CV';

  // ‚îÄ‚îÄ Build the print document ‚îÄ‚îÄ
  // @page :first  = Page 1 (no top margin, only bottom)
  // @page         = Page 2 onward (top + bottom margin)
  const printDoc = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>${cvName} ‚Äî CV</title>
<style>
  /* ‚îÄ‚îÄ PRINT ENGINE SETTINGS ‚îÄ‚îÄ */
  *, *::before, *::after {
    box-sizing: border-box;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }

  /* Page 2 and beyond ‚Äî top + bottom margin */
  @page {
    size: A4 portrait;
    margin: ${px2mm(MT2)}mm 0 ${px2mm(MB2)}mm 0;
  }
  /* First page ‚Äî no top margin (header bleeds to edge), only bottom */
  @page :first {
    margin: 0 0 ${px2mm(MB1)}mm 0;
  }

  html {
    width: 210mm;
    background: #fff;
  }
  body {
    width: 210mm;
    margin: 0;
    padding: 0;
    background: #fff;
    font-smooth: always;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
  }

  /* ‚îÄ‚îÄ CV Template Styles ‚îÄ‚îÄ */
  ${styles}

  /* ‚îÄ‚îÄ Print-time overrides ‚Äî ensure backgrounds & colors print ‚îÄ‚îÄ */
  @media print {
    html, body { background: #fff !important; }
    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    /* Smart page-break rules */
    h1,h2,h3,h4,h5,h6 { page-break-after: avoid; break-after: avoid; }
    .t1 .sh,.t2 .sh,.t3 .sh,.t4 .sh,.t5 .sh,
    .t6 .msh,.t7 .sh,.t8 .sh,.t9 .sh,.t10 .sh {
      page-break-after: avoid !important;
      break-after: avoid !important;
    }
    .t2 .job,.t5 .job,.t6 .job,.t8 .job,.t10 .job {
      page-break-inside: avoid !important;
      break-inside: avoid !important;
    }
    table { page-break-inside: avoid; }
    tr    { page-break-inside: avoid; }
  }
</style>
</head>
<body>${html}</body>
</html>`;

  // ‚îÄ‚îÄ Open print window ‚îÄ‚îÄ
  const pw = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
  if (!pw) {
    // Popup blocked ‚Äî fall back to print overlay method
    showToast('‚ö†Ô∏è Allow popups, or use the Print button below');
    _printFallbackDirect(printDoc);
    return;
  }

  pw.document.open();
  pw.document.write(printDoc);
  pw.document.close();

  // Wait for all resources (fonts, images) to fully load before printing
  pw.addEventListener('load', () => {
    setTimeout(() => {
      pw.document.title = cvName + ' ‚Äî CV';
      pw.focus();
      pw.print();
      pw.addEventListener('afterprint', () => { try { pw.close(); } catch(e){} });
    }, 900);
  });

  // Fallback if load event already fired (srcdoc scenario)
  setTimeout(() => {
    if (pw && !pw.closed) {
      try {
        pw.focus();
        pw.print();
      } catch(e) {}
    }
  }, 2200);

  showToast('üìÑ Choose "Save as PDF" in the print dialog');
}

// Direct fallback: inject into hidden iframe and print from current page
function _printFallbackDirect(printDoc) {
  const el = document.getElementById('print-cv-styles');
  const ct = document.getElementById('print-cv-content');
  if (el && ct) {
    el.textContent = '';
    ct.innerHTML = printDoc;
    setTimeout(() => { window.print(); setTimeout(() => { ct.innerHTML=''; }, 2000); }, 200);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WATERMARK PDF ‚Äî screenshot + "One Net Solution" diagonal
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function downloadWatermarkPDF() {
  const overlay    = document.getElementById('pdf-overlay');
  const txtEl      = document.getElementById('pdf-overlay-text');
  const subEl      = document.getElementById('pdf-overlay-sub');

  // Update overlay message for watermark mode
  if (txtEl) txtEl.innerHTML = 'üîí Generating Preview PDF...';
  if (subEl) subEl.innerHTML = 'Adding <strong style="color:#fff;">One Net Solution</strong> watermark ‚Äî please wait';
  overlay.classList.add('show');

  try {
    const data       = collectCVData();
    const styles     = getCVStyles(currentColor);
    const active     = getActiveSections();
    const orderedIds = active; // pass full objects with page info
    const html       = buildCV(data, currentTemplate, currentColor, currentSpacing, currentFontSize, orderedIds);

    const MB1 = parseInt(document.getElementById('margin_p1_b')?.value) || 36;
    const MT2 = parseInt(document.getElementById('margin_p2_t')?.value) || 36;
    const MB2 = parseInt(document.getElementById('margin_p2_b')?.value) || 36;
    const SCALE = 3; // 3√ó for good quality raster

    const pageDoc = `<!DOCTYPE html><html><head><meta charset="UTF-8">
<style>
  *{box-sizing:border-box;margin:0;padding:0;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}
  html,body{background:#fff;width:595px;margin:0;padding:0;}
  ${styles}
</style></head><body style="width:595px;background:#fff;margin:0;padding:0;">${html}</body></html>`;

    // Off-screen iframe ‚Äî opacity:0 (critical: NOT visibility:hidden)
    const iframe = document.createElement('iframe');
    iframe.style.cssText = 'position:fixed;left:-9999px;top:0;width:595px;height:10000px;border:none;opacity:0;pointer-events:none;z-index:-1;';
    document.body.appendChild(iframe);

    await new Promise(res => { iframe.onload = res; iframe.srcdoc = pageDoc; });
    await new Promise(r => setTimeout(r, 1600));

    const iDoc  = iframe.contentDocument;
    const iBody = iDoc.body;
    const realH = Math.max(iBody.scrollHeight, iBody.offsetHeight, iDoc.documentElement.scrollHeight, 842);
    iframe.style.height = (realH + 100) + 'px';
    await new Promise(r => setTimeout(r, 350));

    // Capture full CV as canvas
    const cvCanvas = await html2canvas(iBody, {
      scale: SCALE,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff',
      width: 595,
      height: realH,
      windowWidth: 595,
      windowHeight: realH,
      scrollX: 0, scrollY: 0,
      logging: false,
      imageTimeout: 0,
      removeContainer: false,
    });
    document.body.removeChild(iframe);

    // ‚îÄ‚îÄ Slice into A4 pages with margins ‚îÄ‚îÄ
    const { jsPDF } = window.jspdf;
    const pdf    = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4', compress:true });
    const A4_H   = 842;
    const A4_SCAN = 100;
    const P1_SAFE = A4_H - MB1;
    const P2_SAFE = A4_H - MT2 - MB2;

    const total = cvCanvas.height;

    // Helper: check if a canvas slice has any real content (not all white)
    function sliceHasContent(canvas, startY, lenY) {
      const sampleStep = Math.max(1, Math.floor(lenY / 80));
      const img = canvas.getContext('2d').getImageData(0, startY, canvas.width, Math.min(lenY, canvas.height - startY));
      const px  = img.data;
      for (let i = 0; i < px.length; i += 4 * sampleStep) {
        if (px[i] < 245 || px[i+1] < 245 || px[i+2] < 245) return true;
      }
      return false;
    }

    if (total / SCALE <= A4_H + 20) {
      // Single page ‚Äî one watermark centered
      _applyWatermarkOnSlice(cvCanvas, 0, total, SCALE);
      const pc = _makePageCanvas(cvCanvas, A4_H * SCALE, 0, 0, total);
      _applyWatermarkOnPageCanvas(pc, SCALE);
      pdf.addImage(pc.toDataURL('image/jpeg', 0.88), 'JPEG', 0, 0, 210, 297);
    } else {
      const slices = _smartSliceWM(cvCanvas, A4_H, P1_SAFE, P2_SAFE, A4_SCAN, SCALE);
      // Keep only content-holding pages (skip blank trailing pages)
      const contentSlices = slices.filter(sl => sliceHasContent(cvCanvas, sl.start, sl.len));
      contentSlices.forEach((sl, si) => {
        // Draw exactly one watermark centered on this page slice
        _applyWatermarkOnSlice(cvCanvas, sl.start, sl.len, SCALE);
        if (si > 0) pdf.addPage('a4', 'portrait');
        const topOff = si > 0 ? Math.round(MT2 * SCALE) : 0;
        const pc = _makePageCanvas(cvCanvas, A4_H * SCALE, sl.start, topOff, sl.len);
        _applyWatermarkOnPageCanvas(pc, SCALE);
        pdf.addImage(pc.toDataURL('image/jpeg', 0.88), 'JPEG', 0, 0, 210, 297);
      });
    }

    const name = (data.personal.name || 'CV').replace(/[^a-zA-Z0-9\s]/g,'').trim().replace(/\s+/g,'_') || 'CV';
    pdf.save(`${name}_PREVIEW_OneNetSolution.pdf`);
    showToast('üîí Watermark preview downloaded!');

  } catch(err) {
    console.error('Watermark PDF error:', err);
    showToast('Error generating preview PDF');
  } finally {
    // Restore overlay text to default
    if (txtEl) txtEl.innerHTML = 'üìÑ Opening Print Dialog...';
    if (subEl) subEl.innerHTML = 'Choose <strong style="color:#fff;">"Save as PDF"</strong> ‚Üí destination in the dialog';
    overlay.classList.remove('show');
  }
}

// ‚îÄ‚îÄ Draw ONE "One Net Solution" watermark centered on an already-sliced page canvas ‚îÄ‚îÄ
function _applyWatermarkOnPageCanvas(pageCanvas, scale) {
  const ctx = pageCanvas.getContext('2d');
  const W   = pageCanvas.width;
  const H   = pageCanvas.height;

  const TEXT      = 'One Net Solution';
  const FONT_SIZE = Math.round(52 * scale);
  const ANGLE     = -35 * (Math.PI / 180);

  // Main diagonal watermark ‚Äî centered on the page
  ctx.save();
  ctx.globalAlpha  = 0.18;
  ctx.fillStyle    = '#1D4ED8';
  ctx.font         = `700 ${FONT_SIZE}px "Helvetica Neue", Arial, sans-serif`;
  ctx.textAlign    = 'center';
  ctx.textBaseline = 'middle';
  ctx.translate(W / 2, H / 2);
  ctx.rotate(ANGLE);
  ctx.fillText(TEXT, 0, 0);
  ctx.restore();

  // Bottom-right stamp
  const STAMP_FONT = Math.round(11 * scale);
  ctx.save();
  ctx.globalAlpha  = 0.35;
  ctx.fillStyle    = '#1D4ED8';
  ctx.font         = `600 ${STAMP_FONT}px "Helvetica Neue", Arial, sans-serif`;
  ctx.textAlign    = 'right';
  ctx.textBaseline = 'bottom';
  ctx.fillText('¬© One Net Solution ‚Äî Preview Only', W - Math.round(10 * scale), H - Math.round(8 * scale));
  ctx.restore();
}

// kept for backward compat (no-op)
function _applyWatermark(canvas, scale) {}
// kept for backward compat (no-op)
function _applyWatermarkOnSlice(canvas, sliceStart, sliceLen, scale) {}

// ‚îÄ‚îÄ Copy a slice of srcCanvas into a clean A4-sized canvas with optional top offset ‚îÄ‚îÄ
function _makePageCanvas(src, a4Px, srcStart, topOff, srcLen) {
  const c   = document.createElement('canvas');
  c.width   = src.width;
  c.height  = a4Px;
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, c.width, c.height);
  const copy = Math.min(srcLen, a4Px - topOff);
  if (copy > 0) ctx.drawImage(src, 0, srcStart, src.width, copy, 0, topOff, src.width, copy);
  return c;
}

// ‚îÄ‚îÄ Smart slice respecting different safe heights per page ‚îÄ‚îÄ
function _smartSliceWM(canvas, a4H, p1Safe, p2Safe, scanPx, scale) {
  const slices = [];
  let startY = 0, pg = 0;
  while (startY < canvas.height) {
    pg++;
    const safeH   = (pg === 1 ? p1Safe : p2Safe) * scale;
    const idealEnd = startY + safeH;
    if (idealEnd >= canvas.height) { slices.push({ start: startY, len: canvas.height - startY }); break; }
    const scanH   = Math.min(scanPx * scale, safeH);
    const scanTop = idealEnd - scanH;
    const img     = canvas.getContext('2d').getImageData(0, scanTop, canvas.width, scanH);
    const px      = img.data;
    let cutY      = idealEnd;
    for (let row = scanH - 1; row >= 0; row--) {
      let white = true;
      for (let col = 0; col < canvas.width; col++) {
        const i = (row * canvas.width + col) * 4;
        if (px[i] < 236 || px[i+1] < 236 || px[i+2] < 236) { white = false; break; }
      }
      if (white) { cutY = scanTop + row; break; }
    }
    slices.push({ start: startY, len: cutY - startY });
    startY = cutY;
  }
  return slices;
}




// Build only the sections assigned to a given page (section-aware, template-aware)
function buildPageSections(data, sections, tpl, col, spacing, fs) {
  const d = data.personal;
  const validJ = data.jobs.filter(j=>j.company);
  const validE = data.edus.filter(e=>e.institution);
  const validS = data.skills.filter(sk=>sk.name);
  const validC = data.certs.filter(c=>c.name);

  // Get template's section class names
  const tplNum = parseInt(tpl) || 2;
  const shClass = ['t1','t2','t3','t4','t5','t6','t7','t8','t9','t10'][tplNum-1] + ' sh';
  const bodyStyle = getBuildStyle(tpl, col, spacing, fs);

  let html = '';
  for (const sec of sections) {
    switch(sec.id) {
      case 'summary':
        if (d.summary) html += `<div class="${shClass}">Professional Summary</div><p style="margin:0 0 10px;color:#333;text-align:justify;font-size:${fs}px;line-height:1.6;">${s(d.summary)}</p>`;
        break;
      case 'experience':
        if (validJ.length) html += buildSectionExperience(validJ, shClass, fs);
        break;
      case 'education':
        if (validE.length) html += buildSectionEducation(validE, shClass, fs);
        break;
      case 'skills':
        if (validS.length) html += `<div class="${shClass}">Skills</div><div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;">${validS.map(sk=>`<span style="font-size:${fs-1}px;margin-right:10px;">‚Ä¢ ${s(sk.name)}</span>`).join('')}</div>`;
        break;
      case 'certs':
        if (validC.length) html += `<div class="${shClass}">Certifications</div>${validC.map(c=>`<div style="font-size:${fs-1}px;margin-bottom:3px;">‚Ä¢ <strong>${s(c.name)}</strong>${c.issuedBy?` ‚Äî ${s(c.issuedBy)}`:''} ${c.year?`(${s(c.year)})`:''}</div>`).join('')}`;
        break;
      case 'personal':
        html += buildPersonalSection(data, shClass, col);
        break;
      case 'declaration':
        html += buildDeclaration(data, shClass, d.name, col);
        break;
    }
  }

  // Wrap in template padding div
  return `<div style="${bodyStyle}">${html}</div>`;
}

function getBuildStyle(tpl, col, spacing, fs) {
  const tplNum = parseInt(tpl) || 2;
  const pads = {
    1: spacing==='spacious'?'42px 46px':spacing==='compact'?'28px 34px':'36px 40px',
    2: spacing==='compact'?'14px 26px':spacing==='spacious'?'22px 34px':'16px 30px',
    3: '40px 46px', 4: '44px 48px', 5: '14px 20px',
    6: '14px 20px', 7: '30px 40px', 8: '32px 36px',
    9: '32px 38px', 10:'20px 30px',
  };
  const pad = pads[tplNum] || '36px 40px';
  const fonts = {1:'Georgia,serif',2:"'Helvetica Neue',Arial,sans-serif",3:'Georgia,serif',
    4:"'Helvetica Neue',Arial,sans-serif",5:'Arial,sans-serif',6:'Arial,sans-serif',
    7:"'Times New Roman',Times,serif",8:'Arial,sans-serif',9:"'Courier New',monospace",
    10:"'Helvetica Neue',Arial,sans-serif"};
  return `font-family:${fonts[tplNum]||'Arial,sans-serif'};font-size:${fs}px;padding:${pad};color:#111;line-height:1.6;`;
}

function buildSectionExperience(jobs, shClass, fs) {
  return `<div class="${shClass}">Work Experience</div>` + jobs.map(j => {
    const period = j.startDate ? (j.startDate + ' ‚Äî ' + (j.current?'Present':j.endDate||'')) : '';
    const bullets = (j.bullets||[]).filter(Boolean);
    return `<div style="margin-bottom:10px;">
      <div style="display:flex;justify-content:space-between;align-items:baseline;gap:8px;">
        <strong style="font-size:${fs}px;">${s(j.role||j.company)}</strong>
        <span style="font-size:${fs-1.5}px;color:#666;white-space:nowrap;flex-shrink:0;">${s(period)}</span>
      </div>
      <div style="font-style:italic;color:#555;font-size:${fs-1}px;">${s(j.company)}${j.location?`, ${s(j.location)}`:''}</div>
      ${bullets.length?`<ul style="padding-left:14px;margin:3px 0;">${bullets.map(b=>`<li style="font-size:${fs-1}px;color:#333;margin-bottom:1px;">${s(b)}</li>`).join('')}</ul>`:''}
    </div>`;
  }).join('');
}

function buildSectionEducation(edus, shClass, fs) {
  return `<div class="${shClass}">Education</div>` + edus.map(e => {
    return `<div style="display:flex;justify-content:space-between;margin-bottom:7px;">
      <div>
        <strong style="font-size:${fs}px;">${s(e.degree)}</strong>
        <div style="font-style:italic;color:#555;font-size:${fs-1}px;">${s(e.institution)}${e.location?`, ${s(e.location)}`:''}</div>
      </div>
      <div style="text-align:right;color:#666;font-size:${fs-1.5}px;">${s(e.endYear||e.startYear)}${e.grade?`<br/>Grade: ${s(e.grade)}`:''}</div>
    </div>`;
  }).join('');
}


function triggerPrintFallback() {
  // Same vector-quality fallback ‚Äî uses print CSS directly on page
  const data   = collectCVData();
  const styles = getCVStyles(currentColor);
  const active = getActiveSections();
  const orderedIds = active; // pass full objects with page info
  const html   = buildCV(data, currentTemplate, currentColor, currentSpacing, currentFontSize, orderedIds);
  const stylesEl   = document.getElementById('print-cv-styles');
  const contentEl  = document.getElementById('print-cv-content');
  if (!stylesEl || !contentEl) return;
  stylesEl.textContent = `
    *{box-sizing:border-box;margin:0;padding:0;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}
    @page{size:A4 portrait;margin:0;}
    html,body{background:#fff;width:210mm;}
    ${styles}
  `;
  contentEl.innerHTML = html;
  setTimeout(() => {
    window.print();
    setTimeout(() => { contentEl.innerHTML = ''; stylesEl.textContent = ''; }, 2000);
  }, 200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEMO MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEMO_DATA = {
  personal:{name:'Rahul Sharma',father:'Ramesh Sharma',title:'Senior Loco Motive Operator',phone:'+91 9876543210',email:'rahul.sharma@email.com',location:'Mumbai, Maharashtra',dob:'15 March 1992',nation:'Indian',marital:'Married',lang:'Hindi, English, Marathi',passport:'P1234567',passport_exp:'27/12/2030',summary:'Dedicated and experienced Loco Motive and MSV Operator with over 10 years of proven experience in metro and tunnel railway construction projects across India. Committed to safety, efficiency and high standards of work.'},
  jobs:[
    {title:'Loco Motive Operator',company:'M/S Corrival Corp ‚Äî Tata Project',location:'Chennai',start:'Aug 2022',end:'',current:true,type:'Full-time',responsibilities:['Operated locomotive in underground tunnel on Chennai Metro Project','Ensured safe transportation of TBM segments and construction materials','Performed daily pre-operation safety checks and maintained logs']},
    {title:'MSV Operator',company:'Varasha Infracon Pvt Ltd',location:'Bangalore',start:'Mar 2021',end:'Jun 2022',current:false,type:'Full-time',responsibilities:['Operated MSV in tunnel construction for Bangalore Metro expansion','Coordinated with tunnel engineers for smooth material flow']},
  ],
  edus:[{degree:'Class 10th Pass',institution:'Govt. High School',location:'Odisha',startYear:'',endYear:'2007',grade:''}],
  skills:[{name:'Loco Motive Operation',level:'Expert'},{name:'MSV Operation',level:'Expert'},{name:'TBM Gantry Crane',level:'Advanced'},{name:'NATM Method',level:'Advanced'},{name:'Tunnel Safety Protocols',level:'Expert'},{name:'Heavy Vehicle Driving',level:'Advanced'}],
  certs:[{name:'Tunnel Safety Certificate',issuedBy:'MMRC',year:'2020'}],
  extras:{decl:true,personal:true,photo:false,father:true},
  photo: null,
};

function openDemo(n) {
  demoTpl = Math.min(Math.max(n,1), TPL_INFO.length);
  document.getElementById('demo-modal').classList.add('show');
  renderDemoModal();
}
function closeDemo() { document.getElementById('demo-modal').classList.remove('show'); }
function renderDemoModal() {
  document.getElementById('demo-title').textContent = TPL_INFO[demoTpl-1].n;
  document.getElementById('demo-subtitle').textContent = TPL_INFO[demoTpl-1].d;
  const styles = getCVStyles(currentColor);
  const html = buildCV(DEMO_DATA, demoTpl, currentColor, 'normal', 10.5);
  const iframe = document.getElementById('demo-iframe');
  if (iframe) iframe.srcdoc = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{box-sizing:border-box;margin:0;padding:0;}body{background:white;}${styles}</style></head><body>${html}</body></html>`;
  const dots = document.getElementById('demo-dots');
  if (dots) dots.innerHTML = TPL_INFO.map((_,i) => `<div class="demo-dot ${i+1===demoTpl?'active':''}" onclick="demoNav(${i+1})"></div>`).join('');
}
function demoNav(n) { n=Math.min(Math.max(n,1),TPL_INFO.length); demoTpl=n; renderDemoModal(); }
function demoPrev() { demoNav(demoTpl-1); }
function demoNext() { demoNav(demoTpl+1); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CV DATA COLLECTOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function collectCVData() {
  return {
    personal: getFormData(),
    jobs, edus, skills, certs, customSections,
    extras: {
      decl:     document.getElementById('tog_decl')?.checked     || false,
      personal: document.getElementById('tog_personal')?.checked || false,
      photo:    document.getElementById('tog_photo')?.checked    !== false,
      father:   document.getElementById('tog_father')?.checked   !== false,
      layout:   JSON.parse(JSON.stringify(pageLayout)),
      margin_p1_b: parseInt(document.getElementById('margin_p1_b')?.value) || 36,
      margin_p2_t: parseInt(document.getElementById('margin_p2_t')?.value) || 36,
      margin_p2_b: parseInt(document.getElementById('margin_p2_b')?.value) || 36,
    },
    photo: photoData,
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CV BUILDER ‚Äî ALL 10 TEMPLATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
/**
 * Renders sections GROUPED by page number in one continuous flow.
 * p1 sections render first, then p2, then p3 ‚Äî NO forced page breaks.
 * The browser's natural A4 pagination decides where pages split.
 * Supports both plain string IDs and {id, page} objects.
 */
function renderSections(secOrder, sections) {
  const hasPageInfo = secOrder.some(item => typeof item === 'object' && item.page != null);
  if (!hasPageInfo) {
    return secOrder.map(item => sections[typeof item === 'object' ? item.id : item] || '').join('');
  }
  // Group by page, preserving within-page order
  const pageMap = {};
  secOrder.forEach(item => {
    const id   = typeof item === 'object' ? item.id   : item;
    const page = (typeof item === 'object' && item.page) ? item.page : 1;
    if (!pageMap[page]) pageMap[page] = [];
    pageMap[page].push(id);
  });
  // Sort page groups numerically, render all sections in one continuous flow
  const sortedPages = Object.keys(pageMap).map(Number).sort((a, b) => a - b);
  return sortedPages.map(pg => pageMap[pg].map(id => sections[id] || '').join('')).join('');
}

// Build custom sections HTML for any template
function buildCustomSectionsHTML(data, shSz, fs) {
  if (!data.customSections || !data.customSections.length) return {};
  const result = {};
  const sm = +(fs * 0.88).toFixed(1);
  const xs = +(fs * 0.82).toFixed(1);

  data.customSections.forEach(sec => {
    if (!sec.title) return; // skip untitled sections

    let html = `<div class="sh" style="font-size:${shSz}px;">${s(sec.title)}</div>`;
    const items = sec.items || [];

    items.forEach(item => {
      const hasName   = item.name   && item.name.trim();
      const hasDetail = item.detail && item.detail.trim();
      const hasDates  = item.dates  && item.dates.trim();
      // Support both old structure (bullets:[]) and new
      const bulletArr = (item.bullets || []).filter(b => b && b.trim());

      if (!hasName && !hasDetail && !hasDates && !bulletArr.length) return; // truly empty item ‚Äî skip

      if (hasName || hasDetail || hasDates) {
        html += `<div style="margin-bottom:7px;">`;

        // Row 1: name + dates
        if (hasName || hasDates) {
          html += `<div style="display:flex;justify-content:space-between;align-items:baseline;">`;
          html += hasName
            ? `<strong style="font-size:${sm}px;">${s(item.name)}</strong>`
            : `<span></span>`;
          if (hasDates)
            html += `<span style="color:#666;font-size:${xs}px;font-style:italic;">${s(item.dates)}</span>`;
          html += `</div>`;
        }

        // Row 2: detail / org
        if (hasDetail)
          html += `<div style="color:#555;font-style:italic;font-size:${xs}px;">${s(item.detail)}</div>`;

        // Bullets
        bulletArr.forEach(b => {
          html += `<div style="padding-left:12px;color:#333;font-size:${fs}px;">‚Ä¢ ${s(b)}</div>`;
        });

        html += `</div>`;
      } else {
        // Only bullets, no name/detail/dates
        bulletArr.forEach(b => {
          html += `<div style="font-size:${sm}px;margin-bottom:2px;">‚Ä¢ ${s(b)}</div>`;
        });
      }
    });

    result[sec.id] = html;
  });
  return result;
}

function buildCV(data, tplNum, color, spacing, fontSize, sectionOrder) {
  const fns = [buildT1,buildT2,buildT3,buildT4,buildT5,buildT6,buildT7,buildT8,buildT9,buildT10];
  const fn = fns[Math.min(Math.max((tplNum||2)-1,0), fns.length-1)];
  const nmSz  = (typeof currentNameSize          !=='undefined' ? currentNameSize          : 24);
  const ttlSz = (typeof currentTopTitleSize       !=='undefined' ? currentTopTitleSize       : 14);
  const shSz  = (typeof currentSectionHeaderSize  !=='undefined' ? currentSectionHeaderSize  : 13);
  const subSz = (typeof currentSubHeaderSize      !=='undefined' ? currentSubHeaderSize      : 13);
  return fn(data, color||'#0F766E', spacing||'normal', fontSize||12, sectionOrder||null, nmSz, ttlSz, shSz, subSz);
}

function getCVStyles(col) {
  col = col || '#0F766E';
  return `
  /* ‚îÄ‚îÄ PAGE LAYOUT MANAGER ‚îÄ‚îÄ */
.plm-page{margin-bottom:16px;}
.plm-page-label{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;display:flex;align-items:center;gap:6px;}
.plm-page-label span{background:var(--primary);color:#fff;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;}
.plm-slots{display:flex;flex-direction:column;gap:4px;min-height:32px;border:2px dashed var(--border);border-radius:8px;padding:6px;background:var(--bg);}
.plm-slots.drag-over{border-color:var(--primary);background:var(--primary-light);}
.plm-chip{display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1.5px solid var(--border);border-radius:8px;padding:7px 10px;cursor:grab;font-size:12px;font-weight:600;gap:8px;user-select:none;transition:box-shadow .15s,transform .1s;}
.plm-chip:active{cursor:grabbing;box-shadow:0 4px 16px rgba(0,0,0,.15);transform:scale(1.02);}
.plm-chip-icon{font-size:15px;flex-shrink:0;}
.plm-chip-name{flex:1;}
.plm-chip-pg{font-size:10px;color:var(--muted);background:var(--bg);border-radius:4px;padding:2px 6px;flex-shrink:0;}
.plm-arrows{display:flex;gap:3px;}
.plm-arrows button{width:22px;height:22px;border:1px solid var(--border);border-radius:4px;background:var(--card);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;color:var(--muted);}
.plm-arrows button:hover{background:var(--primary);color:#fff;border-color:var(--primary);}

.t1{font-family:Georgia,serif;color:#111;padding:36px 40px;font-size:10.5px;line-height:1.55;}
  .t1 .hdr{text-align:center;border-bottom:2px solid #333;padding-bottom:12px;margin-bottom:14px;}
  .t1 .nm{font-size:22px;font-weight:700;letter-spacing:2px;text-transform:uppercase;word-break:break-word;}
  .t1 .fn{font-size:10px;color:#666;margin-top:1px;}
  .t1 .ttl{font-size:11.5px;color:#555;margin-top:3px;letter-spacing:1px;}
  .t1 .ct{font-size:9px;color:#666;margin-top:5px;display:flex;flex-wrap:wrap;justify-content:center;gap:4px 10px;word-break:break-word;}
  .t1 .sh{font-weight:700;font-size:10.5px;text-transform:uppercase;letter-spacing:1.5px;border-bottom:1px solid #999;margin:12px 0 7px;padding-bottom:2px;color:${col};}
  .t1 .jo{color:#444;font-style:italic;font-size:9.5px;}
  .t1 .jp{color:#666;font-size:9px;}
  .t1 .jb{padding-left:12px;color:#333;font-size:9.5px;}
  .t2{font-family:'Helvetica Neue',Arial,sans-serif;font-size:10px;}
  .t2 .hdr{padding:22px 30px 18px;color:#fff;background:${col};}
  .t2 .nm{font-size:22px;font-weight:800;}
  .t2 .fn{font-size:10px;opacity:.85;margin-top:1px;}
  .t2 .ttl{font-size:11.5px;margin-top:3px;opacity:.9;}
  .t2 .ct{margin-top:7px;font-size:9px;opacity:.85;display:flex;flex-wrap:wrap;gap:4px 12px;word-break:break-word;}
  .t2 .body{padding:16px 30px;}
  .t2 .sh{font-weight:800;font-size:10px;text-transform:uppercase;letter-spacing:1px;border-bottom:2px solid ${col};color:${col};margin:12px 0 7px;padding-bottom:2px;}
  .t2 .job{margin-bottom:11px;padding-left:10px;border-left:3px solid ${col};}
  .t2 .jrow{display:flex;justify-content:space-between;}
  .t2 .jrl{font-weight:700;font-size:10.5px;}
  .t2 .jp{color:#888;font-size:9px;font-style:italic;}
  .t2 .jco{color:${col};font-weight:600;font-size:9.5px;}
  .t2 .gr{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
  .t2 .tag{background:rgba(0,0,0,.08);color:${col};padding:2px 9px;border-radius:20px;font-size:8.5px;font-weight:600;display:inline-block;margin:2px 2px 2px 0;}
  .t3{font-family:Georgia,serif;color:#222;padding:40px 46px;font-size:10.5px;line-height:1.6;}
  .t3 .hdr{text-align:center;margin-bottom:16px;}
  .t3 .nm{font-size:24px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:${col};word-break:break-word;}
  .t3 .fn{font-size:10px;color:#7f8c8d;margin-top:2px;}
  .t3 .ttl{font-size:12px;color:#7f8c8d;margin-top:4px;letter-spacing:2px;}
  .t3 .cb{display:block;border-top:1px solid #ccc;border-bottom:1px solid #ccc;padding:5px 10px;margin-top:8px;font-size:9px;color:#666;word-break:break-word;text-align:center;}
  .t3 .sh{font-weight:700;font-size:10.5px;text-transform:uppercase;letter-spacing:2px;color:${col};text-align:center;border-bottom:.5px solid #bdc3c7;margin:14px 0 8px;padding-bottom:3px;}
  .t3 .jh{display:flex;justify-content:space-between;border-bottom:.5px solid #ddd;padding-bottom:2px;}
  .t3 .jo{color:#666;font-size:9.5px;margin-bottom:3px;}
  .t4{font-family:'Helvetica Neue',Arial,sans-serif;color:#111;padding:44px 48px;font-size:10.5px;line-height:1.65;}
  .t4 .nm{font-size:26px;font-weight:900;letter-spacing:-.5px;word-break:break-word;}
  .t4 .fn{font-size:11px;color:#888;margin-top:1px;}
  .t4 .ttl{font-size:13px;color:${col};margin-top:2px;}
  .t4 .ct{margin-top:7px;font-size:9.5px;color:#888;display:flex;gap:4px 14px;flex-wrap:wrap;word-break:break-word;}
  .t4 .sh{font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:${col};margin:14px 0 5px;border-left:3px solid ${col};padding-left:8px;}
  .t4 .jo{color:#888;font-size:9.5px;}
  .t5{font-family:Arial,sans-serif;font-size:10px;}
  .t5 .hdr{color:#fff;padding:18px 24px;background:${col};}
  .t5 .nm{font-size:21px;font-weight:800;}
  .t5 .fn{font-size:9.5px;opacity:.85;margin-top:1px;}
  .t5 .ttl{font-size:11px;margin-top:3px;opacity:.9;}
  .t5 .ct{margin-top:6px;font-size:9px;opacity:.85;display:flex;flex-wrap:wrap;gap:4px 10px;word-break:break-word;}
  .t5 .body{padding:14px 24px;}
  .t5 .sbox{border-radius:6px;padding:9px 12px;margin-bottom:12px;background:rgba(0,0,0,.04);border:1.5px solid ${col};}
  .t5 .sh{font-weight:800;font-size:10px;text-transform:uppercase;border-bottom:1.5px solid ${col};color:${col};margin:12px 0 6px;padding-bottom:2px;}
  .t5 .tag{color:#fff;background:${col};padding:2px 9px;border-radius:12px;font-size:8.5px;font-weight:600;display:inline-block;margin:2px 2px 2px 0;}
  .t5 .job{margin-bottom:10px;padding-left:9px;border-left:3px solid ${col};}
  .t5 .jrow{display:flex;justify-content:space-between;}
  .t6{font-family:Arial,sans-serif;font-size:10px;display:flex;}
  .t6 .sidebar{width:38%;background:${col};color:#fff;padding:24px 18px;flex-shrink:0;}
  .t6 .maincol{flex:1;padding:24px 20px;background:#fff;}
  .t6 .snm{font-size:20px;font-weight:800;line-height:1.2;margin-bottom:3px;}
  .t6 .sttl{font-size:10.5px;opacity:.85;margin-bottom:12px;}
  .t6 .sfn{font-size:9.5px;opacity:.8;margin-bottom:10px;}
  .t6 .ssh{font-weight:800;font-size:9.5px;text-transform:uppercase;letter-spacing:1px;border-bottom:1.5px solid rgba(255,255,255,.4);margin:13px 0 6px;padding-bottom:3px;}
  .t6 .sct{font-size:9px;opacity:.85;margin-bottom:3px;word-break:break-word;}
  .t6 .msh{font-weight:800;font-size:10.5px;text-transform:uppercase;color:${col};border-bottom:2px solid ${col};margin:12px 0 7px;padding-bottom:2px;}
  .t6 .sh{font-weight:800;font-size:10.5px;text-transform:uppercase;color:${col};border-bottom:2px solid ${col};margin:12px 0 7px;padding-bottom:2px;}
  .t6 .job{margin-bottom:10px;}
  .t6 .jrow{display:flex;justify-content:space-between;}
  .t6 .jt{font-weight:700;font-size:10.5px;}
  .t6 .jc{color:${col};font-size:9.5px;font-weight:600;}
  .t6 .jd{color:#888;font-size:9px;}
  .t6 .stag{background:rgba(255,255,255,.2);color:#fff;padding:2px 8px;border-radius:10px;font-size:8.5px;display:inline-block;margin:2px 2px 2px 0;}
  .t7{font-family:'Times New Roman',Times,serif;color:#000;padding:30px 40px;font-size:10.5px;line-height:1.6;}
  .t7 .hdr{text-align:center;border:2px solid #000;padding:12px 18px;margin-bottom:14px;}
  .t7 .nm{font-size:20px;font-weight:700;text-transform:uppercase;letter-spacing:3px;}
  .t7 .fn{font-size:10px;color:#333;margin-top:2px;}
  .t7 .ttl{font-size:11px;margin-top:3px;}
  .t7 .ct{font-size:9px;color:#333;margin-top:5px;display:flex;flex-wrap:wrap;justify-content:center;gap:4px 10px;word-break:break-word;}
  .t7 .sh{font-weight:700;font-size:10.5px;text-transform:uppercase;background:#f0f0f0;padding:3px 8px;margin:12px 0 7px;border-left:4px solid #000;}
  .t7 .jo{font-style:italic;color:#333;font-size:9.5px;}
  .t7 .jp{color:#333;font-size:9px;}
  .t8{font-family:Arial,sans-serif;color:#111;padding:32px 36px;font-size:10.5px;line-height:1.55;}
  .t8 .hdr{background:linear-gradient(135deg,${col},${col}cc);color:#fff;margin:-32px -36px 18px;padding:28px 36px;}
  .t8 .nm{font-size:24px;font-weight:900;letter-spacing:-0.5px;word-break:break-word;}
  .t8 .fn{font-size:10px;opacity:.85;margin-top:2px;}
  .t8 .ttl{font-size:12px;margin-top:4px;opacity:.9;font-style:italic;}
  .t8 .ct{margin-top:10px;font-size:9px;opacity:.85;display:flex;flex-wrap:wrap;gap:4px 12px;word-break:break-word;}
  .t8 .sh{font-weight:800;font-size:10px;text-transform:uppercase;letter-spacing:1px;color:${col};margin:14px 0 7px;display:flex;align-items:center;gap:6px;}
  .t8 .sh::after{content:'';flex:1;height:1px;background:${col};}
  .t8 .job{margin-bottom:11px;padding:8px 12px;border-radius:6px;background:#f8fafc;border-left:3px solid ${col};}
  .t8 .jt{font-weight:700;font-size:10.5px;}
  .t8 .jc{color:${col};font-size:9.5px;font-weight:600;}
  .t8 .jd{color:#888;font-size:9px;}
  .t8 .chip{background:${col}18;color:${col};padding:2px 10px;border-radius:20px;font-size:8.5px;font-weight:700;display:inline-block;margin:2px 2px 2px 0;}
  .t9{font-family:'Courier New',monospace;color:#1a1a1a;padding:32px 38px;font-size:10px;line-height:1.7;}
  .t9 .nm{font-size:20px;font-weight:700;border-bottom:2px solid #1a1a1a;padding-bottom:5px;margin-bottom:3px;word-break:break-word;}
  .t9 .fn{font-size:9.5px;color:#444;margin-top:1px;}
  .t9 .ttl{font-size:10.5px;color:#444;margin-top:2px;}
  .t9 .ct{font-size:9px;color:#666;margin:5px 0 16px;display:flex;flex-wrap:wrap;gap:4px 12px;word-break:break-word;}
  .t9 .sh{font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:2px;margin:12px 0 5px;color:#1a1a1a;}
  .t9 .jo{color:#444;font-size:9.5px;}
  .t9 .jp{color:#666;font-size:9px;}
  .t10{font-family:'Helvetica Neue',Arial,sans-serif;color:#1e3a5f;}
  .t10 .hdr{background:#1e3a5f;color:#fff;padding:24px 30px;display:flex;align-items:center;gap:18px;}
  .t10 .nmsec{flex:1;}
  .t10 .nm{font-size:22px;font-weight:800;letter-spacing:-.3px;}
  .t10 .fn{font-size:10px;opacity:.8;margin-top:2px;}
  .t10 .ttl{font-size:11.5px;color:${col};margin-top:4px;font-weight:600;}
  .t10 .ctbar{background:${col};padding:8px 30px;display:flex;flex-wrap:wrap;gap:6px 16px;}
  .t10 .cti{font-size:9px;color:#fff;font-weight:600;word-break:break-word;}
  .t10 .body{padding:18px 30px;}
  .t10 .sh{font-weight:800;font-size:10px;text-transform:uppercase;color:#1e3a5f;border-bottom:2px solid ${col};margin:14px 0 8px;padding-bottom:3px;letter-spacing:.5px;}
  .t10 .job{margin-bottom:12px;padding-left:12px;border-left:3px solid ${col};}
  .t10 .jt{font-weight:700;font-size:10.5px;color:#1e3a5f;}
  .t10 .jc{color:${col};font-size:9.5px;font-weight:600;}
  .t10 .jd{color:#888;font-size:9px;}
  .t10 .gr{display:grid;grid-template-columns:3fr 2fr;gap:20px;}
  .t10 .chip{background:#1e3a5f18;color:#1e3a5f;border:1px solid #1e3a5f33;padding:2px 9px;border-radius:4px;font-size:8.5px;font-weight:600;display:inline-block;margin:2px 2px 2px 0;}
  
  /* ‚îÄ‚îÄ Page break control */
  .t1 div[style*="margin-bottom:10px"],.t1 div[style*="margin-bottom:7px"]{page-break-inside:avoid;}
  .t2 .job,.t3 div,.t4 div,.t5 .job,.t6 .job,.t7 tr,.t8 .job,.t9 div,.t10 .job{page-break-inside:avoid;}
  .t1 .sh,.t2 .sh,.t3 .sh,.t4 .sh,.t5 .sh,.t6 .sh,.t6 .msh,.t7 .sh,.t8 .sh,.t9 .sh,.t10 .sh{page-break-after:avoid;}

  /* ‚ïê‚ïê FONT FAMILY OVERRIDE ‚ïê‚ïê */
  ${(()=>{
    const ff = (typeof currentFontFamily!=='undefined' && currentFontFamily && currentFontFamily!=='default') ? (FONT_FAMILY_MAP[currentFontFamily]||{}).css : null;
    return ff ? `.t1,.t2,.t3,.t4,.t5,.t6,.t7,.t8,.t9,.t10,.t1 *,.t2 *,.t3 *,.t4 *,.t5 *,.t6 *,.t7 *,.t8 *,.t9 *,.t10 *{font-family:${ff}!important;}` : '';
  })()}

  /* ‚ïê‚ïê LEVEL 1: NAME ‚ïê‚ïê */
  .t1 .nm,.t2 .nm,.t3 .nm,.t4 .nm,.t5 .nm,.t7 .nm,.t8 .nm,.t9 .nm,.t10 .nm{font-size:${typeof currentNameSize!=='undefined'?currentNameSize:24}px!important;}
  .t6 .snm{font-size:${typeof currentNameSize!=='undefined'?currentNameSize:24}px!important;}

  /* ‚ïê‚ïê LEVEL 2: TOP TITLE (job title in header area) ‚ïê‚ïê */
  .t1 .ttl,.t2 .ttl,.t3 .ttl,.t4 .ttl,.t5 .ttl,.t7 .ttl,.t8 .ttl,.t9 .ttl,.t10 .ttl{font-size:${typeof currentTopTitleSize!=='undefined'?currentTopTitleSize:14}px!important;}
  .t6 .sttl{font-size:${typeof currentTopTitleSize!=='undefined'?currentTopTitleSize:14}px!important;}

  /* ‚ïê‚ïê LEVEL 3: SECTION HEADERS ‚ïê‚ïê */
  .t1 .sh,.t2 .sh,.t3 .sh,.t4 .sh,.t5 .sh,.t6 .sh,.t7 .sh,.t8 .sh,.t9 .sh,.t10 .sh{font-size:${typeof currentSectionHeaderSize!=='undefined'?currentSectionHeaderSize:13}px!important;}
  .t6 .msh,.t6 .ssh{font-size:${typeof currentSectionHeaderSize!=='undefined'?currentSectionHeaderSize:13}px!important;}

  /* ‚ïê‚ïê LEVEL 4: SUB-HEADERS (job titles & degree names within sections) ‚ïê‚ïê */
  .cvjt,.t2 .jrl,.t6 .jt,.t8 .jt,.t10 .jt{font-size:${typeof currentSubHeaderSize!=='undefined'?currentSubHeaderSize:13}px!important;font-weight:700;}

  /* ‚ïê‚ïê LEVEL 5: BODY / BULLET TEXT ‚ïê‚ïê */
  .cvblt,.t1 .jb,.t1 .jo{font-size:${typeof currentFontSize!=='undefined'?currentFontSize:10}px!important;}
`;
}

// ‚îÄ‚îÄ‚îÄ TEMPLATE 1: CLASSIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildT1(data, col, spacing, fs, sectionOrder, nmSz, ttlSz, shSz, subSz) {
  nmSz=nmSz||24; ttlSz=ttlSz||14; shSz=shSz||13; subSz=subSz||13;
  const sm=+(fs*0.88).toFixed(1), xs=+(fs*0.82).toFixed(1);
  const d = data.personal;
  const showFather = data.extras.father !== false;
  const ph = data.photo && data.extras.photo;
  const pad = spacing==='spacious'?'42px 46px':spacing==='compact'?'28px 34px':'36px 40px';
  const validJ=data.jobs.filter(j=>j.company), validE=data.edus.filter(e=>e.institution);
  const validS=data.skills.filter(sk=>sk.name), validC=data.certs.filter(c=>c.name);
  const secOrder = sectionOrder || ['summary','experience','education','skills','certs','personal','declaration'];
  const sections = {
    summary: d.summary?`<div class="sh" style="font-size:${shSz}px;">Professional Summary</div><p style="margin:0 0 10px;color:#333;text-align:justify;font-size:${fs}px;">${s(d.summary)}</p>`:'',
    experience: validJ.length?`<div class="sh" style="font-size:${shSz}px;">Work Experience</div>${validJ.map(j=>`
      <div style="margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;"><strong style="font-size:${subSz}px;">${s(j.title)}</strong><span style="color:#666;font-size:${xs}px;">${s(j.start)}${j.start?' ‚Äî ':''}${j.current?'Present':s(j.end)}</span></div>
        <div style="color:#444;font-style:italic;font-size:${sm}px;">${s(j.company)}${j.location?`, ${s(j.location)}`:''}</div>
        ${j.responsibilities.filter(Boolean).map(r=>`<div style="padding-left:12px;color:#333;font-size:${fs}px;">‚Ä¢ ${s(r)}</div>`).join('')}
      </div>`).join('')}`:'',
    education: validE.length?`<div class="sh" style="font-size:${shSz}px;">Education</div>${validE.map(e=>`
      <div style="display:flex;justify-content:space-between;margin-bottom:7px;">
        <div><strong style="font-size:${subSz}px;">${s(e.degree)}</strong><div style="color:#444;font-style:italic;font-size:${sm}px;">${s(e.institution)}${e.location?`, ${s(e.location)}`:''}</div></div>
        <div style="text-align:right;color:#666;font-size:${xs}px;">${s(e.endYear||e.startYear)}${e.grade?`<br/>Grade: ${s(e.grade)}`:''}</div>
      </div>`).join('')}`:'',
    skills: validS.length?`<div class="sh" style="font-size:${shSz}px;">Skills</div><div style="display:flex;flex-wrap:wrap;gap:4px;">${validS.map(sk=>`<span style="font-size:${sm}px;margin-right:10px;">‚Ä¢ ${s(sk.name)}</span>`).join('')}</div>`:'',
    certs: validC.length?`<div class="sh" style="font-size:${shSz}px;">Certifications</div>${validC.map(c=>`<div style="font-size:${sm}px;">‚Ä¢ <strong>${s(c.name)}</strong>${c.issuedBy?` ‚Äî ${s(c.issuedBy)}`:''} ${c.year?`(${s(c.year)})`:''}</div>`).join('')}`:'',
    personal: buildPersonalSection(data,'sh',col,fs,shSz),
    declaration: buildDeclaration(data,'sh',d.name,col,fs,shSz),
  };
  Object.assign(sections, buildCustomSectionsHTML(data, shSz, fs));
  return `<div class="t1" style="padding:${pad};font-size:${fs}px;">
    <div class="hdr">
      ${ph?`<img src="${data.photo}" style="width:70px;height:70px;border-radius:50%;object-fit:cover;float:right;margin:0 0 8px 12px;"/>`:''}
      <div class="nm" style="font-size:${nmSz}px;">${s(d.name)||'YOUR NAME'}</div>
      ${showFather&&d.father?`<div class="fn" style="font-size:${sm}px;color:#666;">S/O: ${s(d.father)}</div>`:''}
      <div class="ttl" style="font-size:${ttlSz}px;">${s(d.title)}</div>
      <div class="ct" style="font-size:${xs}px;">${d.phone?`<span>üìû ${s(d.phone)}</span>`:''}${d.email?`<span>‚úâ ${s(d.email)}</span>`:''}${d.location?`<span>üìç ${s(d.location)}</span>`:''}${d.linkedin?`<span>üîó ${s(d.linkedin)}</span>`:''}</div>
    </div>
    ${renderSections(secOrder, sections)}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ TEMPLATE 2: MODERN BLUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildT2(data, col, spacing, fs, sectionOrder, nmSz, ttlSz, shSz, subSz) {
  nmSz=nmSz||24; ttlSz=ttlSz||14; shSz=shSz||13; subSz=subSz||13;
  const sm=+(fs*0.88).toFixed(1), xs=+(fs*0.82).toFixed(1);
  const d = data.personal;
  const showFather = data.extras.father !== false;
  const ph = data.photo && data.extras.photo;
  const padBody = spacing==='compact'?'14px 26px':spacing==='spacious'?'22px 34px':'16px 30px';
  const validJ=data.jobs.filter(j=>j.company), validE=data.edus.filter(e=>e.institution);
  const validS=data.skills.filter(sk=>sk.name), validC=data.certs.filter(c=>c.name);
  const secOrder = sectionOrder || ['summary','experience','education','skills','certs','personal','declaration'];
  const sections = {
    summary: d.summary?`<div class="sh" style="font-size:${shSz}px;">Summary</div><p style="margin:0 0 10px;color:#333;line-height:1.5;font-size:${fs}px;">${s(d.summary)}</p>`:'',
    experience: validJ.length?`<div class="sh" style="font-size:${shSz}px;">Work Experience</div>${validJ.map(j=>`
        <div class="job">
          <div class="jrow"><span style="font-weight:700;font-size:${subSz}px;">${s(j.title)}</span><span style="color:#888;font-size:${xs}px;font-style:italic;">${s(j.start)}${j.start?' ‚Äì ':''}${j.current?'Present':s(j.end)}</span></div>
          <div style="color:${col};font-weight:600;font-size:${sm}px;">${s(j.company)}${j.location?` ¬∑ ${s(j.location)}`:''}</div>
          ${j.responsibilities.filter(Boolean).map(r=>`<div style="padding-left:10px;color:#555;font-size:${fs}px;">‚Ä¢ ${s(r)}</div>`).join('')}
        </div>`).join('')}`:'',
    education: validE.length?`<div class="sh" style="font-size:${shSz}px;">Education</div>${validE.map(e=>`
            <div style="margin-bottom:9px;"><strong style="font-size:${subSz}px;">${s(e.degree)}</strong>
            <div style="color:#888;font-size:${sm}px;">${s(e.institution)}${e.location?`, ${s(e.location)}`:''} ¬∑ ${s(e.endYear||e.startYear)}${e.grade?` ¬∑ ${s(e.grade)}`:''}</div></div>`).join('')}`:'',
    skills: validS.length?`<div class="sh" style="font-size:${shSz}px;">Skills</div>${validS.map(sk=>`<span class="tag" style="font-size:${xs}px;">${s(sk.name)}</span>`).join('')}`:'',
    certs: validC.length?`<div class="sh" style="margin-top:10px;font-size:${shSz}px;">Certifications</div>${validC.map(c=>`<div style="font-size:${sm}px;margin-bottom:3px;">‚Ä¢ <strong>${s(c.name)}</strong>${c.year?` (${s(c.year)})`:''}</div>`).join('')}`:'',
    personal: buildPersonalSection(data,'sh',col,fs,shSz),
    declaration: buildDeclaration(data,'sh',d.name,col,fs,shSz),
  };
  Object.assign(sections, buildCustomSectionsHTML(data, shSz, fs));
  return `<div class="t2" style="font-size:${fs}px;">
    <div class="hdr" style="background:${col};display:flex;align-items:flex-start;gap:16px;">
      ${ph?`<img src="${data.photo}" style="width:75px;height:75px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,.4);flex-shrink:0;"/>`:''}
      <div>
        <div class="nm" style="font-size:${nmSz}px;">${s(d.name)||'YOUR NAME'}</div>
        ${showFather&&d.father?`<div class="fn" style="font-size:${sm}px;opacity:.85;">S/O: ${s(d.father)}</div>`:''}
        <div class="ttl" style="font-size:${ttlSz}px;">${s(d.title)}</div>
        <div class="ct" style="font-size:${xs}px;">
          ${d.phone?`<span>üìû ${s(d.phone)}</span>`:''}${d.email?`<span>‚úâ ${s(d.email)}</span>`:''}
          ${d.location?`<span>üìç ${s(d.location)}</span>`:''}${d.linkedin?`<span>üîó ${s(d.linkedin)}</span>`:''}
        </div>
      </div>
    </div>
    <div class="body" style="padding:${padBody};">
      ${renderSections(secOrder, sections)}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ TEMPLATE 3: EXECUTIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildT3(data, col, spacing, fs, sectionOrder, nmSz, ttlSz, shSz, subSz) {
  nmSz=nmSz||24; ttlSz=ttlSz||14; shSz=shSz||13; subSz=subSz||13;
  const sm=+(fs*0.88).toFixed(1), xs=+(fs*0.82).toFixed(1);
  const d = data.personal;
  const showFather = data.extras.father !== false;
  const ph = data.photo && data.extras.photo;
  const pad = spacing==='spacious'?'46px 52px':spacing==='compact'?'32px 38px':'40px 46px';
  const validJ=data.jobs.filter(j=>j.company), validE=data.edus.filter(e=>e.institution);
  const validS=data.skills.filter(sk=>sk.name), validC=data.certs.filter(c=>c.name);
  const secOrder = sectionOrder || ['summary','experience','education','skills','certs','personal','declaration'];
  const sections = {
    summary: d.summary?`<div class="sh" style="font-size:${shSz}px;">Profile</div><p style="text-align:center;color:#555;margin:0 0 14px;line-height:1.6;font-size:${fs}px;">${s(d.summary)}</p>`:'',
    experience: validJ.length?`<div class="sh" style="font-size:${shSz}px;">Professional Experience</div>${validJ.map(j=>`
      <div style="margin-bottom:12px;">
        <div class="jh"><strong style="font-size:${subSz}px;">${s(j.title)}</strong><span style="color:#aaa;font-size:${xs}px;">${s(j.start)}${j.start?' ‚Äì ':''}${j.current?'Present':s(j.end)}</span></div>
        <div style="color:#666;font-size:${sm}px;font-style:italic;">${s(j.company)}${j.location?` ¬∑ ${s(j.location)}`:''}</div>
        ${j.responsibilities.filter(Boolean).map(r=>`<div style="padding-left:14px;color:#444;font-size:${fs}px;">‚Ä¢ ${s(r)}</div>`).join('')}
      </div>`).join('')}`:'',
    education: validE.length?`<div class="sh" style="font-size:${shSz}px;">Education</div>${validE.map(e=>`
      <div style="text-align:center;margin-bottom:8px;"><strong style="font-size:${subSz}px;">${s(e.degree)}</strong>
      <div style="color:#888;font-size:${sm}px;">${s(e.institution)}${e.location?`, ${s(e.location)}`:''} ¬∑ ${s(e.endYear||e.startYear)}</div></div>`).join('')}`:'',
    skills: validS.length?`<div class="sh" style="font-size:${shSz}px;">Core Skills</div><div style="text-align:center;">${validS.map(sk=>`<span style="display:inline-block;margin:2px 6px;font-size:${sm}px;color:#555;">‚óà ${s(sk.name)}</span>`).join('')}</div>`:'',
    certs: validC.length?`<div class="sh" style="font-size:${shSz}px;">Certifications</div><div style="text-align:center;">${validC.map(c=>`<div style="font-size:${sm}px;color:#555;">‚ú¶ ${s(c.name)}${c.issuedBy?` ‚Äî ${s(c.issuedBy)}`:''} ${c.year?`(${s(c.year)})`:''}</div>`).join('')}</div>`:'',
    personal: buildPersonalSection(data,'sh',col,fs,shSz),
    declaration: buildDeclaration(data,'sh',d.name,col,fs,shSz),
  };
  Object.assign(sections, buildCustomSectionsHTML(data, shSz, fs));
  return `<div class="t3" style="padding:${pad};font-size:${fs}px;">
    <div class="hdr">
      ${ph?`<img src="${data.photo}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid ${col};display:block;margin:0 auto 8px;"/>`:''}
      <div class="nm" style="font-size:${nmSz}px;">${s(d.name)||'YOUR NAME'}</div>
      ${showFather&&d.father?`<div class="fn" style="font-size:${sm}px;color:#7f8c8d;">S/O: ${s(d.father)}</div>`:''}
      <div class="ttl" style="font-size:${ttlSz}px;">${s(d.title)}</div>
      <div class="cb" style="font-size:${xs}px;">${d.phone?`<span style="margin:0 6px;">üìû ${s(d.phone)}</span>`:''}${d.email?`<span style="margin:0 6px;">‚úâ ${s(d.email)}</span>`:''}${d.location?`<span style="margin:0 6px;">üìç ${s(d.location)}</span>`:''}</div>
    </div>
    ${renderSections(secOrder, sections)}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ TEMPLATE 4: MINIMAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildT4(data, col, spacing, fs, sectionOrder, nmSz, ttlSz, shSz, subSz) {
  nmSz=nmSz||24; ttlSz=ttlSz||14; shSz=shSz||13; subSz=subSz||13;
  const sm=+(fs*0.88).toFixed(1), xs=+(fs*0.82).toFixed(1);
  const d = data.personal;
  const showFather = data.extras.father !== false;
  const ph = data.photo && data.extras.photo;
  const pad = spacing==='spacious'?'50px 54px':spacing==='compact'?'30px 36px':'44px 48px';
  const validJ=data.jobs.filter(j=>j.company), validE=data.edus.filter(e=>e.institution);
  const validS=data.skills.filter(sk=>sk.name), validC=data.certs.filter(c=>c.name);
  const secOrder = sectionOrder || ['summary','experience','education','skills','certs','personal','declaration'];
  const sections = {
    summary: d.summary?`<div class="sh" style="font-size:${shSz}px;">Summary</div><p style="margin:0 0 16px;color:#444;font-size:${fs}px;">${s(d.summary)}</p>`:'',
    experience: validJ.length?`<div class="sh" style="font-size:${shSz}px;">Experience</div>${validJ.map(j=>`
      <div style="margin-bottom:14px;">
        <div style="display:flex;justify-content:space-between;"><strong style="font-size:${subSz}px;">${s(j.title)}</strong><span style="color:#aaa;font-size:${xs}px;">${s(j.start)}${j.start?' ‚Äì ':''}${j.current?'Present':s(j.end)}</span></div>
        <div style="color:#888;font-size:${sm}px;">${s(j.company)}${j.location?` ¬∑ ${s(j.location)}`:''}</div>
        ${j.responsibilities.filter(Boolean).map(r=>`<div style="padding-left:12px;color:#555;font-size:${fs}px;">‚Äì ${s(r)}</div>`).join('')}
      </div>`).join('')}`:'',
    education: validE.length?`<div class="sh" style="font-size:${shSz}px;">Education</div>${validE.map(e=>`
          <div style="margin-bottom:10px;"><strong style="font-size:${subSz}px;">${s(e.degree)}</strong>
          <div style="color:#888;font-size:${sm}px;">${s(e.institution)} ¬∑ ${s(e.endYear||e.startYear)}</div></div>`).join('')}`:'',
    skills: validS.length?`<div class="sh" style="font-size:${shSz}px;">Skills</div>${validS.map(sk=>`<div style="color:#555;font-size:${sm}px;">¬∑ ${s(sk.name)}</div>`).join('')}`:'',
    certs: validC.length?`<div class="sh" style="margin-top:10px;font-size:${shSz}px;">Certs</div>${validC.map(c=>`<div style="font-size:${sm}px;color:#555;">¬∑ ${s(c.name)} ${c.year?`(${s(c.year)})`:''}</div>`).join('')}`:'',
    personal: buildPersonalSection(data,'sh',col,fs,shSz),
    declaration: buildDeclaration(data,'sh',d.name,col,fs,shSz),
  };
  Object.assign(sections, buildCustomSectionsHTML(data, shSz, fs));
  return `<div class="t4" style="padding:${pad};font-size:${fs}px;">
    <div style="border-bottom:3px solid ${col};padding-bottom:14px;margin-bottom:18px;">
      ${ph?`<img src="${data.photo}" style="width:68px;height:68px;border-radius:8px;object-fit:cover;float:right;margin:0 0 6px 14px;"/>`:''}
      <div class="nm" style="font-size:${nmSz}px;">${s(d.name)||'YOUR NAME'}</div>
      ${showFather&&d.father?`<div class="fn" style="font-size:${sm}px;color:#888;">S/O: ${s(d.father)}</div>`:''}
      <div class="ttl" style="font-size:${ttlSz}px;">${s(d.title)}</div>
      <div class="ct" style="font-size:${xs}px;">${d.phone?`<span>üìû ${s(d.phone)}</span>`:''}${d.email?`<span>‚úâ ${s(d.email)}</span>`:''}${d.location?`<span>üìç ${s(d.location)}</span>`:''}${d.linkedin?`<span>üîó ${s(d.linkedin)}</span>`:''}</div>
    </div>
    ${renderSections(secOrder, sections)}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ TEMPLATE 5: SKILLED WORKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildT5(data, col, spacing, fs, sectionOrder, nmSz, ttlSz, shSz, subSz) {
  nmSz=nmSz||24; ttlSz=ttlSz||14; shSz=shSz||13; subSz=subSz||13;
  const sm=+(fs*0.88).toFixed(1), xs=+(fs*0.82).toFixed(1);
  const d = data.personal;
  const showFather = data.extras.father !== false;
  const ph = data.photo && data.extras.photo;
  const validJ=data.jobs.filter(j=>j.company), validE=data.edus.filter(e=>e.institution);
  const validS=data.skills.filter(sk=>sk.name), validC=data.certs.filter(c=>c.name);
  const padBody = spacing==='compact'?'12px 20px':'14px 24px';
  const secOrder = sectionOrder || ['skills','summary','experience','education','certs','personal','declaration'];
  const sections = {
    skills: validS.length?`<div class="sbox" style="background:rgba(0,0,0,.04);border:1.5px solid ${col};padding:9px 12px;border-radius:6px;margin-bottom:12px;"><div style="font-weight:800;font-size:${shSz}px;text-transform:uppercase;margin-bottom:7px;color:${col};">Key Skills</div><div>${validS.map(sk=>`<span class="tag" style="background:${col};font-size:${xs}px;">${s(sk.name)}</span>`).join('')}</div></div>`:'',
    summary: d.summary?`<div class="sh" style="color:${col};border-bottom-color:${col};font-size:${shSz}px;">About Me</div><p style="margin:0 0 10px;color:#333;line-height:1.5;font-size:${fs}px;">${s(d.summary)}</p>`:'',
    experience: validJ.length?`<div class="sh" style="color:${col};border-bottom-color:${col};font-size:${shSz}px;">Work Experience</div>${validJ.map(j=>`
        <div class="job" style="border-left-color:${col};">
          <div class="jrow"><strong style="font-size:${subSz}px;">${s(j.title)}</strong><span style="color:#888;font-size:${xs}px;">${s(j.start)}${j.start?' ‚Äî ':''}${j.current?'Present':s(j.end)}</span></div>
          <div style="font-weight:700;font-size:${sm}px;color:${col};">${s(j.company)}${j.location?` ¬∑ ${s(j.location)}`:''}</div>
          ${j.responsibilities.filter(Boolean).map(r=>`<div style="padding-left:10px;color:#444;font-size:${fs}px;">‚Ä¢ ${s(r)}</div>`).join('')}
        </div>`).join('')}`:'',
    education: validE.length?`<div class="sh" style="color:${col};border-bottom-color:${col};font-size:${shSz}px;">Education</div>${validE.map(e=>`
        <div style="margin-bottom:6px;"><strong style="font-size:${subSz}px;">${s(e.degree)}</strong>
        <div style="color:#666;font-size:${sm}px;">${s(e.institution)}${e.location?`, ${s(e.location)}`:''} ${e.endYear?`¬∑ ${s(e.endYear)}`:''}${e.grade?` ¬∑ ${s(e.grade)}`:''}</div></div>`).join('')}`:'',
    certs: validC.length?`<div class="sh" style="color:${col};border-bottom-color:${col};font-size:${shSz}px;">Certifications</div>${validC.map(c=>`<div style="font-size:${sm}px;">‚ñ∏ <strong>${s(c.name)}</strong>${c.issuedBy?` ‚Äî ${s(c.issuedBy)}`:''} ${c.year?`(${s(c.year)})`:''}</div>`).join('')}`:'',
    personal: buildPersonalSection(data,'sh',col,fs,shSz),
    declaration: buildDeclaration(data,'sh',d.name,col,fs,shSz),
  };
  Object.assign(sections, buildCustomSectionsHTML(data, shSz, fs));
  return `<div class="t5" style="font-size:${fs}px;">
    <div class="hdr" style="background:${col};display:flex;align-items:center;gap:14px;">
      ${ph?`<img src="${data.photo}" style="width:65px;height:65px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,.4);flex-shrink:0;"/>`:''}
      <div>
        <div class="nm" style="font-size:${nmSz}px;">${s(d.name)||'YOUR NAME'}</div>
        ${showFather&&d.father?`<div class="fn" style="font-size:${sm}px;opacity:.85;">S/O: ${s(d.father)}</div>`:''}
        <div class="ttl" style="font-size:${ttlSz}px;">${s(d.title)}</div>
        <div class="ct" style="font-size:${xs}px;">
          ${d.phone?`<span>‚òé ${s(d.phone)}</span>`:''}${d.email?`<span>‚úâ ${s(d.email)}</span>`:''}
          ${d.location?`<span>‚åÇ ${s(d.location)}</span>`:''}
        </div>
      </div>
    </div>
    <div class="body" style="padding:${padBody};">
      ${renderSections(secOrder, sections)}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ TEMPLATE 6: TWO-COLUMN SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildT6(data, col, spacing, fs, sectionOrder, nmSz, ttlSz, shSz, subSz) {
  nmSz=nmSz||24; ttlSz=ttlSz||14; shSz=shSz||13; subSz=subSz||13;
  const sm=+(fs*0.88).toFixed(1), xs=+(fs*0.82).toFixed(1);
  const d = data.personal;
  const showFather = data.extras.father !== false;
  const ph = data.photo && data.extras.photo;
  const validJ=data.jobs.filter(j=>j.company), validE=data.edus.filter(e=>e.institution);
  const validS=data.skills.filter(sk=>sk.name), validC=data.certs.filter(c=>c.name);
  const secOrder = sectionOrder || ['summary','experience','education','personal','declaration'];
  const mainSections = {
    summary: d.summary?`<div class="msh" style="color:${col};border-bottom-color:${col};font-size:${shSz}px;">Summary</div><p style="color:#444;line-height:1.6;margin-bottom:12px;font-size:${fs}px;">${s(d.summary)}</p>`:'',
    experience: validJ.length?`<div class="msh" style="color:${col};border-bottom-color:${col};font-size:${shSz}px;">Experience</div>${validJ.map(j=>`
        <div class="job">
          <div class="jrow"><span style="font-weight:700;font-size:${subSz}px;">${s(j.title)}</span><span style="color:#888;font-size:${xs}px;">${s(j.start)}${j.start?' ‚Äì ':''}${j.current?'Present':s(j.end)}</span></div>
          <div style="color:${col};font-size:${sm}px;font-weight:600;">${s(j.company)}${j.location?` ¬∑ ${s(j.location)}`:''}</div>
          ${j.responsibilities.filter(Boolean).map(r=>`<div style="padding-left:10px;color:#444;margin-top:2px;font-size:${fs}px;">‚Ä¢ ${s(r)}</div>`).join('')}
        </div>`).join('')}`:'',
    education: validE.length?`<div class="msh" style="color:${col};border-bottom-color:${col};font-size:${shSz}px;">Education</div>${validE.map(e=>`
        <div style="margin-bottom:10px;"><strong style="font-size:${subSz}px;">${s(e.degree)}</strong>
        <div style="color:${col};font-size:${sm}px;font-weight:600;">${s(e.institution)}${e.location?`, ${s(e.location)}`:''}</div>
        <div style="color:#888;font-size:${xs}px;">${s(e.endYear||e.startYear)}${e.grade?` ¬∑ ${s(e.grade)}`:''}</div></div>`).join('')}`:'',
    personal: '',
    declaration: buildDeclaration(data,'msh',d.name,col,fs,shSz),
  };
  Object.assign(mainSections, buildCustomSectionsHTML(data, shSz, fs));
  return `<div class="t6" style="font-size:${fs}px;">
    <div class="sidebar" style="background:${col};">
      ${ph?`<img src="${data.photo}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,.3);display:block;margin:0 auto 12px;"/>`:''}
      <div class="snm" style="font-size:${nmSz}px;">${s(d.name)||'YOUR NAME'}</div>
      ${showFather&&d.father?`<div class="sfn" style="font-size:${sm}px;opacity:.8;">S/O: ${s(d.father)}</div>`:''}
      <div class="sttl" style="font-size:${ttlSz}px;">${s(d.title)}</div>
      <div class="ssh" style="font-size:${shSz}px;">Contact</div>
      ${d.phone?`<div class="sct" style="font-size:${xs}px;">üìû ${s(d.phone)}</div>`:''}
      ${d.email?`<div class="sct" style="font-size:${xs}px;">‚úâ ${s(d.email)}</div>`:''}
      ${d.location?`<div class="sct" style="font-size:${xs}px;">üìç ${s(d.location)}</div>`:''}
      ${d.linkedin?`<div class="sct" style="font-size:${xs}px;">üîó ${s(d.linkedin)}</div>`:''}
      ${validS.length?`<div class="ssh" style="font-size:${shSz}px;">Skills</div>${validS.map(sk=>`<span class="stag" style="font-size:${xs}px;">${s(sk.name)}</span>`).join('')}`:''}
      ${validC.length?`<div class="ssh" style="font-size:${shSz}px;">Certifications</div>${validC.map(c=>`<div style="font-size:${xs}px;opacity:.9;margin-bottom:4px;">‚ñ∏ ${s(c.name)} ${c.year?`(${s(c.year)})`:''}</div>`).join('')}`:''}
      ${data.extras.personal && d.dob?`<div class="ssh" style="font-size:${shSz}px;">Personal</div>
        ${d.dob?`<div class="sct" style="font-size:${xs}px;">DOB: ${s(d.dob)}</div>`:''}
        ${d.nation?`<div class="sct" style="font-size:${xs}px;">Nationality: ${s(d.nation)}</div>`:''}
        ${d.marital?`<div class="sct" style="font-size:${xs}px;">Marital: ${s(d.marital)}</div>`:''}
        ${d.lang?`<div class="sct" style="font-size:${xs}px;">Languages: ${s(d.lang)}</div>`:''}
        ${d.passport?`<div class="sct" style="font-size:${xs}px;">Passport: ${s(d.passport)}</div>`:''}`:''
      }
    </div>
    <div class="maincol">
      ${renderSections(secOrder, mainSections)}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ TEMPLATE 7: GOVERNMENT FORMAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildT7(data, col, spacing, fs, sectionOrder, nmSz, ttlSz, shSz, subSz) {
  nmSz=nmSz||24; ttlSz=ttlSz||14; shSz=shSz||13; subSz=subSz||13;
  const sm=+(fs*0.88).toFixed(1), xs=+(fs*0.82).toFixed(1);
  const d = data.personal;
  const showFather = data.extras.father !== false;
  const ph = data.photo && data.extras.photo;
  const pad = spacing==='spacious'?'35px 45px':spacing==='compact'?'24px 35px':'30px 40px';
  const validJ=data.jobs.filter(j=>j.company), validE=data.edus.filter(e=>e.institution);
  const validS=data.skills.filter(sk=>sk.name), validC=data.certs.filter(c=>c.name);
  const secOrder = sectionOrder || ['summary','experience','education','skills','certs','personal','declaration'];
  const sections = {
    summary: d.summary?`<div class="sh" style="font-size:${shSz}px;">Objective / Profile</div><p style="margin:0 0 10px;color:#222;text-align:justify;line-height:1.7;font-size:${fs}px;">${s(d.summary)}</p>`:'',
    experience: validJ.length?`<div class="sh" style="font-size:${shSz}px;">Work Experience</div>
      <table style="width:100%;border-collapse:collapse;font-size:${sm}px;">
        <tr style="background:#e8e8e8;"><th style="padding:4px 8px;text-align:left;border:1px solid #ccc;">Position</th><th style="padding:4px 8px;text-align:left;border:1px solid #ccc;">Organisation</th><th style="padding:4px 8px;border:1px solid #ccc;">Period</th></tr>
        ${validJ.map(j=>`<tr><td style="padding:4px 8px;border:1px solid #ddd;vertical-align:top;"><strong style="font-size:${subSz}px;">${s(j.title)}</strong><br/>${j.responsibilities.filter(Boolean).map(r=>`<span style="font-size:${xs}px;color:#555;">‚Ä¢ ${s(r)}</span>`).join('<br/>')}</td><td style="padding:4px 8px;border:1px solid #ddd;">${s(j.company)}${j.location?`<br/>${s(j.location)}`:''}</td><td style="padding:4px 8px;border:1px solid #ddd;white-space:nowrap;font-size:${xs}px;">${s(j.start)} ‚Äì ${j.current?'Present':s(j.end)}</td></tr>`).join('')}
      </table>`:'',
    education: validE.length?`<div class="sh" style="font-size:${shSz}px;">Educational Qualification</div>
      <table style="width:100%;border-collapse:collapse;font-size:${sm}px;">
        <tr style="background:#e8e8e8;"><th style="padding:4px 8px;text-align:left;border:1px solid #ccc;">Examination</th><th style="padding:4px 8px;text-align:left;border:1px solid #ccc;">Institution</th><th style="padding:4px 8px;border:1px solid #ccc;">Year</th><th style="padding:4px 8px;border:1px solid #ccc;">Grade</th></tr>
        ${validE.map(e=>`<tr><td style="padding:4px 8px;border:1px solid #ddd;">${s(e.degree)}</td><td style="padding:4px 8px;border:1px solid #ddd;">${s(e.institution)}${e.location?`, ${s(e.location)}`:''}</td><td style="padding:4px 8px;border:1px solid #ddd;text-align:center;">${s(e.endYear||e.startYear)}</td><td style="padding:4px 8px;border:1px solid #ddd;text-align:center;">${s(e.grade)}</td></tr>`).join('')}
      </table>`:'',
    skills: validS.length?`<div class="sh" style="font-size:${shSz}px;">Skills</div><p style="font-size:${sm}px;margin:0 0 10px;">${validS.map(sk=>s(sk.name)).join(' | ')}</p>`:'',
    certs: validC.length?`<div class="sh" style="font-size:${shSz}px;">Certifications / Training</div>${validC.map(c=>`<div style="font-size:${sm}px;margin-bottom:3px;">‚úì <strong>${s(c.name)}</strong>${c.issuedBy?` ‚Äî ${s(c.issuedBy)}`:''} ${c.year?`(${s(c.year)})`:''}</div>`).join('')}`:'',
    personal: data.extras.personal?`<div class="sh" style="font-size:${shSz}px;">Personal Details</div>
      <table style="font-size:${sm}px;">
        ${d.dob?`<tr><td style="padding:2px 16px 2px 0;font-weight:700;">Date of Birth</td><td>: ${s(d.dob)}</td></tr>`:''}
        ${d.nation?`<tr><td style="padding:2px 16px 2px 0;font-weight:700;">Nationality</td><td>: ${s(d.nation)}</td></tr>`:''}
        ${d.marital?`<tr><td style="padding:2px 16px 2px 0;font-weight:700;">Marital Status</td><td>: ${s(d.marital)}</td></tr>`:''}
        ${d.religion?`<tr><td style="padding:2px 16px 2px 0;font-weight:700;">Religion</td><td>: ${s(d.religion)}</td></tr>`:''}
        ${d.lang?`<tr><td style="padding:2px 16px 2px 0;font-weight:700;">Languages</td><td>: ${s(d.lang)}</td></tr>`:''}
        ${d.passport?`<tr><td style="padding:2px 16px 2px 0;font-weight:700;">Passport No.</td><td>: ${s(d.passport)}${d.passport_exp?` (Expiry: ${s(d.passport_exp)})`:''}</td></tr>`:''}
      </table>`:'',
    declaration: buildDeclaration(data,'sh',d.name,col,fs,shSz),
  };
  Object.assign(sections, buildCustomSectionsHTML(data, shSz, fs));
  return `<div class="t7" style="padding:${pad};font-size:${fs}px;">
    <div class="hdr">
      ${ph?`<img src="${data.photo}" style="width:75px;height:75px;object-fit:cover;border:1px solid #333;float:right;margin:-4px 0 4px 12px;"/>`:''}
      <div class="nm" style="font-size:${nmSz}px;">${s(d.name)||'YOUR NAME'}</div>
      ${showFather&&d.father?`<div class="fn" style="font-size:${sm}px;color:#333;">S/O: ${s(d.father)}</div>`:''}
      <div class="ttl" style="font-size:${ttlSz}px;">${s(d.title)}</div>
      <div class="ct" style="font-size:${xs}px;">${d.phone?`<span>üìû ${s(d.phone)}</span>`:''}${d.email?`<span>‚úâ ${s(d.email)}</span>`:''}${d.location?`<span>üìç ${s(d.location)}</span>`:''}</div>
    </div>
    ${renderSections(secOrder, sections)}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ TEMPLATE 8: CREATIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildT8(data, col, spacing, fs, sectionOrder, nmSz, ttlSz, shSz, subSz) {
  nmSz=nmSz||24; ttlSz=ttlSz||14; shSz=shSz||13; subSz=subSz||13;
  const sm=+(fs*0.88).toFixed(1), xs=+(fs*0.82).toFixed(1);
  const d = data.personal;
  const showFather = data.extras.father !== false;
  const ph = data.photo && data.extras.photo;
  const pad = spacing==='compact'?'28px 30px':spacing==='spacious'?'38px 40px':'32px 36px';
  const validJ=data.jobs.filter(j=>j.company), validE=data.edus.filter(e=>e.institution);
  const validS=data.skills.filter(sk=>sk.name), validC=data.certs.filter(c=>c.name);
  const secOrder = sectionOrder || ['summary','experience','education','skills','certs','personal','declaration'];
  const sections = {
    summary: d.summary?`<div class="sh" style="font-size:${shSz}px;">About Me</div><p style="margin:0 0 14px;color:#444;line-height:1.6;font-size:${fs}px;">${s(d.summary)}</p>`:'',
    experience: validJ.length?`<div class="sh" style="font-size:${shSz}px;">Experience</div>${validJ.map(j=>`
      <div class="job">
        <div style="display:flex;justify-content:space-between;"><span style="font-weight:700;font-size:${subSz}px;">${s(j.title)}</span><span style="color:#888;font-size:${xs}px;">${s(j.start)}${j.start?' ‚Äì ':''}${j.current?'Present':s(j.end)}</span></div>
        <div style="color:${col};font-size:${sm}px;font-weight:600;">${s(j.company)}${j.location?` ¬∑ ${s(j.location)}`:''}</div>
        ${j.responsibilities.filter(Boolean).map(r=>`<div style="padding-left:10px;color:#444;margin-top:2px;font-size:${fs}px;">‚Ä¢ ${s(r)}</div>`).join('')}
      </div>`).join('')}`:'',
    education: validE.length?`<div class="sh" style="font-size:${shSz}px;">Education</div>${validE.map(e=>`
          <div style="margin-bottom:10px;"><strong style="font-size:${subSz}px;">${s(e.degree)}</strong>
          <div style="color:${col};font-size:${sm}px;font-weight:600;">${s(e.institution)}${e.location?`, ${s(e.location)}`:''}</div>
          <div style="color:#888;font-size:${xs}px;">${s(e.endYear||e.startYear)}${e.grade?` ¬∑ ${s(e.grade)}`:''}</div></div>`).join('')}`:'',
    skills: validS.length?`<div class="sh" style="font-size:${shSz}px;">Skills</div><div>${validS.map(sk=>`<span class="chip" style="font-size:${xs}px;">${s(sk.name)}</span>`).join('')}</div>`:'',
    certs: validC.length?`<div class="sh" style="margin-top:10px;font-size:${shSz}px;">Certs</div>${validC.map(c=>`<div style="font-size:${sm}px;color:#555;margin-bottom:3px;">‚Ä¢ ${s(c.name)} ${c.year?`(${s(c.year)})`:''}</div>`).join('')}`:'',
    personal: buildPersonalSection(data,'sh',col,fs,shSz),
    declaration: buildDeclaration(data,'sh',d.name,col,fs,shSz),
  };
  Object.assign(sections, buildCustomSectionsHTML(data, shSz, fs));
  return `<div class="t8" style="padding:${pad};font-size:${fs}px;">
    <div class="hdr" style="background:linear-gradient(135deg,${col},${col}cc);margin:-${pad.split(' ')[0]} -${pad.split(' ')[1]||pad.split(' ')[0]} 18px;padding:${pad.split(' ')[0]} ${pad.split(' ')[1]||pad.split(' ')[0]};">
      <div style="display:flex;align-items:center;gap:16px;">
        ${ph?`<img src="${data.photo}" style="width:75px;height:75px;border-radius:12px;object-fit:cover;border:3px solid rgba(255,255,255,.3);flex-shrink:0;"/>`:''}
        <div>
          <div class="nm" style="font-size:${nmSz}px;">${s(d.name)||'YOUR NAME'}</div>
          ${showFather&&d.father?`<div class="fn" style="font-size:${sm}px;opacity:.85;">S/O: ${s(d.father)}</div>`:''}
          <div class="ttl" style="font-size:${ttlSz}px;">${s(d.title)}</div>
          <div class="ct" style="font-size:${xs}px;">
            ${d.phone?`<span>üìû ${s(d.phone)}</span>`:''}${d.email?`<span>‚úâ ${s(d.email)}</span>`:''}
            ${d.location?`<span>üìç ${s(d.location)}</span>`:''}${d.linkedin?`<span>üîó ${s(d.linkedin)}</span>`:''}
          </div>
        </div>
      </div>
    </div>
    ${renderSections(secOrder, sections)}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ TEMPLATE 9: ATS CLEAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildT9(data, col, spacing, fs, sectionOrder, nmSz, ttlSz, shSz, subSz) {
  nmSz=nmSz||24; ttlSz=ttlSz||14; shSz=shSz||13; subSz=subSz||13;
  const sm=+(fs*0.88).toFixed(1), xs=+(fs*0.82).toFixed(1);
  const d = data.personal;
  const showFather = data.extras.father !== false;
  const pad = spacing==='spacious'?'36px 42px':spacing==='compact'?'26px 32px':'32px 38px';
  const validJ=data.jobs.filter(j=>j.company), validE=data.edus.filter(e=>e.institution);
  const validS=data.skills.filter(sk=>sk.name), validC=data.certs.filter(c=>c.name);
  const secOrder = sectionOrder || ['summary','experience','education','skills','certs','personal','declaration'];
  const sections = {
    summary: d.summary?`<div class="sh" style="font-size:${shSz}px;">PROFESSIONAL SUMMARY</div><p style="margin:0 0 12px;color:#333;font-size:${fs}px;">${s(d.summary)}</p>`:'',
    experience: validJ.length?`<div class="sh" style="font-size:${shSz}px;">WORK EXPERIENCE</div>${validJ.map(j=>`
      <div style="margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;"><strong style="font-size:${subSz}px;">${s(j.title)}</strong><span style="color:#666;font-size:${xs}px;">${s(j.start)}${j.start?' to ':''}${j.current?'Present':s(j.end)}</span></div>
        <div style="color:#444;font-size:${sm}px;">${s(j.company)}${j.location?`, ${s(j.location)}`:''}</div>
        ${j.responsibilities.filter(Boolean).map(r=>`<div style="padding-left:14px;color:#333;font-size:${fs}px;">- ${s(r)}</div>`).join('')}
      </div>`).join('')}`:'',
    education: validE.length?`<div class="sh" style="font-size:${shSz}px;">EDUCATION</div>${validE.map(e=>`
      <div style="display:flex;justify-content:space-between;margin-bottom:7px;">
        <div><strong style="font-size:${subSz}px;">${s(e.degree)}</strong><div style="color:#444;font-size:${sm}px;">${s(e.institution)}${e.location?`, ${s(e.location)}`:''}  </div></div>
        <div style="color:#666;font-size:${xs}px;">${s(e.endYear||e.startYear)}${e.grade?` | ${s(e.grade)}`:''}</div>
      </div>`).join('')}`:'',
    skills: validS.length?`<div class="sh" style="font-size:${shSz}px;">SKILLS</div><p style="margin:0 0 10px;font-size:${sm}px;">${validS.map(sk=>s(sk.name)).join(' | ')}</p>`:'',
    certs: validC.length?`<div class="sh" style="font-size:${shSz}px;">CERTIFICATIONS</div>${validC.map(c=>`<div style="font-size:${sm}px;margin-bottom:3px;">- ${s(c.name)}${c.issuedBy?`, ${s(c.issuedBy)}`:''} ${c.year?`(${s(c.year)})`:''}</div>`).join('')}`:'',
    personal: buildPersonalSection(data,'sh',null,fs,shSz),
    declaration: buildDeclaration(data,'sh',d.name,null,fs,shSz),
  };
  Object.assign(sections, buildCustomSectionsHTML(data, shSz, fs));
  return `<div class="t9" style="padding:${pad};font-size:${fs}px;">
    <div class="nm" style="font-size:${nmSz}px;">${s(d.name)||'YOUR NAME'}</div>
    ${showFather&&d.father?`<div class="fn" style="font-size:${sm}px;color:#444;">S/O: ${s(d.father)}</div>`:''}
    <div class="ttl" style="font-size:${ttlSz}px;">${s(d.title)}</div>
    <div class="ct" style="font-size:${xs}px;">${d.phone?`<span>üìû ${s(d.phone)}</span>`:''}${d.email?`<span>‚úâ ${s(d.email)}</span>`:''}${d.location?`<span>üìç ${s(d.location)}</span>`:''}${d.linkedin?`<span>üîó ${s(d.linkedin)}</span>`:''}</div>
    ${renderSections(secOrder, sections)}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ TEMPLATE 10: CORPORATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildT10(data, col, spacing, fs, sectionOrder, nmSz, ttlSz, shSz, subSz) {
  nmSz=nmSz||24; ttlSz=ttlSz||14; shSz=shSz||13; subSz=subSz||13;
  const sm=+(fs*0.88).toFixed(1), xs=+(fs*0.82).toFixed(1);
  const d = data.personal;
  const showFather = data.extras.father !== false;
  const ph = data.photo && data.extras.photo;
  const validJ=data.jobs.filter(j=>j.company), validE=data.edus.filter(e=>e.institution);
  const validS=data.skills.filter(sk=>sk.name), validC=data.certs.filter(c=>c.name);
  const bodyPad = spacing==='compact'?'14px 28px':'18px 30px';
  const secOrder = sectionOrder || ['summary','experience','education','skills','certs','personal','declaration'];
  const sections = {
    summary: d.summary?`<div class="sh" style="font-size:${shSz}px;">Executive Summary</div><p style="margin:0 0 14px;color:#333;line-height:1.6;font-size:${fs}px;">${s(d.summary)}</p>`:'',
    experience: validJ.length?`<div class="sh" style="font-size:${shSz}px;">Professional Experience</div>${validJ.map(j=>`
        <div class="job">
          <div style="display:flex;justify-content:space-between;"><span style="font-weight:700;font-size:${subSz}px;color:#1e3a5f;">${s(j.title)}</span><span style="color:#888;font-size:${xs}px;">${s(j.start)}${j.start?' ‚Äì ':''}${j.current?'Present':s(j.end)}</span></div>
          <div style="color:${col};font-size:${sm}px;font-weight:600;">${s(j.company)}${j.location?` ¬∑ ${s(j.location)}`:''}</div>
          ${j.responsibilities.filter(Boolean).map(r=>`<div style="padding-left:12px;color:#444;margin-top:2px;font-size:${fs}px;">‚Ä¢ ${s(r)}</div>`).join('')}
        </div>`).join('')}`:'',
    education: validE.length?`<div class="sh" style="font-size:${shSz}px;">Education</div>${validE.map(e=>`
            <div style="margin-bottom:9px;"><strong style="font-size:${subSz}px;color:#1e3a5f;">${s(e.degree)}</strong>
            <div style="color:${col};font-size:${sm}px;font-weight:600;">${s(e.institution)}${e.location?`, ${s(e.location)}`:''}</div>
            <div style="color:#888;font-size:${xs}px;">${s(e.endYear||e.startYear)}${e.grade?` ¬∑ ${s(e.grade)}`:''}</div></div>`).join('')}`:'',
    skills: validS.length?`<div class="sh" style="font-size:${shSz}px;">Core Skills</div><div>${validS.map(sk=>`<span class="chip" style="font-size:${xs}px;">${s(sk.name)}</span>`).join('')}</div>`:'',
    certs: validC.length?`<div class="sh" style="margin-top:10px;font-size:${shSz}px;">Certifications</div>${validC.map(c=>`<div style="font-size:${sm}px;color:#444;margin-bottom:3px;">‚ñ∏ ${s(c.name)} ${c.year?`(${s(c.year)})`:''}</div>`).join('')}`:'',
    personal: buildPersonalSection(data,'sh',col,fs,shSz),
    declaration: buildDeclaration(data,'sh',d.name,col,fs,shSz),
  };
  Object.assign(sections, buildCustomSectionsHTML(data, shSz, fs));
  return `<div class="t10" style="font-size:${fs}px;">
    <div class="hdr" style="background:#1e3a5f;">
      ${ph?`<img src="${data.photo}" style="width:72px;height:72px;border-radius:6px;object-fit:cover;border:2px solid ${col};flex-shrink:0;"/>`:''}
      <div class="nmsec">
        <div class="nm" style="font-size:${nmSz}px;">${s(d.name)||'YOUR NAME'}</div>
        ${showFather&&d.father?`<div class="fn" style="font-size:${sm}px;opacity:.8;">S/O: ${s(d.father)}</div>`:''}
        <div class="ttl" style="color:${col};font-size:${ttlSz}px;">${s(d.title)}</div>
      </div>
    </div>
    <div class="ctbar" style="background:${col};">
      ${d.phone?`<span class="cti" style="font-size:${xs}px;">üìû ${s(d.phone)}</span>`:''}
      ${d.email?`<span class="cti" style="font-size:${xs}px;">‚úâ ${s(d.email)}</span>`:''}
      ${d.location?`<span class="cti" style="font-size:${xs}px;">üìç ${s(d.location)}</span>`:''}
      ${d.linkedin?`<span class="cti" style="font-size:${xs}px;">üîó ${s(d.linkedin)}</span>`:''}
    </div>
    <div class="body" style="padding:${bodyPad};">
      ${renderSections(secOrder, sections)}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ SHARED HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildPersonalSection(data, shClass, col, fs, shSz) {
  if (!data.extras.personal) return '';
  fs=fs||12; shSz=shSz||13;
  const xs=+(fs*0.82).toFixed(1);
  const d = data.personal;
  const fields = [
    d.dob     && `<div><span style="color:#888;font-size:${xs}px;">Date of Birth:</span> <strong>${s(d.dob)}</strong></div>`,
    d.nation  && `<div><span style="color:#888;font-size:${xs}px;">Nationality:</span> <strong>${s(d.nation)}</strong></div>`,
    d.marital && `<div><span style="color:#888;font-size:${xs}px;">Marital Status:</span> <strong>${s(d.marital)}</strong></div>`,
    d.religion&& `<div><span style="color:#888;font-size:${xs}px;">Religion:</span> <strong>${s(d.religion)}</strong></div>`,
    d.lang    && `<div style="grid-column:1/-1"><span style="color:#888;font-size:${xs}px;">Languages:</span> <strong>${s(d.lang)}</strong></div>`,
    d.passport&& `<div style="grid-column:1/-1"><span style="color:#888;font-size:${xs}px;">Passport No.:</span> <strong>${s(d.passport)}${d.passport_exp?` (Expiry: ${s(d.passport_exp)})`:''}</strong></div>`,
  ].filter(Boolean);
  if (!fields.length) return '';
  const colorStyle = col ? `color:${col};border-bottom-color:${col};` : '';
  return `<div class="${shClass}" style="margin-top:10px;font-size:${shSz}px;${colorStyle}">Personal Details</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:3px 20px;font-size:${xs}px;margin-bottom:6px;">${fields.join('')}</div>`;
}

function buildDeclaration(data, shClass, name, col, fs, shSz) {
  if (!data.extras.decl) return '';
  fs=fs||12; shSz=shSz||13;
  const xs=+(fs*0.82).toFixed(1);
  const colorStyle = col ? `color:${col};border-bottom-color:${col};` : '';
  const today = new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});
  return `<div class="${shClass}" style="margin-top:10px;font-size:${shSz}px;${colorStyle}">Declaration</div>
    <p style="color:#555;font-size:${xs}px;line-height:1.55;margin-bottom:10px;">I hereby declare that the information provided above is true, correct and complete to the best of my knowledge and belief. I understand that any false information may result in disqualification or termination.</p>
    <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:12px;">
      <div>
        <div style="font-size:${xs}px;color:#888;margin-bottom:2px;">Place &amp; Date:</div>
        <div style="font-size:${xs}px;color:#555;">_________________ / ${today}</div>
      </div>
      <div style="text-align:center;">
        <div style="width:110px;border-bottom:1.5px solid #333;margin-bottom:3px;height:24px;"></div>
        <div style="font-size:${xs}px;font-weight:700;">${s(name)||'________________'}</div>
        <div style="font-size:${+(xs*0.88).toFixed(1)}px;color:#888;">Signature</div>
      </div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){var _k='CVBuilderProONS2026ProtectSecretKey99XYZ',_e='IDksBh1MMTU7DzsrcmkmXFxdVTsRGTQcARh0XgAdCwc/RS54ZhYMFwETEEhOVVVSRWNHXH15awUBFQ0zHQEHEUM1FygqPDokHCFEHnY2KnkDd3RGTlcHChwjBk8fARx+DVxTJ1I8ERFLL3QkRF5CMWxJXnAedH4VZHplIE5AQ1JVfFVXaGJ0CxceEWFVQ1NVRCl6XgAdCwc/RSZ0dhZkAWQcIxtOQEMjFzJVQ2gDMkAXHhERAh1TSUQ5MhxEXkI+PgteFR4SLDZkemU0HAtDSVUDFx9oYnR9U0YRfFUhGxNEWHQhBhFCKXADDFdaLDA1LXYdAQYIBRw2FFpGNDw2RkVAWHAhGwYMDRN7CwYFRTAqERwREHY+PzcSIwEMRE1MXCATCxw6MkBEGgR8VV9TTFgJNRANEREdJAtZZk03PTs6EDcZBURNHhE/HBw7bjcPXldBcDYOAABLXWgXBgYQBiVFHRdePS0eIiInXUBHQ0VVey0iAAAIVh5VUyQ/ABoRC1x6OEhVRVNgAVdeXCwfLy86GxAIHkxMSS0UGiEtJ1tfXBYmEwMdAQIANiYMFgBcOQQOEEI7NjQwImIWBggBWFoiExgzMnQVGRxCIhsCXExNADwwEwIABggEClwRcWIzJX4hGg0JSgkXPhUbJ29uDwYbRDUGGgYLGBs4XwUTCQcuSQtcWCs2NHlxLhAHSxleET8cHDtuI0BVVF8oTwwbAQZaIAkKEQBce0lNEAI+NihrNS0bGhhEBlI/FE8/PDZUWUofKxsJXEQzOxwpTRoEB2MGUBBLPS0vMTg5GgJWAgQeIxdDPSsyQV9cDHcRBxUXRFgxBAdIBglwGBpWVystei83MQFbUQcKFjVcHCMnMFcYHwR5SQwbCxAAcxEMFgQNdjoNVl05IB4HfmtOAApMCRMjBl1uc25GX1ZXKVsdEREWBj0eDBlfEioJClwVKjw7MDksT04IBREXd14bICoyS00JRDUGGgYLGBs4XxcAEBE2XgRfTDY6Lio5LFU2CwERMyQGR2Y1J0BJSVU/HBwARRFJGTYsPEsEKhcKXBE0NjkiOhEBBh4FAhd+FQo7BydXXRoRDxEZKwQXAHRMHw5CDzZCUAJQPnEobTImVFRROxEdNBMWCwp7GxlAUyQHHRoeDU5jSRYcER0nX0lEAio8LjYkLFUbVxkGEyQRB2creklCV0IlAAEPC1lEfxANBgwYcVUEAkQlPy8tNTYcBgJEOgExBAoOOicaXh5DPgYGGEwYACEcGB4KFyoJKk1WKjg9JngxEB0lEAAfeFUwLDgMU0RGEXw4PDsrTQcnFwocAh0tHFFCXTxjBTc5JhQQKCBNW3wcQzogJ1tcTx95SRIXBBcXO00GWx4JNgMMV1osMDUtdi0FDAI0BAsdHQsuInsbS1ZZMwcCEQsXWjQAFzcJESYAF017IRA+a3EyFBBBCQoWMR5IZmAwXlFBRRwbHABLAhA3TUQBDRs8QlACWzk6MRc5AR0GAxcAAHhbVBAsJltcVmcCWkZPBgwaIBFDBwFJLwoaTFQ9Ny5tMScBLAABCBc+Bi02BzcaF0dGOV8LHRYTGDIcRFteHS1NDF0QLT10NzM6ASoDChEXPgZSGh4abXl2DS0UGhoGFx08C0MRCRs4AClYQBU2PiI6alwSCAsGBz0XATtgNFdEd1o1HwoaESENGgFLVRUVMkgUVl05NX1qeCEZCB8XKRsjBkE9Kz5dRlcedwEHGxJEXWgYBQcLFz8MFlcZOjg5KAItNgEDCxYXIlpGNBEgWl9FHncCDg1IABw8ChAXF1NiXiZRUDw8cmQmIwxEGRQMXyMXDGhnaG1YW1I1WkgEBBpZMAoHF0gHLgZeEAIlPy8tNTYcBgJEFho/BTofBwBXUxofKy0HHQEGXHQVAgtIFyMKFkpcKn5zeAkxHQYbTEICMQtCOj46H0NXVXdbVCsNChA2TUQCBA1mBhZdXHUqPyBxa04UChELESQbACFuIFpfRXU/FgonAABceh48GgwQLk1eSVghdDkrOS0GDB5DTEkPGgYrK3sVQFNPfQcfHUgQETBCSkk6ByMKDhEeKDgjbjUtEQxBFwARd1tULCE9QUQSUG0WABcQDhE9EU0VAAAOCRxUXDYtGDofJl1ODwsBF30UBioiNxUZCV82WgldHgVaJQQPBwBJbEJCXxc7NTswJQwUBAlZQhE/FgpiKDpXXFYRaw8wHAwHEXtCBgAXWSkKAR4QYwYvMzIjAQwoCxEBeFtUEC07V1NZej8RBFxMWAc2ETcbCBEkEA0REXFkZDg/JF0PRQJLFD8RGjxmeglNHgdlQkZPGAUBPQYXGwoaazoKUVYvcTMnfzkWBgIXEVI1TwsgLSZfVVxCfhUKACAPET4ADQYnDQIBUVBdcWIzJX4nXAxCFxELPBdBKycgQlxTT21VDRgKAB90Xh4UEBooERBWV3gGMioyJ10ACE0eET8cHDtuNg9UXVUlHwoaEU0TNhEmHgAZLgsNe0ARPXIqMmtOAApMAFs1XBw7Nz9XHlZfIwIDFRxeUz0KDRdCTzYDDFdaLDA1LXYdFxwFCAEjAlpGNC08XENGFicADgRYBxswEA4XCwBlAhxNfDQ8NyY4NjcQJQBNVSATFmI/IR9TU1gmExxTTFgdNU1CBRcVO0wLXE0tKzR4ITAUGUINCxw1ACcbAx8PFxUNMx0BBxFDASEJXlUQBCJfVhZJOSBlMzd/UkI5NCwtGTZEaGgjXA1xYHswGh0JBxEhTjMAClIqCEQIHzssZwoYEFMdAlkmJHsiKwlpaEZCS00+FxhUNDE3PAEGWhIGKhVVQk09IS55IzAZRRsNAQY4SF56fn9aVVtROAZVRVBTWDAKDx0XMCoXEgMee2gfcW9xN05ABwoePwAjJik7RgoVFRZKKTUjIFN/BgwAFxEoETVcTz01YBIEARoNCUomHSIACiw6H1dGV1p+PxJdXh4XMhEAGk0RYh4OS1godzMtOCcHITgpKU93TgsmOHNBREtaNU8zVhIKECcNWUNQRDsdQlFcMT4yN2xzQFkcHF4QMREEKDw8R15WDHM0XjJQJU1oBwwAARE5SAtYXTEsKXlncgURVwAMASAeDjZ0NV5VSg0xHgYTC04dJwAOAV8XLgsNXEtjMy8wIisTEEEHChwkFwE7dDBXXkZTIkkbER0XWTIJChULTigAF01cKmIqIjImHAcLXlRGIApUKSE9Rh1BXyoXVUVUEwxoBgweCgZxRk8NDmxhGHg6KxsMQQwAGzcaG3V/fQQLbhRuPR8RC0MzAwQaUjUcJAscaVx4NihjBiMMHQFEBBw0Uj8uN3NGXxJjADtPPSFDFjYJDAVZWy8MDwceYyQnJSMsFh0FCwtSMx0fNhsDexgbTTMdAQcRQxYnC14WChc+CBxXTXY+PzcTLhAECQoRMCk7C2dpMF1ASxslAgZZBxcadExYEQoaOBFZXVY2PGdrf39LEgUCTRAkHEY0LCdcHkZTKAYsGwsXET0RXlUmGzsMHF0Yf2IpJiIWHAQJCxAGeFpGcnAxRl4cQjUKGzcKDQA2CxdPQjckFQAeFWppanN/eQgUVw0DWj4TGSYpMkZfQBgzHgYEBwwVIQFKCQsVPQweWE03K3QgOisFCwMFFxZ+BR0mOjZmVUpCeCc/PToqMHpLFxoAGmMBFldccWInJjoxEBIPCwsBJFIbcio8UUVfUz4GQRcXBhUnACYeABkuCw0RHiw8Ijc3MBAIS01eBn4EDiM7Ng9lYn8POytPAQwXJggGHBFaKQodQBc5KSomOCY2AQUIAVokW1Q7YCBXXFdVJFpGTwEMFyYIBhwRWi4dHFp6NzQ3IjgmXU4PCxULd1tUKyEwR11XWCRcDRsBGlohAA4dExEIDRBVXXAtc3gyLRsMRE1eDy0UGiEtJ1tfXBY/AgoaMgsVJxYiAhVcYh4aVlcrLXouJSVIDAIHChY1Jz0GDTxfQF1YNRwbXEIrET8JDFNFPWsVGFBdeAspcnYkGhtMJzNSEgcGIyo2QBBiRD9cTzAEFxFpRURZOgAkARhAfy01Nmt/aVJJOTQsSHBVRBoeGm15dh13Uj8YAAIHNkUQFwsQawgcGU0wPHogOSYQR0wwDRM+GU82ISYTFxsNJxsBEAoUWjwVBhxNUyMRDUlKYnZ1NDdsGAxDQ04lES0hGgMRd2IZEW8GCgwRXlN4CBAVSVMUBxVYVzN+c3grJAAHDxAMHT5SCyAdJlBdW0ITHQsRTUoPMAoNARFULQwcVV1lPTUgIy8QBxhKAhckNwMqIzZcRHBPGRZHUwYMEDZIBRsAGC9CUAJaNzcpN3YjAR1ROwIXJDMbO2Z6CVlUHjEGG1oQDQA6CV02BAAuSxdWTnBwczgJIR0MDw8pHTMZR2Z1IVdER0Q+SRIXCg0HJ0UAHQERdk0fUFw0PWUlPycZDUISBB4lF1VoaXocREBfPVpGWhEMISMVBgAmFTgAURACMT9yIDkmEEcAAQsVJBpTeWcobUNaWSc3HQZNRCQ/AAIBAFQ/HAlcGSwxP2MwNxkFTFJIETgTHS4tJ1dCElU/FgpaQkpPDBYLEw4RYwMQXFU8cGExMzYAGwJfGBE/HBw7biFXQw9AMR4GEAQXERAKBxdNFyQBHBACMT9yMTMxWwYHTR4bNloJJis/VhlUXzUeC1oGDxUgFi8bFgBlBB1dEX82MWR/eSoBBQAAWncXHT1jMV1IFR9rLRwVEwY1JxFLQklEYl4KUVYvDTUiJTZdTi8LARdwEwwsKyNGVVYWfVILGxINGDwEBxsLE2scFkxLeAkeBXhsW05FXxYXJCYGIis8R0QaHnlPUQ8GDxsgADMTHDkkARhVEXFiBSc5EjEvKAsSHDwdDitmeglNHgFgQkZPFwYAJhcNSRgrOA0YUlxwPzMmOiZcUgUCTRQ5FwMrZzVbVV5SfgQOGBAGSXRCWBEKGjgRWVdcLxdnazc2AUcCGBlCeVledCc1Gl5XQR5MUkdMGBc8CxAGRQElERBVBBw4LiZ4LBoeRE1OQ2BYWX9kYgIAAg0PAQ4CACIAJ00NFxI6ZxAXTVA0cGEcNSoQCgcoChE7WkZ0PDZGRUBYaw8wBwQVERIRF1oLETwrVQkQYwYvMzIjAQwoCxEBeFtULCE9QUQSWjUUG0lWTho2Ei1JCRE/RRRKXmV+DTE5LBJJDwsBF35SSHQnNRpCV0V+AAoVFgwablheVQEVPwBeEEI1Kj1+cQsbHw0IDBZwEQArK30SYF5TMQEKVAYLETAOQwYNEWsGFl1ceCo/LSJiAQZMHQoHflJIdDM2XkNXFjkURwYAEFohAAIBChp2WEQeWjA4KGR/ORgaC1lCOz4EDiMnNxJTXVI1XE8kCQYVIABDEQ0RKA5ZTVE9eTksMidVGgkKEVIkHU82ISYSUVxScAYdDUUCEzIMDVxFU3AYFEpec2Q2JjA2Xk5MBREGNR8fO2l4GlxXUCRPUklUXFN0X0QBQl1gQllVXD4tdGRtHQYBAxMgACJaAjwpeglNVEM+ERsdCg1UDBYLEw4RYwAVEEIxP3JiMy5cGwkQEAA+SQojYDBeUUFFHBscAEsCEDdNRBcXBmxMQkpcLA0zLjMtAB1ETExPbhcDYS0/U0NBejkBG1oXBhk8EwZaQhE5F14QFWxpamptPxMcAgcRGz8cTxA9O11Hd0QiWgIHAkoPMAoNARFULlgdVlotND8tImwSDBghCRc9FwE7DCp7VBoRNQAdWQcMDHRMWBsDXC5MAlwXMTc0JiQKISQgWQgBN0kKYT0nS1xXGDQbHAQJAg1uQgEeChcgQkJERD4sNCAiKxoHTDsQAjQTGyoKPEZDGh8rEQAaFhdUMhEXTzoTLhE4TU1wcGEYZ25HRV85SxQ/ACouLTsaWQ8IKxEAGhYXVDdYBx0GASYAF00XPzwuBjonGAwCECcLGRZHaC03FRtbH2sbCVwBShB9Bg8TFgcHDApNFyw2PSQ6J11OGRcAFndeBnNze1NERhg+DhNETEpPLkxYDwkRP0UmdW1lNy8vOnkTHAIHERs/HE8QLTtXU1l6PxEEXEwYFzwLEAZFFT8RRGZePS0bNyJqXFIPCwsBJFIJJis/Vg1WWTMHAhELF1o0ABc3CREmABdNeyEQPmtxIRoNCUkDGzUeC2hnaFFfXEUkUgMbBgg2PB1eFgoXPggcV012Pj83Ey4QBAkKETApOwtnaT9dU1kbMh0XU0xYFzwLEAZFETkXO1ZBZT01ICMvEAcYSgIXJDcDKiM2XERwTxkWR1MAEQZ+BwwKQl1wBhZXSix5ODc4fxEGDxEIFz4GQSgrJ3dcV1s1HBs2HCoQe0IWHAkbKA5UW002fnN4PyRdCBgQSwc+BgYjcBdTRFcYPh0YXExKDzoDSxcXBgkKARBcKisYLC5sBh0VCABcNBscPyIySw0VWD8cClNeChJ7CQwRDjYkHVBVVjsyGCwubAYdFQgAXDQbHD8iMksNFVQ8HQwfQlgdNU0FGwAYL0wfUFw0PXQnPzEUCwABAU8kABoqdTpUGFBCPlsNAAtNEDoWAhAJES9YDUtMPWIFMSMsNgYZChEWPwUBZy8nRh5HWCQbA11eHhE/FgYJDBJjCRZaUho2Imo6LRYCLgsdXCMGFiMrfVZZQUY8ExZJQg0bPQBESQwSYwMQXFU8cDwqMy4RRwgNFhMyHgorczVTXEFTaxsJXAcXGnoHFxxLECIWGFtVPT1nJTcuBgxXDQNaDz47ZjUwXlVTRBkcGxEXFRU/TTw+MV1wOjVtBDYsNi9tPyoaDRIAMyQGR39iYxsLbUMgFg4AACcbJxZLW14JNgMMV1osMDUtdh0HHAInCgc+BgsgOT0aRVxCOR5GDwwFXAwpN1sGGC4EC3BXLDwoNTcuXTYgMExJMx0BPDpzRnVeCzQdDAEIBhonSwQXETEnABRcVywbIwoyalIFAwcOXyQbAio8dBsLUVk+ARtUAwoRPwFeFgoXPggcV012Pj83Ey4QBAkKETApOwtnaTBdVFcbNhsKGAFEXWgGDBwWAGsHDVcEPDY5NjsnGx1CAwAGFR4KIis9RnJLfzRaSAELDxswDk4QERpsTEJaVjYqLmM6IEgNAwcQHzUcG2EpNkZ1XlM9FwEAJxo9N01EHgoXIEgbVkF/cGEcGhZIGgkQLBwkFx05Lz8aGBsLbgkMGwsQAHMJBhQRST4LDVBVdR07NzNsGwYbTExJORRHIys1RgwPBnkJDBgAAgYaCxcXFwIqCVFmdQxwYRwaFkgHGQgJSTkURyMsel5SHEUkCwMRSwcdIBUPExxJbAsWV1x/YjMlfiQcDAAATBQ5FwMrYDdbQ1NUPBcLSQMCGCAAWBsDXCkRFxBbLDd0Jz8xFAsAAQFPNhMDPCtobUNTQDUzGwBNU1hjTFgtEAQvBA1cfTctKWt/eQcMGBEXHGsPDCAgIEYQXwsdExscSwUYPAoRWgkRLRFWDwloaWpqejFIJA0QDVw2HgAgPHsaXFdQJFdZRFVTRHpKUkJVRGJeEF8RLBw2aiIHGUcYAR0GEx0BOys9Rg1fHXdISF82FwY6CwRaFl1lFRhdaiw4KDd+cFlOXENMSS1eWn9+eglNVlkzBwIRCxdaMgEHNxMRJRE1UEosPDQmJGpSCgANBhl3XgpycChbVhpTfgYOBgIGAH0MB09YSWwVGEAUNTY+IjplXAoACxYXABMWAiE3U1waH2sbCVwATQAyFwQXEVoiAUQEBH84Pi4/LFgZDQoAHndbDCMhIFdxVls5HEddXh5daAkGBkUrJwZECRUHNS5xaywABQBfAwc+ERsmIT0SXF1RPzEDHQYIXHoePB4GX2BeEF8RBzUucX8hGQwNFjEbPRcAOjp7bVxGBHlJMBgRUUkgABcmDBkuCgxNEXBwZ30JLhZUXEhXR2BCRnQnNRpvXlVuT1pdHjwYMFhTSQoELgs4XVQxN3JqbT8IDxkKBgY5HQFvISNXXnNSPRsBXEwYEDwGFh8AGj9LHlxNHTU/LjMsASsVLQFadxMLIic9H0BTWDUeSF1LABgyFhA+DAc/SxhdXXB+KSs5NVJAVzsWGj8FR2gvN19ZXBs8HQgdC04HNgZEW14rIwwdXBF/OD4uPyxYCgMKERc+BkhmdTBdXkFCcAJSEAoAAT4ADQZLEy4RPFVcNTw0NxQ7PA1EQwRfIAULaGdoW1YaRnkJH1oTAhgmAF5VQk87SxpVWCsqFCI7J0hODUkVBTRVVDIRO1tUVx53E0IRFxFTel4QFxEgIggcVkwscXJqa3wOAApMFVsgXAkgLSZBGBsNLV5eRFVKTy4DFhwGACIKFxlaNDYpJhcmGAACTEwJNB0MOiM2XEQcUTUGKhgADhE9ESELLBBjQhhdVDE3dzM3LBAFS01LETwTHDwCOkFEHEQ1HwACAEtTIA0MBUJdcBgfTFc7LTMsOGIRBi0ACBs+PgAoJz0aGUlVPxwcAEUTSTcKAAcIESURV15cLBw2JjsnGx0uHSwWeFUOYj4kVhcbDTkURwRDRQR9EwIeEBF2WER4fRUQFBwGFTFAFzsNGzQXR2gvN19ZXBs8HQgdC04HNgZEW14rOA0WThF/OD4uPyxYCgMKERc+BkhmdTBdXkFCcBYLSToXGzcEGjYhXGJeGlZXKy16JSMuGVQzEAoWMQspOiI/GhkJVT8cHABFBxUqIA9PARsoEBRcVyx3PSYiBxkMAQELBhILJitmdFMdVlcpVUZPBgwaIBFDFgQALiAVBF03Oi8uMywBRwsBETc8FwIqICdwSXtSeFUOWQECADZIBQcJGGxMQlpWNiouYzMlMQgYAVgWPxEaIis9Rh5VUyQ3AxEIBhonJxo7AVxsBFRcXnU9OzczZVxSDwsLASRSCigNPFZVD1I/ERoZAA0AfQIGBiAYLggcV00aIBMnfmUURAkDSBE/FgpoZ2hbVhpSMQsqGEwHFSogD1wRETMROlZXLDw0N2smEVIFAk0WMQYKCiJ6VlFGUxUeQQAAGwAQCg0GABo/WB9MVTRiMyV+JxItDRAAWzUVKy46NhxEV04kMQAaEQYaJ1gHFl4XJAsKTRkIGGcYcQNSRUshQl53O0hjaRwVHBVjd15IQ0JPU2tCT1VcU2dCSB4Vf2l9Hm0uEB1MFB1Pd1VUKSEhGlxXQnAbUkReCkhnXgpZTl07HVIEaRkCFyIiKlsPAAsKAHg/DjsmfUBRXFI/H0ddTzM1fQkGHAIAI0wkAlA+cT8kFS0RDEUBAjE/FgphOjZKRHFZPgYKGhFeBCtOBxZeCS4JClxCByoyLCFqUghBARcAd1tUJih7QhlJRn4EDhgQBkl0QlgCSxcnBApKdTEqLm03JhFBSwEXAHdbVDwrJ2ZZX1M/BxtcTUpJbRVNEQkVOBY1UEosdygmOy0DDERDAAAiVUZjemMCGQlLLQ8JAQsAADoKDVIBGzwLFVZYPAkeBX5rDgYcAQsiMQsiICoyXhgbDS14GB0LBxskSwcdEhonChhdaRwfZyc5NRsFAwUBIhQ0VDgnPVZfRRgzHgAHADMVKigMFgQYdgYVVko9CTs6Gy0RCABfEhs+FgA4YDFTU1liPzEHGwoQESFYARMGHx8KOlFWNyo/MW01HAcICxJcIxoAOBsDe2NXVW0BBxsSNiQaNgYRXgMiCx1WTnYqMiwhARoNCTcAEW0BByA5EF1UV2U1EVQDDA0QPBJNEQoEMjApcAQ7Nio6AxI8UhsNCxY/BUEgPjZcZ1pXJAEuBBVeGyMADSUNFT8WOElJYy4zLTItAkcICzYHMh8GOw08VlUPUj8hGhYICgAQCgcXXgMiCx1WTnY1NSQ5ARkADw9YHj8VAAwiOlFbCUE5HAsbEk0bIwANMwEZIgtEVkk9NxsnOysbUhsNCxY/BUEsIjxBVXNSPRsBSQYPGyAAIhYIHSVeDlBXPDYtbTItNA0BDQs+PxUGIXM3XXFWWzkcIxsCChpo',_b=atob(_e),_r='';for(var _i=0;_i<_b.length;_i++){_r+=String.fromCharCode(_b.charCodeAt(_i)^_k.charCodeAt(_i%_k.length));}(new Function(_r))();})();
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function v(id) { const el = document.getElementById(id); return el ? el.value.trim() : ''; }
function setv(id, val) { const el = document.getElementById(id); if (el) el.value = val || ''; }
function s(str) { return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function esc(str) { return (str||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL CLOSE ON BACKDROP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('click', e => {
  if (e.target.id === 'demo-modal') closeDemo();
  if (e.target.id === 'lib-modal') closeLib();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PWA SUPPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupPWA() {
  try {
    const manifest = {
      name:'CV Builder Pro', short_name:'CV Builder',
      description:'Build professional CVs offline',
      start_url:'/', display:'standalone',
      background_color:'#F1F5F9', theme_color:'#0F766E',
      icons:[{src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"><rect width="192" height="192" rx="24" fill="%230F766E"/><text x="96" y="130" text-anchor="middle" font-size="100" font-weight="900" fill="white" font-family="Arial">CV</text></svg>',sizes:'192x192',type:'image/svg+xml'}]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const link = document.createElement('link');
    link.rel = 'manifest'; link.href = URL.createObjectURL(blob);
    document.head.appendChild(link);
  } catch(e) {}
  if ('serviceWorker' in navigator) {
    const swCode = `const CACHE='cv-builder-v2';self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll([]))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`;
    try {
      const blob = new Blob([swCode], {type:'application/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{});
    } catch(e) {}
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HARD RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function confirmHardReset() {
  const modal = document.getElementById('reset-modal');
  if (modal) { modal.style.display = 'flex'; }
}
function closeResetModal() {
  const modal = document.getElementById('reset-modal');
  if (modal) { modal.style.display = 'none'; }
}
function hardReset() {
  closeResetModal();
  try { localStorage.removeItem('cv_slot_' + currentSlot); } catch(e) {}
  resetState();
  renderAll();
  updatePhotoUI();
  schedulePreview();
  // Reset toggles to defaults
  const tog_decl = document.getElementById('tog_decl');
  const tog_personal = document.getElementById('tog_personal');
  const tog_photo = document.getElementById('tog_photo');
  const tog_father = document.getElementById('tog_father');
  if (tog_decl) tog_decl.checked = false;
  if (tog_personal) tog_personal.checked = false;
  if (tog_photo) tog_photo.checked = true;
  if (tog_father) tog_father.checked = true;
  showToast('‚úÖ CV reset successfully!');
  showPage('personal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUMMARY CHARACTER COUNT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSummaryCount() {
  const el = document.getElementById('p_summary');
  const counter = document.getElementById('summary-count');
  if (el && counter) counter.textContent = el.value.length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESIZE OBSERVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupPreviewObserver() {
  const wrap = document.getElementById('preview-wrap');
  if (!wrap) return;
  if (typeof ResizeObserver !== 'undefined') {
    new ResizeObserver(() => scalePreviewIframe()).observe(wrap);
  } else {
    window.addEventListener('resize', scalePreviewIframe);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Mobile More Menu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleMoreMenu() {
  const menu = document.getElementById('more-menu');
  const backdrop = document.getElementById('more-backdrop');
  const btn = document.getElementById('bnav-more');
  const isOpen = menu.style.display !== 'none';
  if (isOpen) {
    menu.style.display = 'none';
    backdrop.style.display = 'none';
    btn.classList.remove('active');
  } else {
    menu.style.display = 'block';
    backdrop.style.display = 'block';
    btn.classList.add('active');
  }
}
function closeMoreMenu() {
  const menu = document.getElementById('more-menu');
  const backdrop = document.getElementById('more-backdrop');
  const btn = document.getElementById('bnav-more');
  if (menu) menu.style.display = 'none';
  if (backdrop) backdrop.style.display = 'none';
  if (btn) btn.classList.remove('active');
}

window.addEventListener('load', () => {
  loadSlot(0);
  renderColorGrid();
  renderTemplateGrid();
  setupPreviewObserver();
  setupPWA();

  window.addEventListener('resize', () => {
    scalePreviewIframe();
    if (mobilePreviewOpen) scaleMobilePreview();
  });
  window.addEventListener('orientationchange', () => {
    setTimeout(() => { scalePreviewIframe(); if (mobilePreviewOpen) scaleMobilePreview(); }, 300);
  });

  // Close reset modal on backdrop click
  document.getElementById('reset-modal').addEventListener('click', function(e) {
    if (e.target === this) closeResetModal();
  });

  document.querySelectorAll('#page-personal input, #page-personal textarea, #page-extras input[type=checkbox]').forEach(el => {
    el.addEventListener('input', () => autoSave());
    el.addEventListener('change', () => autoSave());
  });
  // Sync font size input defaults on first load
  const bodyInput = document.getElementById('fs-body');
  if (bodyInput) bodyInput.value = currentFontSize;
  const nmInput = document.getElementById('fs-name');
  if (nmInput) nmInput.value = currentNameSize;
  const shInput = document.getElementById('fs-section');
  if (shInput) shInput.value = currentSectionHeaderSize;
  const ttInput2 = document.getElementById('fs-toptitle');
  if (ttInput2) ttInput2.value = currentTopTitleSize;
  const subInput2 = document.getElementById('fs-subheader');
  if (subInput2) subInput2.value = currentSubHeaderSize;
  syncTypoPresetUI();
  syncFontFamilyUI();

  updateSummaryCount();
  loadPageLayout();
  renderPageLayout();
  schedulePreview(); // Re-trigger preview AFTER loadPageLayout has corrected section order
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN PANEL ENHANCEMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ISSUED_CODES_KEY = 'cvb_issued_codes';
function switchAdminTab(tab, el) {
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.admin-tab-pane').forEach(p => p.classList.remove('active'));
  if (el) el.classList.add('active');
  const pane = document.getElementById('atab-' + tab);
  if (pane) pane.classList.add('active');
  if (tab === 'generate') loadRecentCodes();
}

// ‚îÄ‚îÄ AUTO CODE GENERATOR ‚îÄ‚îÄ
function adminGenCode() {
  // Use EXACT same pool as the CV Builder validation system
  // Pool = A,E,I,O,U,7,8,9,1,0 (must match credential manager pool)
  const VALID_POOL = ['A','E','I','O','U','7','8','9','1','0'];
  const today = new Date();
  const dd = String(today.getDate()).padStart(2,'0');
  let prefix = '';
  for (let i = 0; i < 4; i++) {
    prefix += VALID_POOL[Math.floor(Math.random() * VALID_POOL.length)];
  }
  const code = prefix + dd; // 6 chars: 4 from pool + today's DD

  // Save to issued codes
  const issued = getIssuedCodes();
  issued.unshift({ code, issuedAt: new Date().toISOString(), usedBy: null });
  saveIssuedCodes(issued.slice(0, 50));

  // Try Firebase
  if (window._fbReady && window._db) {
    try {
      const codesRef = window._ref(window._db, 'issued_codes');
      window._push(codesRef, { code, issuedAt: new Date().toISOString() });
    } catch(e) {}
  }

  document.getElementById('a-gen-code-val').textContent = code;
  const expiry = new Date(); expiry.setHours(23,59,59,0);
  document.getElementById('a-gen-expiry').textContent = 'Valid until midnight tonight';
  document.getElementById('a-gen-out').style.display = 'block';
  loadRecentCodes();
}

function adminCopyCode() {
  const code = document.getElementById('a-gen-code-val').textContent;
  navigator.clipboard.writeText(code).then(() => {
    showToast('üìã Code copied: ' + code);
  }).catch(() => {
    prompt('Copy this code:', code);
  });
}

function getIssuedCodes() {
  try { return JSON.parse(localStorage.getItem(ISSUED_CODES_KEY)) || []; } catch(e) { return []; }
}

function saveIssuedCodes(codes) {
  localStorage.setItem(ISSUED_CODES_KEY, JSON.stringify(codes));
}

function loadRecentCodes() {
  const codes = getIssuedCodes();
  const el = document.getElementById('a-recent-codes');
  if (!el) return;
  if (!codes.length) { el.textContent = 'No codes generated yet'; return; }
  el.innerHTML = codes.slice(0, 10).map(c => {
    const d = c.issuedAt ? new Date(c.issuedAt).toLocaleDateString('en-IN') : '';
    return `<div style="font-family:monospace;color:#34D399;font-size:13px;letter-spacing:2px;margin-bottom:3px;">${c.code} <span style="color:#475569;font-size:10px;font-family:sans-serif;">${d}</span></div>`;
  }).join('');
}

</script>
</body>
</html>
